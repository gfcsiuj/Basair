<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="مصحف الهادي - تطبيق قرآني متكامل مع التفسير والترجمة والاستماع للقراء المختلفين">
    <meta name="keywords" content="قرآن, مصحف, تفسير, ترجمة, تلاوة, إسلام, قرآن كريم, مصحف إلكتروني">
    <meta name="author" content="مصحف الهادي">
    <meta name="theme-color" content="#059669">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="مصحف الهادي">
    <meta name="application-name" content="مصحف الهادي">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <title>مصحف الهادي - القرآن الكريم</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23059669;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%2310b981;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' fill='url(%23grad)' rx='20'/%3E%3Ctext x='50' y='50' text-anchor='middle' dy='.3em' fill='white' font-size='45' font-family='Arial' font-weight='bold'%3E%D9%85%3C/text%3E%3C/svg%3E">
    
    <!-- Google Fonts - المزيد من الخطوط -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Rubik:wght@300;400;500;600;700;800&family=Scheherazade+New:wght@400;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Lateef:wght@400;700&family=Kitab:wght@400;700&family=Almarai:wght@300;400;700;800&family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS - Production Build -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'arabic': ['Amiri Quran', 'serif'],
                        'ui': ['Rubik', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Hammer.js for better gestures -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    
    <!-- Html2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* CSS Variables */
        :root {
            --primary: #059669;
            --primary-light: #10b981;
            --primary-dark: #047857;
            --secondary: #fbbf24;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --font-arabic: 'Amiri Quran', serif;
            --font-ui: 'Rubik', sans-serif;
            --font-indopak: 'Scheherazade New', serif;
            --font-noto: 'Noto Naskh Arabic', serif;
            --font-lateef: 'Lateef', serif;
            --font-kitab: 'Kitab', serif;
            --font-almarai: 'Almarai', sans-serif;
            --font-cairo: 'Cairo', sans-serif;
        }
        
        /* Dark Theme */
        [data-theme="dark"] {
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --border: #374151;
        }
        
        /* Sepia Theme */
        [data-theme="sepia"] {
            --primary: #92400e;
            --primary-light: #b45309;
            --primary-dark: #78350f;
            --bg-primary: #fef3c7;
            --bg-secondary: #fde68a;
            --bg-tertiary: #fcd34d;
            --text-primary: #451a03;
            --text-secondary: #78350f;
            --text-tertiary: #92400e;
            --border: #fbbf24;
        }
        
        /* Blue Theme */
        [data-theme="blue"] {
            --primary: #0369a1;
            --primary-light: #0284c7;
            --primary-dark: #075985;
            --bg-primary: #f0f9ff;
            --bg-secondary: #e0f2fe;
            --bg-tertiary: #bae6fd;
            --text-primary: #082f49;
            --text-secondary: #075985;
            --text-tertiary: #0c4a6e;
            --border: #7dd3fc;
        }
        
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            direction: rtl;
            text-align: right;
            height: 100vh;
            width: 100vw;
            position: fixed;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
            opacity: 0.5;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            opacity: 1;
        }
        
        /* Font Classes */
        .font-arabic {
            font-family: var(--font-arabic);
            line-height: 2.5;
        }
        
        .font-indopak {
            font-family: var(--font-indopak);
            line-height: 2.5;
        }
        
        .font-noto {
            font-family: var(--font-noto);
            line-height: 2.3;
        }
        
        .font-lateef {
            font-family: var(--font-lateef);
            line-height: 2.4;
        }
        
        .font-kitab {
            font-family: var(--font-kitab);
            line-height: 2.5;
        }
        
        .font-almarai {
            font-family: var(--font-almarai);
            line-height: 2.2;
        }
        
        .font-cairo {
            font-family: var(--font-cairo);
            line-height: 2.2;
        }
        
        /* Add these CSS animations after the existing keyframes for enhanced memorization experience */

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes scaleIn {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        @keyframes slideIn {
            0% { transform: translateX(-100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        
        .animate-scaleIn {
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .animate-slideIn {
            animation: slideIn 0.5s ease-out;
        }
        
        .animate-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200px 100%;
            animation: shimmer 2s infinite;
        }
        
        /* Enhanced speech feedback panel with purple theme */
        #speech-feedback {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, rgba(139, 69, 189, 0.15), rgba(168, 85, 247, 0.2));
            border: 2px solid rgba(139, 69, 189, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(139, 69, 189, 0.2);
        }
        
        .speech-feedback-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(139, 69, 189, 0.2);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(139, 69, 189, 0.3);
            transition: all 0.3s ease;
        }
        
        .speech-feedback-panel:hover {
            box-shadow: 0 15px 40px rgba(139, 69, 189, 0.4);
            transform: translateY(-2px);
        }
        
        /* Error item styling with improved purple theme */
        .error-item {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 5px solid #ef4444;
            background: linear-gradient(135deg, rgba(254, 242, 242, 0.9), rgba(254, 226, 226, 0.8));
            backdrop-filter: blur(5px);
            border-radius: 12px;
            margin: 8px 0;
            overflow: hidden;
            position: relative;
        }
        
        .error-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.5), transparent);
            animation: shimmerError 2s infinite;
        }
        
        .error-item:hover {
            transform: translateX(-6px) scale(1.02);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
            border-left-width: 6px;
        }
        
        @keyframes shimmerError {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .animate-slideUp { animation: slideUp 0.3s ease-out; }
        .animate-slideDown { animation: slideDown 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        
        /* Page Content */
        .page-content {
            padding: 1rem;
            max-width: 800px;
            margin: 0 auto;
            min-height: calc(100vh - 140px);
        }
        
        /* Desktop Styles - محسنة للكمبيوتر */
        @media (min-width: 1024px) {
            body {
                position: relative;
                overflow-y: auto;
            }
            
            .page-content {
                max-width: 1000px;
                padding: 2rem;
            }
            
            #page-content {
                font-size: 1.5rem !important;
            }
            
            .ai-window {
                max-width: 500px;
                height: 600px;
                bottom: 100px;
                left: 40px;
            }
            
            .ai-fab {
                bottom: 30px;
                left: 40px;
                width: 64px;
                height: 64px;
            }
            
            /* تحسين التنقل للكمبيوتر */
            #main-content {
                padding-bottom: 2rem;
            }
            
            .bottom-nav {
                position: sticky;
                bottom: 0;
            }
            
            /* أزرار التنقل بين الصفحات للكمبيوتر */
            .desktop-navigation {
                position: fixed;
                top: 50%;
                transform: translateY(-50%);
                z-index: 30;
            }
            
            .desktop-navigation.prev {
                right: 20px;
            }
            
            .desktop-navigation.next {
                left: 20px;
            }
            
            .desktop-navigation button {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: var(--primary);
                color: white;
                border: none;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: var(--shadow-lg);
            }
            
            .desktop-navigation button:hover {
                transform: scale(1.1);
                background: var(--primary-dark);
            }
        }

        /* Mobile AI Full Screen */
        @media (max-width: 768px) {
            .ai-window.active {
                position: fixed;
                inset: 0;
                max-width: 100%;
                width: 100%;
                height: 100%;
                bottom: 0;
                left: 0;
                right: 0;
                border-radius: 0;
                z-index: 100;
            }
        }
        
        /* Surah Header */
        .surah-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-md);
        }
        
        .surah-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-family: var(--font-arabic);
        }
        
        .surah-header .basmala {
            font-size: 1.2rem;
            font-family: var(--font-arabic);
            opacity: 0.95;
        }
        
        .ayah {
            display: inline;
            cursor: pointer;
            padding: 0 4px;
            transition: all 0.2s;
            position: relative;
        }
        
        .ayah:hover {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), rgba(16, 185, 129, 0.1));
            border-radius: var(--radius-sm);
        }
        
        .ayah.playing {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            border-radius: var(--radius-sm);
            animation: pulse 2s infinite;
        }
        
        .ayah.bookmarked::before {
            content: '🔖';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 12px;
        }
        
        /* وضع التحفيظ المحسن - مخفي بالكامل مع تدرج أرجواني */
        .memorization-mode .ayah-word {
            display: inline-block;
            margin: 0 3px;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 2.2em;
            position: relative;
            font-weight: 500;
            cursor: default;
            /* Hide all words initially */
            color: transparent;
            background: transparent;
            border: 1px dashed rgba(139, 69, 189, 0.3);
        }
        
        /* Show verse numbers always */
        .memorization-mode .verse-number {
            display: inline-flex !important;
            color: white !important;
            background: linear-gradient(135deg, var(--primary), var(--primary-light)) !important;
        }
        
        /* Hide AI chat in memorization mode */
        .memorization-mode .ai-fab,
        .memorization-mode .ai-window,
        #memorization-interface .ai-fab,
        #memorization-interface .ai-window {
            display: none !important;
        }
        
        .memorization-mode .ayah-word.hidden {
            /* Words are completely hidden until spoken correctly */
            visibility: hidden;
            color: transparent;
            background: transparent;
            user-select: none;
            cursor: default;
            border: none;
        }
        
        .memorization-mode .ayah-word.waiting {
            /* Current word waiting to be spoken - minimal animation for indication */
            visibility: visible;
            background: linear-gradient(135deg, rgba(139, 69, 189, 0.3), rgba(168, 85, 247, 0.4));
            color: transparent;
            border: 2px solid rgba(139, 69, 189, 0.7);
            position: relative;
            animation: pulseWaitingMinimal 3s infinite;
            box-shadow: 0 0 10px rgba(139, 69, 189, 0.3);
        }
        
        .memorization-mode .ayah-word.waiting::after {
            content: '🎤';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.4em;
            animation: pulseIcon 1.8s infinite;
            filter: drop-shadow(0 2px 4px rgba(139, 69, 189, 0.5));
        }
        
        .memorization-mode .ayah-word.revealed {
            /* Words become visible when spoken correctly - no animations out of respect */
            visibility: visible;
            background: linear-gradient(135deg, rgba(139, 69, 189, 0.4), rgba(168, 85, 247, 0.5));
            color: var(--text-primary);
            border: 2px solid rgba(139, 69, 189, 0.8);
            box-shadow: 0 4px 15px rgba(139, 69, 189, 0.4);
            opacity: 1;
            transform: scale(1);
        }
        
        .memorization-mode .ayah-word.correct {
            /* Word spoken correctly - no animations out of respect */
            visibility: visible;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(21, 128, 61, 0.6));
            color: var(--text-primary);
            border: 2px solid rgba(34, 197, 94, 0.8);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
        }
        
        .memorization-mode .ayah-word.incorrect {
            /* Incorrect word - simple styling without animations */
            visibility: visible;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.5), rgba(220, 38, 38, 0.6));
            color: var(--text-primary);
            border: 2px solid rgba(239, 68, 68, 0.9);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
        }
        
        @keyframes pulseWaitingMinimal {
            0% { 
                transform: scale(1); 
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.02); 
                opacity: 1;
            }
            100% { 
                transform: scale(1); 
                opacity: 0.8;
            }
        }
        
        @keyframes pulseWaiting {
            0% { 
                transform: scale(1); 
                box-shadow: 0 0 0 0 rgba(139, 69, 189, 0.8), 0 0 10px rgba(139, 69, 189, 0.3); 
            }
            50% { 
                transform: scale(1.03); 
                box-shadow: 0 0 0 6px rgba(139, 69, 189, 0.2), 0 0 15px rgba(139, 69, 189, 0.4); 
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 0 0 12px rgba(139, 69, 189, 0), 0 0 10px rgba(139, 69, 189, 0.3); 
            }
        }
        
        @keyframes pulseIcon {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes revealWord {
            0% { 
                background: linear-gradient(135deg, rgba(139, 69, 189, 0.8), rgba(168, 85, 247, 0.9)); 
                transform: scale(0.8) rotateY(90deg); 
                opacity: 0;
                filter: blur(3px);
            }
            30% {
                transform: scale(1.1) rotateY(45deg);
                opacity: 0.6;
                filter: blur(1px);
            }
            70% {
                transform: scale(1.05) rotateY(10deg);
                opacity: 0.9;
                filter: blur(0px);
            }
            100% { 
                background: linear-gradient(135deg, rgba(139, 69, 189, 0.4), rgba(168, 85, 247, 0.5)); 
                transform: scale(1) rotateY(0deg); 
                opacity: 1;
                filter: blur(0px);
            }
        }
        
        @keyframes correctWord {
            0% { 
                background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(21, 128, 61, 1)); 
                transform: scale(1.5) rotateZ(8deg); 
                box-shadow: 0 10px 30px rgba(34, 197, 94, 0.7);
                filter: brightness(1.3);
            }
            20% {
                transform: scale(1.3) rotateZ(-4deg);
                filter: brightness(1.2);
            }
            40% {
                transform: scale(1.15) rotateZ(2deg);
                filter: brightness(1.1);
            }
            70% {
                transform: scale(1.05) rotateZ(-1deg);
                filter: brightness(1.05);
            }
            100% { 
                background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(21, 128, 61, 0.6)); 
                transform: scale(1) rotateZ(0deg); 
                box-shadow: 0 6px 20px rgba(34, 197, 94, 0.5);
                filter: brightness(1);
            }
        }
        
        @keyframes incorrectWord {
            0% { 
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 1)); 
                transform: translateX(-10px) scale(1.3); 
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.7);
                filter: brightness(1.2) contrast(1.1);
            }
            10% { transform: translateX(10px) scale(1.2); }
            20% { transform: translateX(-8px) scale(1.15); }
            30% { transform: translateX(8px) scale(1.1); }
            40% { transform: translateX(-6px) scale(1.08); }
            50% { transform: translateX(6px) scale(1.05); }
            60% { transform: translateX(-4px) scale(1.03); }
            70% { transform: translateX(4px) scale(1.02); }
            80% { transform: translateX(-2px) scale(1.01); }
            90% { transform: translateX(2px) scale(1); }
            100% { 
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.5), rgba(220, 38, 38, 0.6)); 
                transform: translateX(0) scale(1); 
                box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
                filter: brightness(1) contrast(1);
            }
        }
        
        .memorization-controls {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            z-index: 40;
            display: none;
        }
        
        .memorization-mode .memorization-controls {
            display: block;
        }
        
        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-md);
            color: #ef4444;
        }
        
        .recording-indicator.active {
            animation: pulse 1.5s infinite;
        }
        
        .verse-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.75rem;
            height: 1.75rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: 600;
            margin: 0 0.25rem;
            vertical-align: middle;
            box-shadow: var(--shadow-sm);
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            color: var(--text-secondary);
            transition: all 0.2s;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--primary);
            border-radius: 0 0 4px 4px;
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        /* Panels */
        .panel {
            position: fixed;
            inset: 0;
            z-index: 50;
            background: var(--bg-primary);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .panel.visible {
            transform: translateY(0);
        }
        
        .panel-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-md);
        }
        
        /* Menu Panel */
        #menu-panel {
            background: var(--bg-primary);
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .menu-item:hover {
            background: var(--bg-secondary);
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
            color: var(--primary);
        }
        
        /* AI Chat */
        .ai-fab {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.3s;
            z-index: 40;
        }
        
        .ai-fab:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }
        
        .ai-fab:active {
            transform: scale(0.95);
        }
        
        .ai-window {
            position: fixed;
            bottom: 150px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            height: 500px;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            display: none;
            flex-direction: column;
            z-index: 45;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        @media (min-width: 768px) {
            .ai-window {
                right: auto;
                width: 400px;
            }
        }
        
        .ai-window.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
            gap: 0.5rem;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Context Menu */
        .context-menu {
            background: var(--bg-primary);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            box-shadow: 0 -10px 25px -5px rgb(0 0 0 / 0.1);
            border: 1px solid var(--border);
            border-bottom: none;
        }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* Input */
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
            outline: none;
        }
        
        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }
        
        /* Select */
        .select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
        }
        
        /* Checkbox */
        .checkbox {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            appearance: none;
            transition: all 0.2s;
            position: relative;
        }
        
        .checkbox:checked {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
        }
        
        /* Swipe Indicators */
        .swipe-hint {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 30;
        }
        
        .swipe-hint.show {
            opacity: 0.8;
        }
        
        .swipe-hint.left {
            left: 10px;
        }
        
        .swipe-hint.right {
            right: 10px;
        }
        
        /* Progress Ring */
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            stroke: var(--primary);
            stroke-width: 4;
            fill: none;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        /* Stats Card */
        .stats-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }
        
        /* Achievement Badge */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            box-shadow: var(--shadow);
        }
        
        .achievement-badge.unlocked {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-line {
            height: 20px;
            margin-bottom: 10px;
            border-radius: var(--radius-sm);
        }
        
        .skeleton-line.short {
            width: 60%;
        }
        
        /* Share Image Preview */
        #share-image-preview {
            background: var(--bg-primary);
            padding: 3rem;
            border-radius: var(--radius-lg);
            text-align: center;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            position: relative;
        }

        #share-image-preview .watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            opacity: 0.5;
            font-size: 0.75rem;
        }
        
        /* Swipe Hints */
        .swipe-hint {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 1rem;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 30;
            pointer-events: none;
        }
        
        .swipe-hint.left {
            left: 20px;
        }
        
        .swipe-hint.right {
            right: 20px;
        }
        
        .swipe-hint.show {
            opacity: 1;
        }
        
        /* Khatmah Card */
        .khatmah-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        
        .khatmah-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .khatmah-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-xl);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .khatmah-status.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary);
        }
        
        .khatmah-status.completed {
            background: rgba(251, 191, 36, 0.1);
            color: #f59e0b;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            padding: 1rem;
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease-out;
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
    </style>
</head>
<body data-theme="light">
    
    <!-- Main App Container -->
    <div class="flex flex-col h-screen w-screen">
        
        <!-- Main Reading Interface -->
        <div id="main-reading-interface">
            <!-- Top Header -->
            <header class="bg-gradient-to-l from-emerald-600 to-emerald-700 text-white shadow-md z-40">
                <div class="flex items-center justify-between px-4 py-3">
                    <div class="flex items-center gap-3">
                        <button id="menu-btn" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i class="fas fa-bars text-lg"></i>
                        </button>
                        <div>
                            <h1 class="text-sm font-bold" id="page-surah-name">جاري التحميل...</h1>
                            <p class="text-xs opacity-90" id="page-info">
                                <span id="page-juz"></span> • <span id="page-number"></span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- Audio Controls -->
                        <button id="audio-prev-btn" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i class="fas fa-backward text-sm"></i>
                        </button>
                        <button id="audio-play-btn" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i id="play-icon" class="fas fa-play text-lg"></i>
                            <i id="pause-icon" class="fas fa-pause text-lg hidden"></i>
                        </button>
                        <button id="audio-next-btn" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i class="fas fa-forward text-sm"></i>
                        </button>
                        
                        <!-- Progress Bar -->
                        <div id="audio-progress-bar" class="w-24 h-1 bg-white/30 rounded-full cursor-pointer hidden sm:block">
                            <div id="audio-progress" class="h-full bg-white rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        
                        <!-- Search -->
                        <button id="search-btn" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i class="fas fa-search text-lg"></i>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <main id="main-content" class="flex-1 overflow-y-auto custom-scrollbar relative">
                <!-- Page Content -->
                <div id="page-wrapper" class="page-content">
                    <!-- Loading skeleton -->
                    <div id="skeleton-loading" class="hidden p-4">
                        <div class="skeleton skeleton-line"></div>
                        <div class="skeleton skeleton-line"></div>
                        <div class="skeleton skeleton-line short"></div>
                        <div class="skeleton skeleton-line"></div>
                        <div class="skeleton skeleton-line short"></div>
                    </div>
                    
                    <!-- Verses content -->
                    <div id="page-content" class="font-arabic text-xl leading-loose"></div>
                    
                    <!-- Swipe hints -->
                    <div class="swipe-hint left">
                        <i class="fas fa-arrow-left"></i>
                        <span>اسحب للصفحة التالية</span>
                    </div>
                    <div class="swipe-hint right">
                        <i class="fas fa-arrow-right"></i>
                        <span>اسحب للصفحة السابقة</span>
                    </div>
                </div>
            </main>
            
            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <div class="grid grid-cols-5 max-w-lg mx-auto">
                    <button class="nav-item active" data-panel="home">
                        <i class="fas fa-book-quran text-xl mb-1"></i>
                        <span class="text-xs">المصحف</span>
                    </button>
                    <button class="nav-item" onclick="App.startMemorizationMode('page')">
                        <i class="fas fa-brain text-xl mb-1"></i>
                        <span class="text-xs">الحفظ</span>
                    </button>
                    <button class="nav-item" data-panel="index-panel">
                        <i class="fas fa-list text-xl mb-1"></i>
                        <span class="text-xs">الفهرس</span>
                    </button>
                    <button class="nav-item" data-panel="bookmarks-panel">
                        <i class="fas fa-bookmark text-xl mb-1"></i>
                        <span class="text-xs">المفضلة</span>
                    </button>
                    <button class="nav-item" data-panel="khatmah-panel">
                        <i class="fas fa-chart-line text-xl mb-1"></i>
                        <span class="text-xs">الختمة</span>
                    </button>
                    <button class="nav-item" data-panel="settings-panel">
                        <i class="fas fa-cog text-xl mb-1"></i>
                        <span class="text-xs">الإعدادات</span>
                    </button>
                </div>
            </nav>
        </div>
        
        <!-- Separate Memorization Interface -->
        <div id="memorization-interface" class="hidden">
            <!-- Memorization Header -->
            <header class="bg-gradient-to-l from-purple-600 to-purple-700 text-white shadow-md z-40">
                <div class="flex items-center justify-between px-4 py-3">
                    <div class="flex items-center gap-3">
                        <button id="back-to-main" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div>
                            <h1 class="text-sm font-bold">وضع التحفيظ</h1>
                            <p class="text-xs opacity-90" id="memorization-info">
                                <span id="memorization-surah-name"></span> • <span id="memorization-range"></span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <!-- Memorization Controls -->
                        <button id="memorization-show-verse-header" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="إظهار الآية">
                            <i class="fas fa-eye text-lg"></i>
                        </button>
                        <button id="memorization-hint-header" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="تلميح">
                            <i class="fas fa-lightbulb text-lg"></i>
                        </button>
                        <button id="memorization-play-audio-header" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="تشغيل الصوت">
                            <i class="fas fa-play text-lg"></i>
                        </button>
                        <button id="memorization-settings" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="إعدادات الحفظ">
                            <i class="fas fa-cog text-lg"></i>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Memorization Content -->
            <main id="memorization-content" class="flex-1 overflow-y-auto custom-scrollbar relative bg-gradient-to-br from-purple-50 via-indigo-50 to-purple-100 dark:from-purple-900/20 dark:via-indigo-900/15 dark:to-purple-800/20">
                
                <!-- Memorization Page Content -->
                <div id="memorization-page-wrapper" class="page-content pt-4">
                    <div id="memorization-page-content" class="font-arabic text-2xl leading-loose text-center py-8"></div>
                </div>
                
                <!-- Errors Panel - Simple error count indicator -->
                <div class="fixed top-20 right-4 z-30">
                    <div id="memorization-errors-indicator" class="bg-red-500 text-white rounded-full px-3 py-1 text-sm font-bold hidden">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <span id="memorization-errors-count">0</span>
                    </div>
                </div>
                
                <!-- Floating Progress Ring -->
                <div class="fixed top-20 left-4 z-30">
                    <div class="relative w-16 h-16">
                        <svg class="progress-ring w-16 h-16">
                            <circle class="progress-ring-circle" stroke="#e5e7eb" stroke-width="3" fill="transparent" r="26" cx="32" cy="32"/>
                            <circle id="memorization-progress-ring" class="progress-ring-circle" stroke="#8b5cf6" stroke-width="3" fill="transparent" r="26" cx="32" cy="32"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="memorization-progress-percent" class="text-sm font-bold text-purple-600">0%</span>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Simplified Memorization Footer -->
            <footer class="bg-gradient-to-r from-purple-700 via-purple-600 to-indigo-700 text-white p-4">
                <!-- Essential Control Buttons Only -->
                <div class="flex items-center justify-center gap-3 mb-3">
                    <button id="memorization-hint-footer" class="btn bg-yellow-500 hover:bg-yellow-600 text-white border-0 text-sm px-3 py-2 rounded-lg flex items-center gap-1">
                        <i class="fas fa-lightbulb"></i>
                        <span>تلميح</span>
                    </button>
                    <button id="memorization-skip-word-footer" class="btn bg-orange-500 hover:bg-orange-600 text-white border-0 text-sm px-3 py-2 rounded-lg flex items-center gap-1">
                        <i class="fas fa-forward"></i>
                        <span>تخطي</span>
                    </button>
                    <button id="memorization-reset-footer" class="btn bg-blue-500 hover:bg-blue-600 text-white border-0 text-sm px-3 py-2 rounded-lg flex items-center gap-1">
                        <i class="fas fa-redo"></i>
                        <span>إعادة</span>
                    </button>
                    <button id="stop-memorization" class="btn bg-red-500 hover:bg-red-600 text-white border-0 px-4 py-2 rounded-lg flex items-center gap-1">
                        <i class="fas fa-stop"></i>
                        <span>إيقاف</span>
                    </button>
                </div>
                
                <!-- Minimal Progress Info -->
                <div class="text-center text-sm">
                    <!-- Speech Interim Feedback -->
                    <div id="speech-interim-feedback" class="text-xs text-yellow-200 opacity-50 mb-2 min-h-4"></div>
                    
                    <div class="mb-2 flex items-center justify-between">
                        <span>التقدم: <span id="memorization-progress-text" class="font-bold">٠</span> من <span id="memorization-total-text" class="font-bold">٠</span> كلمة</span>
                        <span>الأخطاء: <span id="memorization-errors-count" class="font-bold text-red-300">٠</span></span>
                    </div>
                    <div class="w-full h-2 bg-white/20 rounded-full">
                        <div id="memorization-progress-bar-footer" class="h-full bg-gradient-to-r from-yellow-300 to-green-400 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </footer>
        </div>
        
    </div>
    
    <!-- AI Assistant FAB -->
    <button class="ai-fab">
        <i class="fas fa-robot text-2xl"></i>
    </button>
    
    <!-- AI Chat Window -->
    <div class="ai-window">
        <div class="panel-header rounded-t-2xl">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h3 class="font-bold">عبد الحكيم</h3>
                    <p class="text-xs opacity-90">مساعدك الذكي</p>
                </div>
            </div>
            <button id="close-ai" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="ai-messages" class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div class="flex gap-3 mb-4">
                <div class="w-8 h-8 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-xs"></i>
                </div>
                <div class="bg-gradient-to-l from-emerald-50 to-emerald-100 dark:from-emerald-900/20 dark:to-emerald-800/20 p-3 rounded-2xl rounded-tr-sm max-w-[80%]">
                    <p class="text-sm">السلام عليكم! أنا عبد الحكيم، كيف يمكنني مساعدتك في رحلتك مع القرآن الكريم؟</p>
                </div>
            </div>
        </div>
        
        <div id="ai-suggestions" class="px-4 py-2 flex gap-2 overflow-x-auto custom-scrollbar border-t" style="border-color: var(--border)">
            <!-- Suggestions will be added dynamically -->
        </div>
        
        <div class="p-4 border-t" style="border-color: var(--border)">
            <div class="flex gap-2">
                <input id="ai-input" type="text" class="input flex-1" placeholder="اسأل عبد الحكيم...">
                <button id="ai-send" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Menu Panel -->
    <div id="menu-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">القائمة الرئيسية</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto">
            <div class="menu-item" onclick="App.startMemorizationMode('page')">
                <i class="fas fa-brain"></i>
                <div>
                    <h4 class="font-bold">وضع التحفيظ</h4>
                    <p class="text-xs" style="color: var(--text-secondary)">احفظ القرآن بالتعرف على الصوت</p>
                </div>
            </div>
            <div class="menu-item" onclick="App.openPanel('reading-modes-panel')">
                <i class="fas fa-book-open"></i>
                <div>
                    <h4 class="font-bold">أوضاع القراءة</h4>
                    <p class="text-xs" style="color: var(--text-secondary)">قراءة، حفظ، مراجعة</p>
                </div>
            </div>
            <div class="menu-item" onclick="App.openPanel('statistics-panel')">
                <i class="fas fa-chart-bar"></i>
                <div>
                    <h4 class="font-bold">الإحصائيات</h4>
                    <p class="text-xs" style="color: var(--text-secondary)">تابع تقدمك في القراءة</p>
                </div>
            </div>
            <div class="menu-item" onclick="App.openPanel('duas-panel')">
                <i class="fas fa-hands-praying"></i>
                <div>
                    <h4 class="font-bold">الأدعية</h4>
                    <p class="text-xs" style="color: var(--text-secondary)">أدعية من القرآن والسنة</p>
                </div>
            </div>
            <div class="menu-item" onclick="App.openPanel('tasbih-panel')">
                <i class="fas fa-circle-notch"></i>
                <div>
                    <h4 class="font-bold">التسبيح</h4>
                    <p class="text-xs" style="color: var(--text-secondary)">عداد التسبيح الإلكتروني</p>
                </div>
            </div>
            <div class="menu-item" onclick="App.openPanel('notes-panel')">
                <i class="fas fa-sticky-note"></i>
                <div>
                    <h4 class="font-bold">الملاحظات</h4>
                    <p class="text-xs" style="color: var(--text-secondary)">دون ملاحظاتك وتأملاتك</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ayah Context Menu -->
    <div id="ayah-menu" class="fixed bottom-0 left-0 right-0 context-menu transform translate-y-full transition-transform z-50 hidden">
        <div class="p-4">
            <div class="mb-4">
                <p id="selected-ayah" class="font-arabic text-lg mb-2"></p>
                <p id="selected-info" class="text-sm" style="color: var(--text-secondary)"></p>
            </div>
            
            <div class="grid grid-cols-3 gap-3">
                <button id="ayah-play" class="card text-center py-3">
                    <i class="fas fa-play-circle text-2xl mb-2" style="color: var(--primary)"></i>
                    <span class="text-xs">استماع</span>
                </button>
                <button id="ayah-tafsir" class="card text-center py-3">
                    <i class="fas fa-book-open text-2xl mb-2" style="color: var(--primary)"></i>
                    <span class="text-xs">التفسير</span>
                </button>
                <button id="ayah-bookmark" class="card text-center py-3">
                    <i class="fas fa-bookmark text-2xl mb-2" style="color: var(--primary)"></i>
                    <span class="text-xs">حفظ</span>
                </button>
                <button id="ayah-share" class="card text-center py-3">
                    <i class="fas fa-share-alt text-2xl mb-2" style="color: var(--primary)"></i>
                    <span class="text-xs">مشاركة</span>
                </button>
                <button id="ayah-copy" class="card text-center py-3">
                    <i class="fas fa-copy text-2xl mb-2" style="color: var(--primary)"></i>
                    <span class="text-xs">نسخ</span>
                </button>
                <button id="ayah-ai" class="card text-center py-3">
                    <i class="fas fa-robot text-2xl mb-2" style="color: var(--primary)"></i>
                    <span class="text-xs">اسأل</span>
                </button>
            </div>
        </div>
    </div>
    <div id="ayah-menu-backdrop" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-45 hidden"></div>
    
    <!-- Share Options Modal -->
    <div id="share-options-modal" class="modal">
        <div class="modal-content p-6">
            <h3 class="text-xl font-bold mb-4">مشاركة الآية</h3>
            <div class="space-y-3">
                <button id="share-as-text" class="btn btn-primary w-full">
                    <i class="fas fa-file-alt"></i>
                    مشاركة كنص
                </button>
                <button id="share-as-image-btn" class="btn btn-primary w-full">
                    <i class="fas fa-image"></i>
                    مشاركة كصورة
                </button>
            </div>
            <button id="close-share-modal" class="btn btn-secondary w-full mt-4">
                إلغاء
            </button>
        </div>
    </div>
    
    <!-- Share as Image Panel -->
    <div id="share-image-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">مشاركة كصورة</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4">
            <!-- Image Preview -->
            <div id="share-image-preview" class="mb-4">
                <p id="share-text" class="font-arabic text-2xl mb-4"></p>
                <p id="share-info" class="text-sm mb-4"></p>
                <p class="watermark">مصحف الهادي</p>
            </div>
            
            <!-- Customization Options -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">حجم الخط</label>
                    <input type="range" id="share-font-size" min="16" max="40" value="24" class="w-full">
                    <div class="flex justify-between text-xs mt-1" style="color: var(--text-secondary)">
                        <span>صغير</span>
                        <span id="share-font-size-value">24px</span>
                        <span>كبير</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">لون الخلفية</label>
                    <div class="grid grid-cols-6 gap-2">
                        <button class="share-bg-color w-10 h-10 rounded-lg border-2" style="background: #ffffff" data-color="#ffffff"></button>
                        <button class="share-bg-color w-10 h-10 rounded-lg border-2" style="background: #f3f4f6" data-color="#f3f4f6"></button>
                        <button class="share-bg-color w-10 h-10 rounded-lg border-2" style="background: #fef3c7" data-color="#fef3c7"></button>
                        <button class="share-bg-color w-10 h-10 rounded-lg border-2" style="background: #dcfce7" data-color="#dcfce7"></button>
                        <button class="share-bg-color w-10 h-10 rounded-lg border-2" style="background: #e0e7ff" data-color="#e0e7ff"></button>
                        <button class="share-bg-color w-10 h-10 rounded-lg border-2" style="background: #1f2937" data-color="#1f2937"></button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">لون النص</label>
                    <div class="grid grid-cols-6 gap-2">
                        <button class="share-text-color w-10 h-10 rounded-lg border-2" style="background: #111827" data-color="#111827"></button>
                        <button class="share-text-color w-10 h-10 rounded-lg border-2" style="background: #059669" data-color="#059669"></button>
                        <button class="share-text-color w-10 h-10 rounded-lg border-2" style="background: #0369a1" data-color="#0369a1"></button>
                        <button class="share-text-color w-10 h-10 rounded-lg border-2" style="background: #92400e" data-color="#92400e"></button>
                        <button class="share-text-color w-10 h-10 rounded-lg border-2" style="background: #7c3aed" data-color="#7c3aed"></button>
                        <button class="share-text-color w-10 h-10 rounded-lg border-2" style="background: #ffffff" data-color="#ffffff"></button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm mb-2">نوع الخط</label>
                    <select id="share-font-type" class="input">
                        <option value="Amiri Quran">عثماني</option>
                        <option value="Scheherazade New">هندي باكستاني</option>
                        <option value="Noto Naskh Arabic">نسخ</option>
                        <option value="Lateef">لطيف</option>
                        <option value="Kitab">كتاب</option>
                        <option value="Almarai">المراعي</option>
                        <option value="Cairo">القاهرة</option>
                    </select>
                </div>
                
                <div class="flex gap-2">
                    <button id="generate-share-image" class="btn btn-primary flex-1">
                        <i class="fas fa-share"></i>
                        مشاركة
                    </button>
                    <button id="download-share-image" class="btn btn-secondary flex-1">
                        <i class="fas fa-download"></i>
                        تحميل
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Memorization Panel -->
    <div id="memorization-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">وضع التحفيظ</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
            
            <!-- Memorization Mode Selection -->
            <div class="card mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-brain" style="color: var(--primary)"></i>
                    اختر نوع الحفظ
                </h3>
                <div class="space-y-3">
                    <button id="start-verse-memorization" class="btn btn-primary w-full">
                        <i class="fas fa-microphone"></i>
                        حفظ الآية الحالية
                    </button>
                    <button id="start-page-memorization" class="btn btn-secondary w-full">
                        <i class="fas fa-file-alt"></i>
                        حفظ الصفحة الحالية
                    </button>
                    <button id="start-surah-memorization" class="btn btn-secondary w-full">
                        <i class="fas fa-book"></i>
                        حفظ سورة مختارة
                    </button>
                </div>
            </div>
            
            <!-- Custom Range Selection -->
            <div class="card mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-sliders-h" style="color: var(--primary)"></i>
                    تحديد نطاق مخصص
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm mb-1">من سورة</label>
                            <select id="memorization-from-surah" class="input text-sm">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">مة آية</label>
                            <input type="number" id="memorization-from-ayah" class="input text-sm" min="1" value="1">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm mb-1">إلى سورة</label>
                            <select id="memorization-to-surah" class="input text-sm">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-1">إلى آية</label>
                            <input type="number" id="memorization-to-ayah" class="input text-sm" min="1" value="1">
                        </div>
                    </div>
                    <button id="start-custom-memorization" class="btn btn-primary w-full">
                        <i class="fas fa-play"></i>
                        بدء الحفظ المخصص
                    </button>
                </div>
            </div>
            
            <!-- Memorization Settings -->
            <div class="card mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-cog" style="color: var(--primary)"></i>
                    إعدادات الحفظ
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="text-sm">التنبيه عند الخطأ</label>
                        <input type="checkbox" id="memorization-sound-alerts" class="checkbox" checked>
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm">إظهار التشكيل</label>
                        <input type="checkbox" id="memorization-show-tashkeel" class="checkbox" checked>
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-sm">التكرار عند الخطأ</label>
                        <input type="checkbox" id="memorization-auto-repeat" class="checkbox" checked>
                    </div>
                    <div>
                        <label class="block text-sm mb-1">حساسية التعرف على الصوت</label>
                        <input type="range" id="memorization-sensitivity" min="0.5" max="1" step="0.1" value="0.8" class="w-full">
                        <div class="flex justify-between text-xs mt-1" style="color: var(--text-secondary)">
                            <span>منخفض</span>
                            <span id="memorization-sensitivity-value">80%</span>
                            <span>عالي</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Memorization Statistics -->
            <div class="card">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-chart-bar" style="color: var(--primary)"></i>
                    إحصائيات الحفظ
                </h3>
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div>
                        <p class="text-lg font-bold" style="color: var(--primary)" id="memorization-total-words">0</p>
                        <p class="text-xs" style="color: var(--text-secondary)">إجمالي الكلمات</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold" style="color: var(--secondary)" id="memorization-correct-words">0</p>
                        <p class="text-xs" style="color: var(--text-secondary)">كلمات صحيحة</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold text-red-500" id="memorization-incorrect-words">0</p>
                        <p class="text-xs" style="color: var(--text-secondary)">كلمات خاطئة</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold" style="color: var(--primary)" id="memorization-accuracy">0%</p>
                        <p class="text-xs" style="color: var(--text-secondary)">دقة الحفظ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panels -->
    
    <!-- Index Panel -->
    <div id="index-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">فهرس السور</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="relative">
                <input id="surah-search" type="text" class="input pr-10" placeholder="ابحث عن سورة...">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--text-tertiary)"></i>
            </div>
        </div>
        <div id="surah-list" class="flex-1 overflow-y-auto custom-scrollbar px-4 pb-4">
            <!-- Surahs will be loaded dynamically -->
        </div>
    </div>
    
    <!-- Panels -->

    <!-- Index Panel -->
    <div id="index-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">فهرس القرآن</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>
    
    <!-- Search Panel -->
    <div id="search-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">البحث في القرآن</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="relative">
                <input id="search-input" type="text" class="input pr-10" placeholder="ابحث في القرآن...">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--text-tertiary)"></i>
            </div>
        </div>
        <div id="search-results" class="flex-1 overflow-y-auto custom-scrollbar px-4 pb-4">
            <!-- Search results will appear here -->
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div id="settings-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">الإعدادات</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
            
            <!-- Theme Selection -->
            <div class="card mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-palette" style="color: var(--primary)"></i>
                    المظهر
                </h3>
                <div class="grid grid-cols-2 gap-3">
                    <button class="theme-option p-3 rounded-lg border-2 transition-all text-center" data-theme="light" style="border-color: var(--border)">
                        <i class="fas fa-sun text-yellow-500 mb-2"></i>
                        <p class="text-sm">فاتح</p>
                    </button>
                    <button class="theme-option p-3 rounded-lg border-2 transition-all text-center" data-theme="dark" style="border-color: var(--border)">
                        <i class="fas fa-moon text-blue-500 mb-2"></i>
                        <p class="text-sm">داكن</p>
                    </button>
                    <button class="theme-option p-3 rounded-lg border-2 transition-all text-center" data-theme="sepia" style="border-color: var(--border)">
                        <i class="fas fa-coffee text-amber-600 mb-2"></i>
                        <p class="text-sm">سيبيا</p>
                    </button>
                    <button class="theme-option p-3 rounded-lg border-2 transition-all text-center" data-theme="blue" style="border-color: var(--border)">
                        <i class="fas fa-water text-blue-600 mb-2"></i>
                        <p class="text-sm">أزرق</p>
                    </button>
                </div>
            </div>
            
            <!-- Reading Settings -->
            <div class="card mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-book-reader" style="color: var(--primary)"></i>
                    إعدادات القراءة
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm mb-2">حجم الخط</label>
                        <input type="range" id="font-size" min="14" max="30" value="20" class="w-full">
                        <div class="flex justify-between text-xs mt-1" style="color: var(--text-secondary)">
                            <span>صغير</span>
                            <span id="font-size-value">20px</span>
                            <span>كبير</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">نوع الخط</label>
                        <select id="font-type" class="input">
                            <option value="font-arabic">عثماني</option>
                            <option value="font-indopak">هندي باكستاني</option>
                            <option value="font-noto">نسخ</option>
                            <option value="font-lateef">لطيف</option>
                            <option value="font-kitab">كتاب</option>
                            <option value="font-almarai">المراعي</option>
                            <option value="font-cairo">القاهرة</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">القارئ</label>
                        <select id="reciter-select" class="input">
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">التفسير</label>
                        <select id="tafsir-select" class="input">
                            <option value="169">التفسير الميسر</option>
                            <option value="164">تفسير السعدي</option>
                            <option value="163">تفسير البغوي</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">الترجمة</label>
                        <select id="translation-select" class="input">
                            <option value="131">Dr. Mustafa Khattab</option>
                            <option value="20">Sahih International</option>
                            <option value="85">Abdul Haleem</option>
                        </select>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Bookmarks Panel -->
    <div id="bookmarks-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">المفضلة</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="bookmarks-list" class="flex-1 overflow-y-auto custom-scrollbar p-4">
            <p class="text-center opacity-50">لا توجد عناصر محفوظة</p>
        </div>
    </div>
    
    <!-- Khatmah Panel -->
    <div id="khatmah-panel" class="panel">
        <div class="panel-header">
            <h2 class="text-xl font-bold">الختمات</h2>
            <button class="close-panel p-2 hover:bg-white/10 rounded-lg transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4">
            <!-- Create New Khatmah -->
            <div class="card mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-plus-circle" style="color: var(--primary)"></i>
                    إنشاء ختمة جديدة
                </h3>
                <div class="space-y-3">
                    <input type="text" id="khatmah-name" class="input" placeholder="اسم الختمة (مثال: ختمة رمضان)">
                    <input type="text" id="khatmah-goal" class="input" placeholder="الهدف (مثال: ختم القرآن في 30 يوم)">
                    <input type="number" id="khatmah-daily-pages" class="input" placeholder="عدد الصفحات اليومية" min="1" max="604" value="20">
                    <button id="create-khatmah" class="btn btn-primary w-full">
                        <i class="fas fa-plus"></i>
                        إنشاء الختمة
                    </button>
                </div>
            </div>
            
            <!-- Current Khatmahs -->
            <div class="mb-4">
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-book-open" style="color: var(--primary)"></i>
                    الختمات الحالية
                </h3>
                <div id="current-khatmahs">
                    <!-- Current khatmahs will be loaded here -->
                </div>
            </div>
            
            <!-- Completed Khatmahs -->
            <div>
                <h3 class="font-bold mb-3 flex items-center gap-2">
                    <i class="fas fa-trophy" style="color: var(--secondary)"></i>
                    الختمات المكتملة
                </h3>
                <div id="completed-khatmahs">
                    <!-- Completed khatmahs will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Khatmah Analytics Modal -->
    <div id="khatmah-analytics-modal" class="modal">
        <div class="modal-content p-6" style="max-width: 600px">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">تحليلات الختمة</h3>
                <button id="close-analytics" class="text-2xl">&times;</button>
            </div>
            
            <div id="analytics-content">
                <!-- Analytics will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Tafsir Popup -->
    <div id="tafsir-popup" class="fixed inset-0 z-[100] bg-black/50 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl max-w-2xl w-full max-h-[80vh] overflow-hidden shadow-xl">
            <div class="panel-header rounded-t-xl">
                <h3 class="text-lg font-bold">التفسير والترجمة</h3>
                <button id="close-tafsir" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="tafsir-content" class="p-4 overflow-y-auto max-h-[60vh] custom-scrollbar">
                <!-- Tafsir content will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Audio Players -->
    <audio id="page-audio" class="hidden"></audio>
    <audio id="ayah-audio" class="hidden"></audio>
    
    <script>
    // App Configuration
    const CONFIG = {
        API_BASE: 'https://api.quran.com/api/v4',
        AUDIO_BASE: 'https://verses.quran.com/',
        TOTAL_PAGES: 604,
        GEMINI_API_KEY: 'AIzaSyCZynYml3QFl3GT_d_pWfpa4xeic-hpLPQ',
        GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent'
    };
    
    // Application State
    const state = {
        currentPage: parseInt(localStorage.getItem('lastPage')) || 1,
        currentTheme: localStorage.getItem('theme') || 'light',
        fontSize: parseInt(localStorage.getItem('fontSize')) || 20,
        fontType: localStorage.getItem('fontType') || 'font-arabic',
        surahs: [],
        reciters: [],
        tafsirs: [],
        translations: [],
        selectedReciter: parseInt(localStorage.getItem('selectedReciter')) || 7,
        selectedTafsir: parseInt(localStorage.getItem('selectedTafsir')) || 169,
        selectedTranslation: parseInt(localStorage.getItem('selectedTranslation')) || 131,
        pageData: null,
        selectedAyah: null,
        isPlaying: false,
        currentAudioIndex: 0,
        audioQueue: [],
        bookmarks: JSON.parse(localStorage.getItem('bookmarks')) || [],
        khatmahs: JSON.parse(localStorage.getItem('khatmahs')) || [],
        shareSettings: {
            fontSize: 24,
            bgColor: '#ffffff',
            textColor: '#111827',
            fontFamily: 'Amiri Quran'
        },
        currentSurahsInPage: [],
        memorizationMode: false,
        speechRecognition: null,
        currentMemorizationWords: [],
        lastProcessedWord: null, // تتبع آخر كلمة تمت معالجتها
        memorizationStats: {
            totalWords: 0,
            correctWords: 0,
            incorrectWords: 0,
            currentWordIndex: 0,
            errors: [],
            accuracy: 0
        },
        memorizationSettings: {
            soundAlerts: true,
            showTashkeel: true,
            autoRepeat: true,
            sensitivity: 0.8
        },
        memorizationRange: {
            type: 'page', // 'page', 'ayah', 'surah', 'custom'
            fromSurah: 1,
            fromAyah: 1,
            toSurah: 1,
            toAyah: 1
        }
    };
    
    // API Functions
    const API = {
        async fetchWithRetry(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                }
            }
        },
        
        async getChapters() {
            const data = await this.fetchWithRetry(`${CONFIG.API_BASE}/chapters?language=ar`);
            return data.chapters;
        },
        
        async getReciters() {
            const data = await this.fetchWithRetry(`${CONFIG.API_BASE}/resources/recitations?language=ar`);
            return data.recitations;
        },
        
        async getTafsirs() {
            const data = await this.fetchWithRetry(`${CONFIG.API_BASE}/resources/tafsirs?language=ar`);
            return data.tafsirs;
        },
        
        async getTranslations() {
            const data = await this.fetchWithRetry(`${CONFIG.API_BASE}/resources/translations`);
            return data.translations;
        },
        
        async getPageData(pageNumber) {
            const url = `${CONFIG.API_BASE}/verses/by_page/${pageNumber}?language=ar&words=false&audio=${state.selectedReciter}&tafsirs=${state.selectedTafsir}&translations=${state.selectedTranslation}&fields=text_uthmani,chapter_id,juz_number,page_number,verse_key,verse_number`;
            console.log('API URL:', url);
            
            try {
                const data = await this.fetchWithRetry(url);
                console.log('API Response:', data);
                
                if (!data || !data.verses) {
                    throw new Error('Invalid API response structure');
                }
                
                return data.verses;
            } catch (error) {
                console.error('API Error:', error);
                throw new Error(`Failed to load page data: ${error.message}`);
            }
        },
        
        async searchQuran(query) {
            const data = await this.fetchWithRetry(`${CONFIG.API_BASE}/search?q=${encodeURIComponent(query)}&language=ar`);
            return data.search;
        },
        
        async getVerseByKey(verseKey) {
            const url = `${CONFIG.API_BASE}/verses/by_key/${verseKey}?language=ar&audio=${state.selectedReciter}&tafsirs=${state.selectedTafsir}&translations=${state.selectedTranslation}`;
            const data = await this.fetchWithRetry(url);
            return data.verse;
        }
    };
    
    // Core Application
    const App = {
        // Advanced Arabic Text Normalization for Speech Recognition
        normalizeArabicText(text) {
            if (!text) return '';
            
            return text
                // Remove all diacritics and tashkeel
                .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED\u08F0-\u08FF\u06DF-\u06E8]/g, '')
                // Normalize Alif variations
                .replace(/[\u0671\u0623\u0625\u0622]/g, '\u0627')
                // Normalize Ta Marbuta
                .replace(/\u0629/g, '\u0647')
                // Normalize Ya variations
                .replace(/\u0649/g, '\u064a')
                // Remove Tatweel
                .replace(/\u0640/g, '')
                // Remove control characters
                .replace(/[\u200C-\u200F\u202A-\u202E]/g, '')
                // Normalize whitespace
                .replace(/\s+/g, ' ')
                .trim();
        },

        // Calculate text similarity for speech recognition
        calculateSimilarity(spoken, expected) {
            const normalizedSpoken = this.normalizeArabicText(spoken);
            const normalizedExpected = this.normalizeArabicText(expected);
            
            if (normalizedSpoken === normalizedExpected) return 1.0;
            
            // Levenshtein distance for fuzzy matching
            const matrix = [];
            const len1 = normalizedSpoken.length;
            const len2 = normalizedExpected.length;
            
            for (let i = 0; i <= len2; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= len1; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len2; i++) {
                for (let j = 1; j <= len1; j++) {
                    if (normalizedExpected.charAt(i - 1) === normalizedSpoken.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const distance = matrix[len2][len1];
            const maxLength = Math.max(len1, len2);
            return maxLength === 0 ? 1 : (maxLength - distance) / maxLength;
        },
        async init() {
            console.log('Initializing app...');
            
            // Remove loading screen if it exists
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            try {
                // Apply saved settings
                document.body.setAttribute('data-theme', state.currentTheme);
                this.applySettings();
                
                // Add immediate test data for debugging
                const testData = [
                    {
                        text_uthmani: 'بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ',
                        chapter_id: 1,
                        verse_key: '1:1',
                        verse_number: 1,
                        juz_number: 1
                    },
                    {
                        text_uthmani: 'الْحَمْدُ لِلَّهِ رَبِّ الْعَالَمِينَ',
                        chapter_id: 1,
                        verse_key: '1:2',
                        verse_number: 2,
                        juz_number: 1
                    }
                ];
                
                console.log('Loading chapters and reciters...');
                // Try to load resources, but continue with test data if it fails
                try {
                    const [chapters, reciters] = await Promise.all([
                        API.getChapters(),
                        API.getReciters()
                    ]);
                    
                    console.log('Chapters loaded:', chapters ? chapters.length : 'null');
                    console.log('Reciters loaded:', reciters ? reciters.length : 'null');
                    
                    state.surahs = chapters || [{ id: 1, name_arabic: 'الفاتحة' }];
                    state.reciters = reciters || [{ id: 7, reciter_name: 'Mishary Rashid Alafasy' }];
                } catch (apiError) {
                    console.warn('API failed, using fallback data:', apiError);
                    state.surahs = [{ id: 1, name_arabic: 'الفاتحة' }];
                    state.reciters = [{ id: 7, reciter_name: 'Mishary Rashid Alafasy' }];
                }
                
                // Setup UI
                this.populateSelects();
                this.initSurahList();
                this.initEventListeners();
                this.initAI();
                
                // Show test data immediately
                state.pageData = testData;
                state.currentPage = 1;
                this.renderPage();
                
                console.log('Loading actual page:', state.currentPage);
                // Try to load actual page data in background
                try {
                    await this.loadPage(state.currentPage);
                } catch (pageError) {
                    console.warn('Page loading failed, keeping test data:', pageError);
                }
                
                // Update displays
                this.updateKhatmahsDisplay();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                // Even if init fails, show test data
                state.pageData = [
                    {
                        text_uthmani: 'خطأ في التحميل - هذا نص تجريبي',
                        chapter_id: 1,
                        verse_key: '1:1',
                        verse_number: 1,
                        juz_number: 1
                    }
                ];
                state.currentPage = 1;
                this.renderPage();
            }
        },
        
        applySettings() {
            const fontSizeEl = document.getElementById('font-size');
            const fontSizeValueEl = document.getElementById('font-size-value');
            const pageContentEl = document.getElementById('page-content');
            const fontTypeEl = document.getElementById('font-type');
            const tafsirSelectEl = document.getElementById('tafsir-select');
            const translationSelectEl = document.getElementById('translation-select');
            
            if (fontSizeEl) fontSizeEl.value = state.fontSize;
            if (fontSizeValueEl) fontSizeValueEl.textContent = state.fontSize + 'px';
            if (pageContentEl) pageContentEl.style.fontSize = state.fontSize + 'px';
            
            if (fontTypeEl) fontTypeEl.value = state.fontType;
            if (pageContentEl) pageContentEl.className = state.fontType + ' text-xl leading-loose';
            
            // Load saved tafsir and translation selections
            if (tafsirSelectEl) tafsirSelectEl.value = state.selectedTafsir;
            if (translationSelectEl) translationSelectEl.value = state.selectedTranslation;
        },
        
        populateSelects() {
            const reciterSelect = document.getElementById('reciter-select');
            if (reciterSelect) {
                reciterSelect.innerHTML = '';
                state.reciters.forEach(r => {
                    const option = new Option(r.reciter_name, r.id);
                    reciterSelect.add(option);
                });
                reciterSelect.value = state.selectedReciter;
            }
            
            // Populate memorization surah selects
            const fromSurahSelect = document.getElementById('memorization-from-surah');
            const toSurahSelect = document.getElementById('memorization-to-surah');
            
            if (fromSurahSelect && toSurahSelect) {
                fromSurahSelect.innerHTML = '';
                toSurahSelect.innerHTML = '';
                
                state.surahs.forEach(surah => {
                    const option1 = new Option(surah.name_arabic, surah.id);
                    const option2 = new Option(surah.name_arabic, surah.id);
                    fromSurahSelect.add(option1);
                    toSurahSelect.add(option2);
                });
                
                fromSurahSelect.value = state.memorizationRange.fromSurah;
                toSurahSelect.value = state.memorizationRange.toSurah;
            }
        },
        
        async loadPage(pageNumber) {
            if (pageNumber < 1 || pageNumber > CONFIG.TOTAL_PAGES) return;
            
            console.log('Loading page:', pageNumber);
            
            // Show skeleton loading
            const loadingScreen = document.getElementById('loading-screen');
            const skeletonLoading = document.getElementById('skeleton-loading');
            const pageWrapper = document.getElementById('page-wrapper');
            
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (skeletonLoading) skeletonLoading.classList.remove('hidden');
            if (pageWrapper) pageWrapper.classList.add('hidden');
            
            try {
                console.log('Fetching page data for page:', pageNumber);
                const verses = await API.getPageData(pageNumber);
                console.log('Received verses:', verses);
                
                if (!verses || verses.length === 0) {
                    throw new Error('No verses received from API');
                }
                
                state.pageData = verses;
                state.currentPage = pageNumber;
                
                localStorage.setItem('lastPage', pageNumber);
                
                this.renderPage();
                this.setupAudio();
                this.trackPageInKhatmah(pageNumber);
                
                console.log('Page loaded successfully with', verses.length, 'verses');
            } catch (error) {
                console.error('Error loading page:', error);
                document.getElementById('page-content').innerHTML = `
                    <div class="text-center p-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-lg font-bold mb-2">خطأ في تحميل الصفحة</h3>
                        <p class="text-sm text-gray-600 mb-4">${error.message}</p>
                        <div class="space-x-2">
                            <button onclick="App.loadPage(${pageNumber})" class="btn btn-primary">
                                <i class="fas fa-redo"></i> إعادة المحاولة
                            </button>
                            <button onclick="App.loadPage(1)" class="btn btn-secondary">
                                <i class="fas fa-home"></i> الصفحة الأولى
                            </button>
                        </div>
                    </div>
                `;
                this.showToast('خطأ في تحميل الصفحة', 'error');
            } finally {
                const skeletonLoading = document.getElementById('skeleton-loading');
                const pageWrapper = document.getElementById('page-wrapper');
                
                if (skeletonLoading) skeletonLoading.classList.add('hidden');
                if (pageWrapper) pageWrapper.classList.remove('hidden');
            }
        },
        
        renderPage() {
            const pageContent = document.getElementById('page-content');
            pageContent.innerHTML = '';
            
            console.log('Rendering page. PageData:', state.pageData);
            console.log('PageData length:', state.pageData ? state.pageData.length : 'null');
            console.log('Page content element:', pageContent);
            
            // Add debug message to page
            pageContent.innerHTML = '<div style="padding: 20px; background: yellow; color: black;">🔄 جاري تحميل الآيات...</div>';
            
            if (!state.pageData || state.pageData.length === 0) {
                console.error('No page data available');
                pageContent.innerHTML = '<div class="text-center p-8"><p class="text-red-500">لا توجد بيانات لهذه الصفحة</p><button onclick="App.loadPage(1)" class="btn btn-primary mt-4">رجوع للصفحة الأولى</button></div>';
                return;
            }
            
            // Clear the loading message
            pageContent.innerHTML = '';
            
            // Track surahs in current page
            state.currentSurahsInPage = [];
            let currentSurahId = null;
            
            // Store all words for memorization mode
            state.currentMemorizationWords = [];
            
            state.pageData.forEach(verse => {
                console.log('Processing verse:', verse);
                
                // Check if new surah starts
                if (verse.chapter_id !== currentSurahId) {
                    currentSurahId = verse.chapter_id;
                    const surah = state.surahs.find(s => s.id === currentSurahId);
                    
                    console.log('Found surah:', surah);
                    
                    if (surah) {
                        state.currentSurahsInPage.push(surah);
                        
                        // Add surah header
                        const surahHeader = document.createElement('div');
                        surahHeader.className = 'surah-header';
                        surahHeader.innerHTML = `
                            <h2>${surah.name_arabic}</h2>
                            ${surah.id !== 1 && surah.id !== 9 ? '<p class="basmala">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</p>' : ''}
                        `;
                        pageContent.appendChild(surahHeader);
                        console.log('Added surah header');
                    }
                }
                
                const ayahSpan = document.createElement('span');
                ayahSpan.className = 'ayah';
                ayahSpan.dataset.verseKey = verse.verse_key;
                ayahSpan.dataset.text = verse.text_uthmani;
                
                console.log('Created ayah span for verse:', verse.verse_key);
                
                // Check if bookmarked
                if (state.bookmarks.some(b => b.verseKey === verse.verse_key)) {
                    ayahSpan.classList.add('bookmarked');
                }
                
                // Prepare for memorization mode - wrap each word
                if (state.memorizationMode) {
                    console.log('Memorization mode - processing words');
                    const words = verse.text_uthmani.split(' ');
                    words.forEach((word, wordIndex) => {
                        if (word.trim().length > 0) {
                            const cleanedWord = word.trim();
                            // Remove pure diacritics that are not words
                            const plainWord = this.convertToPlainText(cleanedWord);
                            
                            // Only add if it's an actual word (has Arabic letters)
                            if (this.isActualWord(plainWord)) {
                                state.currentMemorizationWords.push(cleanedWord);
                                const wordSpan = document.createElement('span');
                                wordSpan.className = 'ayah-word hidden'; // Always start hidden
                                wordSpan.textContent = cleanedWord + ' ';
                                wordSpan.dataset.word = cleanedWord;
                                wordSpan.dataset.plainWord = plainWord; // Store plain version
                                wordSpan.dataset.wordIndex = wordIndex;
                                ayahSpan.appendChild(wordSpan);
                            }
                        }
                    });
                    // Set first word to waiting after all words are created
                    setTimeout(() => {
                        const firstWord = ayahSpan.querySelector('.ayah-word');
                        if (firstWord && state.memorizationStats.currentWordIndex === 0) {
                            firstWord.classList.add('waiting');
                        }
                    }, 100);
                } else {
                    // Normal mode - display text directly with verse number
                    const verseText = verse.text_uthmani || verse.text_imlaei || verse.text || 'نص غير متوفر';
                    console.log('Adding verse text:', verseText.substring(0, 50) + '...');
                    
                    ayahSpan.innerHTML = verseText + ' ';
                    
                    console.log('Text added to ayah');
                }
                
                const numberSpan = document.createElement('span');
                numberSpan.className = 'verse-number';
                numberSpan.textContent = '﴿' + (verse.verse_number || '?') + '﴾';
                ayahSpan.appendChild(numberSpan);
                
                console.log('Number span added');
                
                ayahSpan.appendChild(document.createTextNode(' '));
                
                pageContent.appendChild(ayahSpan);
                console.log('Ayah added to page content. Total children:', pageContent.children.length);
            });
            
            // Update header
            const firstVerse = state.pageData[0];
            const firstSurah = state.surahs.find(s => s.id === firstVerse.chapter_id);
            
            document.getElementById('page-surah-name').textContent = firstSurah ? firstSurah.name_arabic : '';
            document.getElementById('page-juz').textContent = `الجزء ${firstVerse.juz_number || ''}`;
            document.getElementById('page-number').textContent = `صفحة ${state.currentPage}`;
            
            // Initialize memorization stats if in memorization mode
            if (state.memorizationMode) {
                state.memorizationStats.totalWords = state.currentMemorizationWords.length;
                state.memorizationStats.currentWordIndex = 0;
                this.updateMemorizationDisplay();
                
                // تمييز الكلمة الأولى في وضع الانتظار
                const firstWordElement = document.querySelector('.ayah-word');
                if (firstWordElement) {
                    firstWordElement.classList.add('waiting');
                }
                
                console.log(`Memorization mode initialized with ${state.memorizationStats.totalWords} words`);
            }
            
            console.log('PAGE RENDER COMPLETED. Final innerHTML length:', pageContent.innerHTML.length);
            console.log('Final page content preview:', pageContent.innerHTML.substring(0, 200) + '...');
        },
        
        // وضع التحفيظ - محسّن مع واجهة منفصلة - بدء مباشر
        startMemorizationMode(type = 'page') {
            state.memorizationMode = true;
            state.memorizationRange.type = type;
            
            // إغلاق أي لوحة مفتوحة أولاً
            document.querySelectorAll('.panel.visible').forEach(panel => {
                panel.classList.remove('visible');
            });
            
            // التبديل إلى الواجهة المنفصلة مباشرة
            this.switchToMemorizationInterface();
            
            // إعادة تعيين إحصائيات الحفظ
            this.resetMemorizationStats();
            
            // إعادة عرض الصفحة مع وضع الحفظ
            this.renderMemorizationPage();
            
            // بدء التعرف على الصوت عبر AssemblyAI
            startAssemblyAiStreaming();
            
            this.showToast('بدأ وضع الحفظ - ابدأ بالتلاوة', 'success');
        },
        
        // التبديل إلى واجهة الحفظ المنفصلة
        switchToMemorizationInterface() {
            const mainInterface = document.getElementById('main-reading-interface');
            const memorizationInterface = document.getElementById('memorization-interface');
            
            console.log('Switching to memorization interface...');
            console.log('Main interface found:', !!mainInterface);
            console.log('Memorization interface found:', !!memorizationInterface);
            
            if (mainInterface && memorizationInterface) {
                mainInterface.classList.add('hidden');
                memorizationInterface.classList.remove('hidden');
                
                // تحديث معلومات الهيدر
                this.updateMemorizationHeader();
                
                console.log('Successfully switched to memorization interface');
            } else {
                console.error('Could not find memorization interface elements');
                console.error('Main interface element:', mainInterface);
                console.error('Memorization interface element:', memorizationInterface);
                this.showToast('خطأ في تفعيل وضع الحفظ', 'error');
            }
        },
        
        // الخروج من واجهة الحفظ
        exitMemorizationInterface() {
            const mainInterface = document.getElementById('main-reading-interface');
            const memorizationInterface = document.getElementById('memorization-interface');
            
            console.log('Exiting memorization interface...');
            
            if (memorizationInterface) {
                memorizationInterface.classList.add('hidden');
            }
            
            if (mainInterface) {
                mainInterface.classList.remove('hidden');
            }
            
            // إيقاف وضع الحفظ
            this.stopMemorizationMode();
        },
        
        // تمكين التنقل بين الصفحات في وضع الحفظ
        navigatePageInMemorization(direction) {
            const newPage = state.currentPage + direction;
            if (newPage >= 1 && newPage <= CONFIG.TOTAL_PAGES) {
                // إيقاف التعرف على الصوت مؤقتاً
                stopAssemblyAiStreaming();
                if (state.speechRecognition) {
                    state.speechRecognition.stop();
                }
                
                // إعادة تعيين إحصائيات الحفظ للصفحة الجديدة
                this.resetMemorizationStats();
                
                // تحميل الصفحة الجديدة
                this.loadPage(newPage).then(() => {
                    // إعادة بدء وضع الحفظ مع الصفحة الجديدة
                    this.renderMemorizationPage();
                    
                    // التأكد من إخفاء جميع الكلمات
                    setTimeout(() => {
                        const wordElements = document.querySelectorAll('.ayah-word');
                        const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
                        const elements = memWordElements.length > 0 ? memWordElements : wordElements;
                        
                        elements.forEach((word, index) => {
                            word.classList.remove('revealed', 'waiting', 'correct', 'incorrect');
                            word.classList.add('hidden');
                            
                            // تعيين الكلمة الأولى في وضع الانتظار
                            if (index === 0) {
                                word.classList.add('waiting');
                            }
                        });
                        
                        // إعادة بدء التعرف على الصوت عبر AssemblyAI
                        startAssemblyAiStreaming();
                    }, 300);
                });
            }
        },
        
        // تحديث هيدر الحفظ
        updateMemorizationHeader() {
            const surahNameEl = document.getElementById('memorization-surah-name');
            const rangeEl = document.getElementById('memorization-range');
            
            if (state.currentSurahsInPage.length > 0) {
                const firstSurah = state.currentSurahsInPage[0];
                if (surahNameEl) surahNameEl.textContent = firstSurah.name_arabic;
                if (rangeEl) rangeEl.textContent = `صفحة ${state.currentPage}`;
            }
        },
        
        // عرض صفحة الحفظ
        renderMemorizationPage() {
            const memorizationContent = document.getElementById('memorization-page-content');
            const mainContent = document.getElementById('page-content');
            
            if (memorizationContent && mainContent) {
                // نسخ المحتوى من الصفحة الرئيسية
                memorizationContent.innerHTML = mainContent.innerHTML;
                
                // تطبيق وضع الحفظ
                document.body.classList.add('memorization-mode');
                
                // إعداد الكلمات للحفظ
                this.setupMemorizationWords();
                
                // تحديث العرض
                this.updateMemorizationProgressDisplay();
            }
        },
        
        // إعداد كلمات الحفظ
        setupMemorizationWords() {
            const memorizationContent = document.getElementById('memorization-page-content');
            const wordElements = memorizationContent.querySelectorAll('.ayah-word');
            
            state.currentMemorizationWords = [];
            
            wordElements.forEach((word, index) => {
                const wordText = word.dataset.text || word.textContent.trim();
                state.currentMemorizationWords.push(wordText);
                
                // إخفاء جميع الكلمات في البداية
                word.classList.add('hidden');
                word.classList.remove('revealed', 'waiting');
                
                // تمييز الكلمة الأولى
                if (index === 0) {
                    word.classList.add('waiting');
                }
            });
            
            // تحديث الإحصائيات
            state.memorizationStats.totalWords = state.currentMemorizationWords.length;
            state.memorizationStats.currentWordIndex = 0;
            
            console.log(`Memorization initialized with ${state.memorizationStats.totalWords} words`);
        },
        
        // تحديث عرض التقدم في واجهة الحفظ
        updateMemorizationProgressDisplay() {
            // تحديث الدائرة المئوية
            const progressRing = document.getElementById('memorization-progress-ring');
            const progressPercent = document.getElementById('memorization-progress-percent');
            
            if (progressRing && progressPercent) {
                const progress = state.memorizationStats.totalWords > 0 
                    ? (state.memorizationStats.currentWordIndex / state.memorizationStats.totalWords) * 100 
                    : 0;
                const circumference = 2 * Math.PI * 26; // radius = 26
                const strokeDashoffset = circumference - (progress / 100) * circumference;
                
                progressRing.style.strokeDasharray = circumference;
                progressRing.style.strokeDashoffset = strokeDashoffset;
                progressPercent.textContent = Math.round(progress) + '%';
            }
            
            // تحديث شريط التقدم في الفوتر
            const progressBarFooter = document.getElementById('memorization-progress-bar-footer');
            if (progressBarFooter) {
                const progress = state.memorizationStats.totalWords > 0 
                    ? (state.memorizationStats.currentWordIndex / state.memorizationStats.totalWords) * 100 
                    : 0;
                progressBarFooter.style.width = progress + '%';
            }
            
            // تحديث النصوص
            const progressText = document.getElementById('memorization-progress-text');
            const totalText = document.getElementById('memorization-total-text');
            const accuracyEl = document.getElementById('memorization-accuracy');
            const errorsCountEl = document.getElementById('memorization-errors-count');
            
            if (progressText) {
                progressText.textContent = this.convertToArabicNumbers(state.memorizationStats.currentWordIndex);
            }
            if (totalText) {
                totalText.textContent = this.convertToArabicNumbers(state.memorizationStats.totalWords);
            }
            
            // حساب الدقة
            if (accuracyEl) {
                const accuracy = state.memorizationStats.totalWords > 0 
                    ? Math.round((state.memorizationStats.correctWords / (state.memorizationStats.correctWords + state.memorizationStats.incorrectWords)) * 100) || 0
                    : 0;
                accuracyEl.textContent = this.convertToArabicNumbers(accuracy) + '%';
                
                // تغيير اللون بناءً على الدقة
                if (accuracy >= 90) {
                    accuracyEl.className = 'font-bold text-green-300';
                } else if (accuracy >= 75) {
                    accuracyEl.className = 'font-bold text-yellow-300';
                } else {
                    accuracyEl.className = 'font-bold text-red-300';
                }
            }
            
            // تحديث عدد الأخطاء
            if (errorsCountEl) {
                errorsCountEl.textContent = this.convertToArabicNumbers(state.memorizationStats.errors.length);
            }
            
            // تحديث قائمة الأخطاء
            this.updateErrorsList();
        },
        
        // تحويل الأرقام إلى عربية
        convertToArabicNumbers(num) {
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return String(num).replace(/[0-9]/g, function(match) {
                return arabicNumbers[parseInt(match)];
            });
        },
        
        stopMemorizationMode() {
            state.memorizationMode = false;
            document.body.classList.remove('memorization-mode');
            
            // Stop AssemblyAI streaming
            stopAssemblyAiStreaming();
            
            // Also stop old speech recognition if still running
            if (state.speechRecognition) {
                state.speechRecognition.stop();
                state.speechRecognition = null;
            }
            
            document.querySelector('.recording-indicator')?.classList.remove('active');
            
            // عرض إحصائيات نهائية
            this.showMemorizationResults();
            
            // العودة إلى الواجهة الرئيسية إذا كان في واجهة منفصلة
            const memorizationInterface = document.getElementById('memorization-interface');
            if (!memorizationInterface.classList.contains('hidden')) {
                this.exitMemorizationInterface();
            } else {
                // إعادة عرض الصفحة بدون وضع الحفظ
                this.renderPage();
            }
        },
        
        resetMemorizationStats() {
            state.memorizationStats = {
                totalWords: 0,
                correctWords: 0,
                incorrectWords: 0,
                currentWordIndex: 0,
                errors: [],
                accuracy: 0
            };
            
            this.updateMemorizationDisplay();
        },
        
// 🚫 OLD SYSTEM DISABLED: Performance-First Speech Recognition Architecture
        // This function has been replaced by the new Hugging Face API-based system
        /*
        initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                this.showToast('المتصفح لا يدعم التعرف على الصوت', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            state.speechRecognition = new SpeechRecognition();
            
            // 🎯 Ultra-Enhanced Recognition Settings for Maximum Performance
            state.speechRecognition.lang = 'ar-SA';
            state.speechRecognition.continuous = true;
            state.speechRecognition.interimResults = true;
            state.speechRecognition.maxAlternatives = 10; // Optimized: reduced from 50 to 10 for better performance
            
            // 🔥 Performance Optimization Settings
            if (state.speechRecognition.speechSynthesis) {
                state.speechRecognition.speechSynthesis.rate = 3.0; // Ultra-maximum speed for fastest recitation
            }
            
            // 🎛️ Ultra-high sensitivity settings with performance optimization
            state.speechRecognition.grammars = state.speechRecognition.grammars || [];
            
            // 🧠 Initialize Performance Caches
            this.initPerformanceCaches();
            
            // ⚡ Initialize Background Processing
            this.initBackgroundProcessing();
            
            // ⚡ Ultra-Minimal Timeouts for Immediate Response (Performance Optimized)
            let processingTimeout = null;
            let lastFinalTranscript = '';
            let interimProcessingTimeout = null;
            let lastInterimProcessed = '';
            let immediateProcessingTimeout = null;
            let performanceStartTime = performance.now();
            let recognitionCount = 0;
            
            // 🎯 Performance Monitoring
            const performanceMetrics = {
                avgProcessingTime: 0,
                totalRecognitions: 0,
                successfulMatches: 0,
                cacheHits: 0
            };
            
            // 🚀 Ultra-Performance onresult Handler with Improved Interim Processing
            state.speechRecognition.onresult = (event) => {
                const processingStart = performance.now();
                recognitionCount++;
                performanceMetrics.totalRecognitions++;
                
                let interimTranscript = '';
                let finalTranscript = '';
                
                // ⚡ Process all alternatives, not just the first one
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    
                    if (result.isFinal) {
                        // 🎯 Process multiple alternatives for better accuracy
                        let bestMatch = null;
                        let bestScore = 0;
                        
                        for (let j = 0; j < Math.min(result.length, 3); j++) {
                            const transcript = result[j].transcript.trim();
                            const confidence = result[j].confidence;
                            
                            if (transcript) {
                                const score = this.evaluateTranscriptQuality(transcript, confidence);
                                if (score > bestScore) {
                                    bestMatch = { transcript, confidence };
                                    bestScore = score;
                                }
                            }
                        }
                        
                        if (bestMatch) {
                            finalTranscript = bestMatch.transcript;
                            this.processSequentialText(finalTranscript, bestMatch.confidence, processingStart);
                        }
                    } else {
                        // 🔍 Improved interim handling - treat as complete unit
                        const transcript = result[0].transcript.trim();
                        const confidence = result[0].confidence;
                        
                        if (confidence > 0.4 && transcript.length > 0) {
                            interimTranscript = transcript;
                            
                            // 🎯 Process interim as sequence, not individual words
                            clearTimeout(interimProcessingTimeout);
                            interimProcessingTimeout = setTimeout(() => {
                                this.processInterimSequence(transcript, confidence);
                            }, 100); // Slightly longer delay for better interim processing
                        }
                    }
                }
                
                // 📊 Performance Metrics Update
                const processingTime = performance.now() - processingStart;
                performanceMetrics.avgProcessingTime = 
                    (performanceMetrics.avgProcessingTime * (performanceMetrics.totalRecognitions - 1) + processingTime) / performanceMetrics.totalRecognitions;
                
                // 🔍 Show enhanced interim feedback
                if (interimTranscript && !finalTranscript) {
                    this.showEnhancedInterimFeedback(interimTranscript, processingTime);
                }
            };
            
            state.speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                if (event.error === 'no-speech') {
                    this.showToast('لم يتم سماع صوت واضح', 'warning');
                } else if (event.error === 'network') {
                    this.showToast('خطأ في الاتصال', 'error');
                } else if (event.error === 'not-allowed') {
                    this.showToast('يجب السماح باستخدام الميكروفون', 'error');
                    return;
                } else {
                    this.showToast(`خطأ في التعرف على الصوت: ${event.error}`, 'error');
                }
                
                // Ultra-fast restart after error for continuous capture
                setTimeout(() => {
                    if (state.memorizationMode && state.speechRecognition) {
                        try {
                            state.speechRecognition.start();
                            console.log('Speech recognition restarted after error for ultra-fast continuous capture');
                        } catch (e) {
                            // Only log actual errors, not "already started" errors
                            if (!e.message.includes('already started')) {
                                console.warn('Could not restart speech recognition after error:', e.message);
                                // Try one more time with slightly longer delay for real errors only
                                setTimeout(() => {
                                    try {
                                        if (state.speechRecognition && state.memorizationMode) {
                                            state.speechRecognition.start();
                                        }
                                    } catch (e2) {
                                        if (!e2.message.includes('already started')) {
                                            console.error('Final restart attempt failed:', e2.message);
                                        }
                                    }
                                }, 300);
                            }
                        }
                    }
                }, 200); // Slightly longer delay after error
            };
            
            state.speechRecognition.onstart = () => {
                console.log('Speech recognition started successfully');
                const indicator = document.querySelector('.recording-indicator');
                if (indicator) indicator.classList.add('active');
                // Speech feedback disabled per user request
            };
            
            state.speechRecognition.onend = () => {
                console.log('Speech recognition ended - restarting immediately for continuous capture');
                const indicator = document.querySelector('.recording-indicator');
                if (indicator) indicator.classList.remove('active');
                
                // Ultra-fast restart for continuous ultra-responsive recognition
                if (state.memorizationMode && state.speechRecognition) {
                    setTimeout(() => {
                        try {
                            // Check if recognition is not already running
                            if (state.speechRecognition && state.memorizationMode) {
                                state.speechRecognition.start();
                                console.log('Speech recognition restarted for continuous ultra-fast capture');
                            }
                        } catch (e) {
                            // Only log the error if it's not the "already started" error
                            if (!e.message.includes('already started')) {
                                console.warn('Could not restart immediately:', e.message);
                                // Try again with longer delay only for actual errors
                                setTimeout(() => {
                                    try {
                                        if (state.speechRecognition && state.memorizationMode) {
                                            state.speechRecognition.start();
                                        }
                                    } catch (e2) {
                                        if (!e2.message.includes('already started')) {
                                            console.warn('Second restart attempt failed:', e2.message);
                                        }
                                    }
                                }, 100);
                            }
                        }
                    }, 50); // Very fast restart
                }
            };
            
            // Start recognition with better error handling
            try {
                state.speechRecognition.start();
                this.showToast('بدأ التعرف على الصوت - ابدأ بالتلاوة', 'success');
            } catch (error) {
                console.error('Could not start speech recognition:', error);
                this.showToast('فشل في بدء التعرف على الصوت', 'error');
            }
        },
        */
        // End of disabled old speech recognition system

        restartSpeechRecognition() {
            try {
                if (state.speechRecognition && state.memorizationMode) {
                    state.speechRecognition.start();
                }
            } catch (error) {
                console.error('Error restarting speech recognition:', error);
            }
        },
        
        // 🧠 Performance Caches Initialization
        initPerformanceCaches() {
            // 🗺️ Initialize Word Recognition Cache
            if (!this.wordRecognitionCache) {
                this.wordRecognitionCache = new Map();
            }
            
            // 🚀 Initialize Pattern Cache for Quranic Letters
            if (!this.patternCache) {
                this.patternCache = new Map();
            }
            
            // 🎯 Initialize Similarity Calculation Cache
            if (!this.similarityCache) {
                this.similarityCache = new Map();
            }
            
            // 🔥 Pre-load Common Quranic Words for Ultra-Fast Access
            this.preloadCommonQuranicWords();
            
            console.log('🧠 Performance caches initialized for ultra-fast recognition');
        },
        
        // ⚡ Background Processing Initialization
        initBackgroundProcessing() {
            // 🔄 Initialize background processing queues
            this.processingQueue = [];
            this.isProcessingQueue = false;
            
            // 🔍 Initialize recognition state tracking
            this.recognitionState = {
                lastProcessingTime: 0,
                consecutiveMatches: 0,
                adaptiveThreshold: 0.7,
                currentAccuracy: 1.0
            };
            
            console.log('⚡ Background processing engine initialized');
        },
        
        // 🚀 Pre-load Common Quranic Words
        preloadCommonQuranicWords() {
            const commonQuranicWords = [
                // 🕋️ Most Common Words
                'الله', 'الرحمن', 'الرحيم', 'رب', 'العالمين',
                'الحمد', 'مالك', 'يوم', 'الدين', 'إياك',
                'نعبد', 'نستعين', 'اهدنا', 'الصراط',
                'المستقيم', 'الذين', 'أنعمت', 'عليهم',
                'بسم', 'ولا', 'ليس', 'الضالين',
                // 📜 Disconnected Letters
                'الم', 'المص', 'الر', 'المر', 'كهيعص',
                'طه', 'طسم', 'يس', 'ص', 'ق', 'ن', 'حم'
            ];
            
            // 🎆 Pre-calculate normalized forms and cache them
            commonQuranicWords.forEach(word => {
                const normalized = this.normalizeQuranText(word);
                const plain = this.convertToPlainText(word);
                const plainNormalized = this.normalizeQuranText(plain);
                
                // 🗺️ Cache all variations
                this.wordRecognitionCache.set(word, {
                    original: word,
                    normalized: normalized,
                    plain: plain,
                    plainNormalized: plainNormalized,
                    commonVariations: this.generateCommonVariations(word)
                });
            });
            
            console.log(`🎆 Pre-loaded ${commonQuranicWords.length} common Quranic words for ultra-fast recognition`);
        },
        
        // 🔄 Generate Common Pronunciation Variations
        generateCommonVariations(word) {
            const variations = new Set();
            const normalized = this.normalizeQuranText(word);
            
            // 🔥 Add common pronunciation patterns
            variations.add(normalized);
            variations.add(normalized.replace(/ال/g, 'ل')); // ال -> ل
            variations.add(normalized.replace(/ه$/g, 'ة')); // Final ه -> ة
            variations.add(normalized.replace(/ي$/g, 'ى')); // Final ي -> ى
            
            return Array.from(variations);
        },
        
        // 🚀 Ultra-Fast Quranic Speech Processing
        processQuranicSpeechUltraFast(transcript, confidence, processingStart) {
            console.log(`🚀 Ultra-fast processing: "${transcript}" with confidence: ${confidence}`);
            
            // ⚡ Cache Check for Ultra-Fast Recognition
            const cacheKey = transcript.toLowerCase().trim();
            if (this.wordRecognitionCache.has(cacheKey)) {
                console.log('🚀 Cache hit! Ultra-fast word recognition');
                const cachedWord = this.wordRecognitionCache.get(cacheKey);
                this.processSequentialWord(cachedWord.original);
                return;
            }
            
            // 🔥 Update display immediately for responsiveness
            const lastHeardEl = document.getElementById('last-heard-word');
            if (lastHeardEl) {
                lastHeardEl.textContent = transcript;
            }
            
            // 🎯 Process Special Quranic Patterns First (Highest Priority)
            if (this.processSpecialQuranicPatterns(transcript)) {
                console.log('🎯 Special pattern processed ultra-fast');
                return;
            }
            
            // ⚡ Split and process individual words for ultra-fast recognition
            const words = transcript.trim().split(/\s+/);
            words.forEach(word => {
                if (word && word.length > 0) {
                    this.processSequentialWordUltraFast(word.trim());
                }
            });
            
            // 📊 Performance metrics
            const totalTime = performance.now() - processingStart;
            console.log(`📊 Ultra-fast processing completed in ${totalTime.toFixed(2)}ms`);
        },
        
        // ⚡ Ultra-Fast Sequential Word Processing
        processSequentialWordUltraFast(spokenWord) {
            // 🚀 Ultra-short duplicate filtering for maximum responsiveness
            const now = Date.now();
            if (this.lastProcessedWord && this.lastProcessedWord.word === spokenWord && 
                (now - this.lastProcessedWord.time) < 100) { // Reduced to 100ms for ultra responsiveness
                console.log('⚡ Skipping ultra-recent duplicate word:', spokenWord);
                return;
            }
            
            this.lastProcessedWord = { word: spokenWord, time: now };
            
            // 🔥 Process the word with ultra-fast algorithms
            this.checkSingleWordUltraFast(spokenWord);
        },
        
        // 🚀 Ultra-Fast Single Word Checking
        checkSingleWordUltraFast(spokenWord) {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                console.log('🏁 Memorization completed - all words processed');
                return;
            }
            
            const currentCorrectWord = state.currentMemorizationWords[state.memorizationStats.currentWordIndex];
            
            // ⚡ Ultra-fast word comparison with cache optimization
            const isCorrect = this.compareWordsUltraFast(spokenWord, currentCorrectWord);
            
            if (isCorrect) {
                console.log(`✅ Ultra-fast match found: "${spokenWord}" → "${currentCorrectWord}"`);
                this.processCorrectWordUltraFast(currentCorrectWord);
            } else {
                console.log(`❌ No ultra-fast match: "${spokenWord}" vs "${currentCorrectWord}"`);
                this.processIncorrectWordUltraFast(spokenWord, currentCorrectWord);
            }
        },
        
        // 🚀 Ultra-Fast Word Comparison
        compareWordsUltraFast(spoken, correct) {
            // ⚡ Cache lookup first
            const cacheKey = `${spoken}:${correct}`;
            if (this.similarityCache.has(cacheKey)) {
                return this.similarityCache.get(cacheKey);
            }
            
            // 🔥 Use existing enhanced comparison but with ultra-fast caching
            const result = this.compareWordsTajweed(spoken, correct);
            
            // 🗺️ Cache the result for future ultra-fast lookups
            this.similarityCache.set(cacheKey, result);
            
            return result;
        },
        
        // ✅ Enhanced Correct Word Processing with Visual Feedback
        processCorrectWordUltraFast(correctWord) {
            // 🎆 Update statistics immediately
            state.memorizationStats.correctWords++;
            state.memorizationStats.currentWordIndex++;
            
            // ⚡ Update accuracy instantly
            state.memorizationStats.accuracy = 
                (state.memorizationStats.correctWords / (state.memorizationStats.correctWords + state.memorizationStats.incorrectWords)) * 100;
            
            // 🚀 Enhanced UI updates with visual feedback
            this.updateWordUIWithEnhancedFeedback(correctWord, true);
            this.updateMemorizationDisplayUltraFast();
            
            // 🎯 Enhanced success feedback
            this.showSequenceFeedback('✅ صحيح!', '#22c55e', 600);
            
            // 🔍 Highlight next word for guidance
            this.highlightNextTargetWord();
        },
        
        // ❌ Enhanced Incorrect Word Processing with Visual Feedback
        processIncorrectWordUltraFast(spokenWord, correctWord) {
            // 📈 Update error statistics
            state.memorizationStats.incorrectWords++;
            state.memorizationStats.errors.push({
                spoken: spokenWord,
                correct: correctWord,
                timestamp: new Date().toISOString()
            });
            
            // ⚡ Update accuracy
            state.memorizationStats.accuracy = 
                (state.memorizationStats.correctWords / (state.memorizationStats.correctWords + state.memorizationStats.incorrectWords)) * 100;
            
            // 🚀 Enhanced error feedback with visual indicators
            this.showEnhancedErrorFeedback(spokenWord, correctWord);
            this.updateMemorizationDisplayUltraFast();
        },
        
        // 🎆 Enhanced UI Word Update with Visual Feedback
        updateWordUIWithEnhancedFeedback(word, isCorrect) {
            const wordElements = document.querySelectorAll('.ayah-word');
            const currentIndex = state.memorizationStats.currentWordIndex - 1; // -1 because we already incremented
            
            if (wordElements[currentIndex]) {
                const element = wordElements[currentIndex];
                
                // Remove previous states
                element.classList.remove('waiting', 'hidden', 'current-target');
                
                // Add result state with animation
                element.classList.add(isCorrect ? 'correct' : 'incorrect', 'revealed');
                
                // Add temporary highlight animation
                element.style.transform = 'scale(1.1)';
                element.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 300);
            }
            
            // ⚡ Set next word as waiting with visual indication
            if (wordElements[state.memorizationStats.currentWordIndex]) {
                const nextElement = wordElements[state.memorizationStats.currentWordIndex];
                nextElement.classList.add('waiting', 'current-target');
                nextElement.style.border = '2px solid #3b82f6';
                nextElement.style.borderRadius = '4px';
            }
        },
        
        // 🔍 Highlight Next Target Word
        highlightNextTargetWord() {
            const wordElements = document.querySelectorAll('.ayah-word');
            
            // Remove previous highlights
            wordElements.forEach(el => {
                el.classList.remove('current-target');
                el.style.border = '';
                el.style.borderRadius = '';
            });
            
            // Highlight current target
            if (state.memorizationStats.currentWordIndex < wordElements.length) {
                const targetElement = wordElements[state.memorizationStats.currentWordIndex];
                targetElement.classList.add('current-target');
                targetElement.style.border = '2px solid #10b981';
                targetElement.style.borderRadius = '4px';
                targetElement.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
                
                // Scroll into view if needed
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        },
        
        // 🔥 Enhanced Error Feedback with Visual Indicators
        showEnhancedErrorFeedback(spoken, correct) {
            // Show in feedback area
            this.showSequenceFeedback(`❌ "‎${spoken}‎" → "‎${correct}‎"`, '#ef4444', 1500);
            
            // Highlight the incorrect word in red temporarily
            const currentIndex = state.memorizationStats.currentWordIndex;
            const wordElements = document.querySelectorAll('.ayah-word');
            
            if (wordElements[currentIndex]) {
                const element = wordElements[currentIndex];
                const originalBg = element.style.backgroundColor;
                
                element.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
                element.style.border = '2px solid #ef4444';
                
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                    element.style.border = '2px solid #10b981'; // Back to target highlight
                }, 1000);
            }
        },
        
        // 🚀 Ultra-Fast UI Updates
        updateWordUIUltraFast(word, isCorrect) {
            const wordElements = document.querySelectorAll('.ayah-word');
            const currentIndex = state.memorizationStats.currentWordIndex - 1; // -1 because we already incremented
            
            if (wordElements[currentIndex]) {
                wordElements[currentIndex].classList.remove('waiting', 'hidden');
                wordElements[currentIndex].classList.add(isCorrect ? 'correct' : 'incorrect', 'revealed');
            }
            
            // ⚡ Set next word as waiting
            if (wordElements[state.memorizationStats.currentWordIndex]) {
                wordElements[state.memorizationStats.currentWordIndex].classList.add('waiting');
            }
        },
        
        // ⚡ Ultra-Fast Memorization Display Update
        updateMemorizationDisplayUltraFast() {
            // 📊 Quick stats update
            const totalWordsEl = document.getElementById('total-words');
            const correctWordsEl = document.getElementById('correct-words');
            const accuracyEl = document.getElementById('accuracy');
            
            if (totalWordsEl) {
                totalWordsEl.textContent = this.convertToArabicNumbers(state.memorizationStats.correctWords + state.memorizationStats.incorrectWords);
            }
            
            if (correctWordsEl) {
                correctWordsEl.textContent = this.convertToArabicNumbers(state.memorizationStats.correctWords);
            }
            
            if (accuracyEl) {
                const accuracy = Math.round(state.memorizationStats.accuracy);
                accuracyEl.textContent = `${this.convertToArabicNumbers(accuracy)}%`;
                
                // 🎨 Ultra-fast color coding
                if (accuracy >= 90) {
                    accuracyEl.className = 'font-bold text-green-400';
                } else if (accuracy >= 70) {
                    accuracyEl.className = 'font-bold text-yellow-400';
                } else {
                    accuracyEl.className = 'font-bold text-red-400';
                }
            }
        },
        
        // 🔍 Ultra-Fast Feedback Display
        showUltraFastFeedback(transcript, processingTime) {
            const feedbackEl = document.getElementById('speech-interim-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = `🎙️ ${transcript} (⚡${processingTime.toFixed(0)}ms)`;
                feedbackEl.style.opacity = '1';
                feedbackEl.style.color = '#10b981'; // Green for ultra-fast
                
                // ⚡ Clear ultra-fast feedback
                clearTimeout(this.ultraFastFeedbackTimeout);
                this.ultraFastFeedbackTimeout = setTimeout(() => {
                    feedbackEl.style.opacity = '0.3';
                }, 800);
            }
        },
        
        // ✅ Ultra-Fast Success Feedback
        showUltraFastSuccessFeedback() {
            const feedbackEl = document.getElementById('speech-interim-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = '✅ صحيح!';
                feedbackEl.style.color = '#10b981';
                feedbackEl.style.opacity = '1';
                
                setTimeout(() => {
                    feedbackEl.style.opacity = '0.3';
                }, 500);
            }
        },
        
        // ❌ Ultra-Fast Error Feedback
        showUltraFastErrorFeedback(spoken, correct) {
            const feedbackEl = document.getElementById('speech-interim-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = `❌ "‎${spoken}‎" → "‎${correct}‎"`;
                feedbackEl.style.color = '#ef4444';
                feedbackEl.style.opacity = '1';
                
                setTimeout(() => {
                    feedbackEl.style.opacity = '0.3';
                }, 1000);
            }
        },
        
        // 🚀 PHASE 2: Advanced Real-Time Processing Engine
        
        // 🎆 Enhanced Quranic Pattern Recognition with Real-Time Optimization
        processSpecialQuranicPatternsRealTime(transcript) {
            const normalized = transcript.toLowerCase().trim();
            
            // 🔥 Advanced Quranic Letter Mappings with Multiple Pronunciation Variations
            const quranicLetterMappings = {
                // الم - Alif Lam Mim (Multiple Variations)
                'alif lam mim': 'الم', 'alef lam mim': 'الم', 'alef lam meem': 'الم',
                'ألف لام ميم': 'الم', 'a l m': 'الم', 'alm': 'الم',
                'alif laam meem': 'الم', 'alef laam meem': 'الم',
                
                // المص - Alif Lam Mim Sad
                'alif lam mim sad': 'المص', 'alef lam mim sad': 'المص',
                'ألف لام ميم صاد': 'المص', 'a l m s': 'المص',
                
                // الر - Alif Lam Ra
                'alif lam ra': 'الر', 'alef lam ra': 'الر', 'alef lam raa': 'الر',
                'ألف لام راء': 'الر', 'a l r': 'الر', 'alr': 'الر',
                
                // المر - Alif Lam Mim Ra
                'alif lam mim ra': 'المر', 'alef lam mim ra': 'المر',
                'ألف لام ميم راء': 'المر', 'a l m r': 'المر',
                
                // كهيعص - Kaf Ha Ya Ain Sad
                'kaf ha ya ain sad': 'كهيعص', 'kaf haa yaa ain sad': 'كهيعص',
                'كاف هاء ياء عين صاد': 'كهيعص', 'k h y a s': 'كهيعص',
                
                // طه - Ta Ha
                'ta ha': 'طه', 'taa ha': 'طه', 'taa haa': 'طه',
                'طاء هاء': 'طه', 'taha': 'طه', 't h': 'طه',
                
                // طسم - Ta Sin Mim
                'ta sin mim': 'طسم', 'taa sin mim': 'طسم', 'taa seen meem': 'طسم',
                'طاء سين ميم': 'طسم', 't s m': 'طسم', 'tsm': 'طسم',
                
                // يس - Ya Sin
                'ya sin': 'يس', 'yaa sin': 'يس', 'yaa seen': 'يس',
                'ياء سين': 'يس', 'yasin': 'يس', 'y s': 'يس',
                
                // ص - Sad
                'sad': 'ص', 'saad': 'ص', 'صاد': 'ص',
                
                // ق - Qaf
                'qaf': 'ق', 'qaaf': 'ق', 'قاف': 'ق',
                
                // ن - Nun
                'nun': 'ن', 'noon': 'ن', 'نون': 'ن',
                
                // حم - Ha Mim
                'ha mim': 'حم', 'haa mim': 'حم', 'ha meem': 'حم',
                'haa meem': 'حم', 'حاء ميم': 'حم',
                'h m': 'حم', 'hm': 'حم'
            };
            
            // ⚡ Real-time exact match checking (highest priority)
            for (const [pronunciation, arabic] of Object.entries(quranicLetterMappings)) {
                if (normalized === pronunciation) {
                    console.log(`✅ Real-time exact Quranic pattern: "${pronunciation}" → "${arabic}"`);
                    this.processSequentialWordUltraFast(arabic);
                    return true;
                }
            }
            
            // 🔍 Enhanced fuzzy matching with real-time optimization
            for (const [pronunciation, arabic] of Object.entries(quranicLetterMappings)) {
                const similarity = this.calculateRealTimeSimilarity(normalized, pronunciation);
                if (similarity >= 0.55) { // Lowered threshold for better capture
                    console.log(`✅ Real-time fuzzy Quranic pattern: "${pronunciation}" → "${arabic}" (${similarity.toFixed(2)})`);
                    this.processSequentialWordUltraFast(arabic);
                    return true;
                }
            }
            
            // 🎆 Partial matching for connected speech
            for (const [pronunciation, arabic] of Object.entries(quranicLetterMappings)) {
                if (normalized.includes(pronunciation) || pronunciation.includes(normalized)) {
                    console.log(`✅ Real-time partial Quranic pattern: "${pronunciation}" → "${arabic}"`);
                    this.processSequentialWordUltraFast(arabic);
                    return true;
                }
            }
            
            return false;
        },
        
        // 🔄 Real-Time Word Sequence Processing
        processWordSequenceRealTime(spokenWords) {
            console.log('🔄 Real-time word sequence processing:', spokenWords);
            
            // ⚡ Parallel processing for multiple words
            const promises = spokenWords.map(word => {
                if (word && word.trim().length > 0) {
                    return this.processSequentialWordUltraFast(word.trim());
                }
            });
            
            // 🔥 Process combined words for connected speech
            if (spokenWords.length > 1) {
                const combined = spokenWords.join('');
                if (combined.length > 2) {
                    this.processSequentialWordUltraFast(combined);
                }
                
                // 🎆 Process variations of combined words
                const spaced = spokenWords.join(' ');
                if (spaced !== combined) {
                    this.processSequentialWordUltraFast(spaced);
                }
            }
            
            return promises;
        },
        
        // 🎯 Enhanced Real-Time Arabic Text Normalization
        normalizeArabicTextRealTime(text) {
            if (!text) return '';
            
            // ⚡ Check cache first for ultra-fast processing
            if (this.normalizationCache && this.normalizationCache.has(text)) {
                return this.normalizationCache.get(text);
            }
            
            const normalized = text
                // 🔥 Remove all diacritics and tashkeel
                .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED\u08F0-\u08FF\u06DF-\u06E8]/g, '')
                // 🎆 Normalize Alif variations
                .replace(/[\u0671\u0623\u0625\u0622]/g, '\u0627')
                // 🔄 Normalize Ta Marbuta
                .replace(/\u0629/g, '\u0647')
                // ⚡ Normalize Ya variations
                .replace(/\u0649/g, '\u064a')
                // 🔥 Remove Tatweel
                .replace(/\u0640/g, '')
                // 🎯 Remove control characters
                .replace(/[\u200C-\u200F\u202A-\u202E]/g, '')
                // 🚀 Normalize whitespace
                .replace(/\s+/g, ' ')
                .trim();
            
            // 🗺️ Cache the result
            if (!this.normalizationCache) {
                this.normalizationCache = new Map();
            }
            this.normalizationCache.set(text, normalized);
            
            return normalized;
        },
        
        // 🔥 Real-Time Multi-Strategy Similarity Calculation
        calculateRealTimeSimilarity(a, b) {
            if (!a || !b) return 0;
            if (a === b) return 1;
            
            // ⚡ Cache check for ultra-fast processing
            const cacheKey = `${a}:${b}`;
            if (this.similarityCache && this.similarityCache.has(cacheKey)) {
                return this.similarityCache.get(cacheKey);
            }
            
            // 🎯 Multiple algorithms with optimized weights for Quranic text
            const levenshtein = this.calculateLevenshteinSimilarity(a, b);
            const jaro = this.calculateJaroSimilarity(a, b);
            const phonetic = this.calculatePhoneticSimilarity(a, b);
            const substring = this.calculateSubstringSimilarity(a, b);
            const quranic = this.calculateQuranicSimilarity(a, b); // New Quranic-specific algorithm
            
            // 🔥 Optimized weights for Quranic recitation
            const weightedScore = (
                levenshtein * 0.3 +    // 30% Exact character matching
                jaro * 0.25 +          // 25% Word structure
                phonetic * 0.25 +      // 25% Sound similarity
                substring * 0.1 +      // 10% Partial matching
                quranic * 0.1          // 10% Quranic-specific patterns
            );
            
            const result = Math.min(1, weightedScore);
            
            // 🗺️ Cache the result
            if (!this.similarityCache) {
                this.similarityCache = new Map();
            }
            this.similarityCache.set(cacheKey, result);
            
            return result;
        },
        
        // 🕌️ New Quranic-Specific Similarity Algorithm
        calculateQuranicSimilarity(a, b) {
            const quranicPatterns = [
                // 🔥 Common Quranic word patterns
                ['الله', 'لله'], // Allah variations
                ['الرحمن', 'رحمن'], // Rahman variations
                ['الرحيم', 'رحيم'], // Raheem variations
                ['بسم', 'باسم'], // Bism variations
                ['إياك', 'اياك'], // Iyyaka variations
            ];
            
            // ⚡ Check if either word matches known Quranic patterns
            for (const [pattern1, pattern2] of quranicPatterns) {
                if ((a.includes(pattern1) || a.includes(pattern2)) && 
                    (b.includes(pattern1) || b.includes(pattern2))) {
                    return 0.9; // High similarity for Quranic pattern matches
                }
            }
            
            // 🎯 Check for common Arabic root patterns
            if (this.shareArabicRoot(a, b)) {
                return 0.7;
            }
            
            return 0;
        },
        
        // 🌱 Arabic Root Pattern Matching
        shareArabicRoot(a, b) {
            if (a.length < 3 || b.length < 3) return false;
            
            // 🔥 Extract potential root letters (simplified)
            const getRootLetters = (word) => {
                return word.replace(/[الويهة]/g, '').substring(0, 3);
            };
            
            const rootA = getRootLetters(a);
            const rootB = getRootLetters(b);
            
            // ⚡ Check if roots share at least 2 letters
            let commonLetters = 0;
            for (let i = 0; i < Math.min(rootA.length, rootB.length); i++) {
                if (rootA[i] === rootB[i]) {
                    commonLetters++;
                }
            }
            
            return commonLetters >= 2;
        },
        
        // 🚀 Real-Time Intelligent Buffering System
        initRealTimeBuffering() {
            this.speechBuffer = {
                interim: [],
                final: [],
                maxSize: 10,
                processingQueue: [],
                isProcessing: false
            };
            
            // ⚡ Start buffer processing loop
            this.startBufferProcessing();
        },
        
        // 🔄 Buffer Processing Loop
        startBufferProcessing() {
            setInterval(() => {
                if (this.speechBuffer && this.speechBuffer.processingQueue.length > 0 && !this.speechBuffer.isProcessing) {
                    this.processBufferQueue();
                }
            }, 50); // Process every 50ms for ultra-responsiveness
        },
        
        // ⚡ Process Buffer Queue
        async processBufferQueue() {
            if (!this.speechBuffer || this.speechBuffer.isProcessing) return;
            
            this.speechBuffer.isProcessing = true;
            
            while (this.speechBuffer.processingQueue.length > 0) {
                const item = this.speechBuffer.processingQueue.shift();
                await this.processQueueItem(item);
            }
            
            this.speechBuffer.isProcessing = false;
        },
        
        // 🎯 Process Individual Queue Item
        async processQueueItem(item) {
            const { transcript, confidence, timestamp } = item;
            
            // 🔥 Skip if too old (prevent processing stale speech)
            if (Date.now() - timestamp > 2000) {
                console.log('⚠️ Skipping stale speech item');
                return;
            }
            
            // ⚡ Process with ultra-fast algorithm
            this.processQuranicSpeechUltraFast(transcript, confidence, timestamp);
        },
        
        // 🔥 Enhanced Real-Time Recognition State Management
        updateRecognitionState(success, processingTime) {
            if (!this.recognitionState) {
                this.recognitionState = {
                    lastProcessingTime: 0,
                    consecutiveMatches: 0,
                    consecutiveFailures: 0,
                    adaptiveThreshold: 0.7,
                    currentAccuracy: 1.0,
                    averageProcessingTime: 0,
                    totalProcessed: 0
                };
            }
            
            this.recognitionState.totalProcessed++;
            this.recognitionState.lastProcessingTime = processingTime;
            
            // 📊 Update average processing time
            this.recognitionState.averageProcessingTime = 
                (this.recognitionState.averageProcessingTime * (this.recognitionState.totalProcessed - 1) + processingTime) / 
                this.recognitionState.totalProcessed;
            
            if (success) {
                this.recognitionState.consecutiveMatches++;
                this.recognitionState.consecutiveFailures = 0;
                
                // 🚀 Lower threshold for better user experience on success
                this.recognitionState.adaptiveThreshold = Math.max(0.5, this.recognitionState.adaptiveThreshold - 0.02);
            } else {
                this.recognitionState.consecutiveFailures++;
                this.recognitionState.consecutiveMatches = 0;
                
                // 🎯 Raise threshold temporarily on failures
                this.recognitionState.adaptiveThreshold = Math.min(0.9, this.recognitionState.adaptiveThreshold + 0.01);
            }
            
            // 📈 Update current accuracy
            const recentSuccesses = Math.max(1, this.recognitionState.consecutiveMatches);
            const recentTotal = recentSuccesses + this.recognitionState.consecutiveFailures;
            this.recognitionState.currentAccuracy = recentSuccesses / recentTotal;
            
            console.log(`📈 Recognition state: ${this.recognitionState.currentAccuracy.toFixed(2)} accuracy, ${this.recognitionState.adaptiveThreshold.toFixed(2)} threshold, ${processingTime.toFixed(0)}ms`);
        },
        
        // 🧠 PHASE 3: Intelligent Caching & Memory Optimization
        
        // 🗺️ Advanced Smart Cache System
        initSmartCaching() {
            // 🚀 Initialize multiple cache layers
            this.cacheSystem = {
                // ⚡ Level 1: Ultra-fast word recognition cache
                wordCache: new Map(),
                // 🎯 Level 2: Pattern recognition cache  
                patternCache: new Map(),
                // 🔥 Level 3: Similarity calculation cache
                similarityCache: new Map(),
                // 🎆 Level 4: Prediction cache
                predictionCache: new Map(),
                // 📊 Cache statistics
                stats: {
                    hits: 0,
                    misses: 0,
                    totalQueries: 0,
                    hitRate: 0
                }
            };
            
            // 🔄 Initialize cache warming
            this.initCacheWarming();
            
            // ⚡ Initialize memory optimization
            this.initMemoryOptimization();
            
            console.log('🧠 Smart caching system initialized with multi-level optimization');
        },
        
        // 🔥 Cache Warming - Pre-load Critical Data
        initCacheWarming() {
            // 🎆 Pre-warm with most common Quranic words
            const criticalWords = [
                // 🕌️ Al-Fatiha (most recited)
                'بسم', 'الله', 'الرحمن', 'الرحيم',
                'الحمد', 'لله', 'رب', 'العالمين',
                'الرحمن', 'الرحيم', 'مالك', 'يوم', 'الدين',
                'إياك', 'نعبد', 'وإياك', 'نستعين',
                'اهدنا', 'الصراط', 'المستقيم',
                'صراط', 'الذين', 'أنعمت', 'عليهم',
                'غير', 'المغضوب', 'عليهم', 'ولا', 'الضالين',
                
                // 📜 Disconnected letters
                'الم', 'المص', 'الر', 'المر', 'كهيعص',
                'طه', 'طسم', 'يس', 'ص', 'ق', 'ن', 'حم',
                
                // 🚀 Common connecting words
                'و', 'في', 'من', 'إلى', 'عن', 'له', 'به',
                'لكم', 'ولكم', 'إن', 'أن', 'لم', 'لن'
            ];
            
            // ⚡ Pre-calculate and cache all variations
            criticalWords.forEach(word => {
                this.warmWordCache(word);
            });
            
            console.log(`🔥 Cache warmed with ${criticalWords.length} critical Quranic words`);
        },
        
        // 🎆 Warm Individual Word Cache
        warmWordCache(word) {
            const variations = {
                original: word,
                normalized: this.normalizeQuranText(word),
                plain: this.convertToPlainText(word),
                pronunciation: this.generatePronunciationVariations(word),
                roots: this.extractArabicRoots(word),
                phonetic: this.getArabicPhoneticCode(word)
            };
            
            // 🗺️ Cache all variations for ultra-fast lookup
            this.cacheSystem.wordCache.set(word, variations);
            this.cacheSystem.wordCache.set(variations.normalized, variations);
            this.cacheSystem.wordCache.set(variations.plain, variations);
            
            // 🔥 Cache pronunciation variations
            variations.pronunciation.forEach(variation => {
                this.cacheSystem.wordCache.set(variation, variations);
            });
        },
        
        // 🌱 Generate Pronunciation Variations
        generatePronunciationVariations(word) {
            const variations = new Set();
            const normalized = this.normalizeQuranText(word);
            
            // 🔥 Add common Arabic pronunciation patterns
            variations.add(normalized);
            
            // ⚡ Handle definite article variations
            if (normalized.startsWith('ال')) {
                variations.add(normalized.replace('ال', 'ل'));
                variations.add(normalized.substring(2)); // Remove ال completely
            }
            
            // 🎯 Handle ta marbuta variations
            if (normalized.endsWith('ه')) {
                variations.add(normalized.slice(0, -1) + 'ة');
            }
            if (normalized.endsWith('ة')) {
                variations.add(normalized.slice(0, -1) + 'ه');
            }
            
            // 🚀 Handle ya variations
            if (normalized.endsWith('ي')) {
                variations.add(normalized.slice(0, -1) + 'ى');
            }
            if (normalized.endsWith('ى')) {
                variations.add(normalized.slice(0, -1) + 'ي');
            }
            
            // 🎆 Handle hamza variations
            variations.add(normalized.replace(/[أإآ]/g, 'ا'));
            
            // 🔄 Handle doubled letters
            variations.add(normalized.replace(/(.)(\1+)/g, '$1'));
            
            return Array.from(variations);
        },
        
        // 🌱 Extract Arabic Roots
        extractArabicRoots(word) {
            const normalized = this.normalizeQuranText(word);
            const roots = [];
            
            // 🔥 Remove common prefixes and suffixes
            let root = normalized
                .replace(/^(ال|بال|وال|فال|لل)/g, '') // Remove definite articles
                .replace(/(ها|هم|هن|ه|ة|ون|ين|ان|تين|تان)$/g, '') // Remove suffixes
                .replace(/^(م|ي|ت|ن|ا)/g, ''); // Remove common prefixes
            
            // ⚡ Extract 3-letter root (most common in Arabic)
            if (root.length >= 3) {
                roots.push(root.substring(0, 3));
            }
            
            // 🎯 Extract 4-letter root if applicable
            if (root.length >= 4) {
                roots.push(root.substring(0, 4));
            }
            
            return roots;
        },
        
        // ⚡ Memory Optimization System
        initMemoryOptimization() {
            // 🔄 Set cache size limits
            this.cacheSystem.maxSizes = {
                wordCache: 1000,        // Top 1000 most used words
                patternCache: 200,      // Top 200 patterns
                similarityCache: 500,   // Top 500 similarity calculations
                predictionCache: 100    // Top 100 predictions
            };
            
            // 📊 Initialize cache monitoring
            this.startCacheMonitoring();
            
            // 🚀 Setup automatic cache cleanup
            this.setupCacheCleanup();
            
            console.log('⚡ Memory optimization system initialized');
        },
        
        // 📊 Cache Performance Monitoring
        startCacheMonitoring() {
            setInterval(() => {
                this.analyzeCachePerformance();
            }, 30000); // Monitor every 30 seconds
        },
        
        // 🗺️ Analyze Cache Performance
        analyzeCachePerformance() {
            const stats = this.cacheSystem.stats;
            stats.hitRate = stats.totalQueries > 0 ? (stats.hits / stats.totalQueries) * 100 : 0;
            
            console.log(`📊 Cache Performance: ${stats.hitRate.toFixed(1)}% hit rate (${stats.hits}/${stats.totalQueries})`);
            
            // 🚀 Optimize cache if hit rate is low
            if (stats.hitRate < 70 && stats.totalQueries > 50) {
                this.optimizeCacheStrategy();
            }
            
            // 🔄 Reset stats periodically
            if (stats.totalQueries > 1000) {
                stats.hits = Math.floor(stats.hits * 0.8);
                stats.misses = Math.floor(stats.misses * 0.8);
                stats.totalQueries = Math.floor(stats.totalQueries * 0.8);
            }
        },
        
        // 🔥 Optimize Cache Strategy
        optimizeCacheStrategy() {
            console.log('🔥 Optimizing cache strategy for better performance');
            
            // ⚡ Pre-load more common words based on current memorization
            if (state.currentMemorizationWords && state.currentMemorizationWords.length > 0) {
                state.currentMemorizationWords.forEach(word => {
                    this.warmWordCache(word);
                });
            }
            
            // 🎯 Warm cache with next likely words
            this.predictAndCacheNextWords();
        },
        
        // 🔍 Predict and Cache Next Words
        predictAndCacheNextWords() {
            if (!state.currentMemorizationWords || state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                return;
            }
            
            // ⚡ Cache next 5 words for ultra-fast access
            const nextWords = state.currentMemorizationWords.slice(
                state.memorizationStats.currentWordIndex,
                state.memorizationStats.currentWordIndex + 5
            );
            
            nextWords.forEach(word => {
                this.warmWordCache(word);
            });
            
            console.log(`🔍 Pre-cached next ${nextWords.length} words for prediction`);
        },
        
        // 🔄 Smart Cache Cleanup
        setupCacheCleanup() {
            setInterval(() => {
                this.cleanupCaches();
            }, 60000); // Cleanup every minute
        },
        
        // 🧹 Cleanup Caches
        cleanupCaches() {
            // 🗺️ Track cache usage
            const cacheUsage = {
                wordCache: this.cacheSystem.wordCache.size,
                patternCache: this.cacheSystem.patternCache.size,
                similarityCache: this.cacheSystem.similarityCache.size
            };
            
            // 🔥 Clean similarity cache if too large
            if (this.cacheSystem.similarityCache.size > this.cacheSystem.maxSizes.similarityCache) {
                const entries = Array.from(this.cacheSystem.similarityCache.entries());
                // Keep most recent 60%
                const keepCount = Math.floor(entries.length * 0.6);
                this.cacheSystem.similarityCache.clear();
                entries.slice(-keepCount).forEach(([key, value]) => {
                    this.cacheSystem.similarityCache.set(key, value);
                });
            }
            
            // ⚡ Clean pattern cache if too large
            if (this.cacheSystem.patternCache.size > this.cacheSystem.maxSizes.patternCache) {
                const entries = Array.from(this.cacheSystem.patternCache.entries());
                const keepCount = Math.floor(entries.length * 0.7);
                this.cacheSystem.patternCache.clear();
                entries.slice(-keepCount).forEach(([key, value]) => {
                    this.cacheSystem.patternCache.set(key, value);
                });
            }
            
            console.log(`🧹 Cache cleanup: Word:${cacheUsage.wordCache}, Pattern:${cacheUsage.patternCache}, Similarity:${cacheUsage.similarityCache}`);
        },
        
        // 🚀 Ultra-Fast Cached Word Lookup
        getCachedWordData(word) {
            this.cacheSystem.stats.totalQueries++;
            
            // ⚡ Check direct cache hit
            if (this.cacheSystem.wordCache.has(word)) {
                this.cacheSystem.stats.hits++;
                return this.cacheSystem.wordCache.get(word);
            }
            
            // 🔍 Check normalized version
            const normalized = this.normalizeQuranText(word);
            if (this.cacheSystem.wordCache.has(normalized)) {
                this.cacheSystem.stats.hits++;
                return this.cacheSystem.wordCache.get(normalized);
            }
            
            // 🎯 Check plain text version
            const plain = this.convertToPlainText(word);
            if (this.cacheSystem.wordCache.has(plain)) {
                this.cacheSystem.stats.hits++;
                return this.cacheSystem.wordCache.get(plain);
            }
            
            this.cacheSystem.stats.misses++;
            return null;
        },
        
        // 🎆 Advanced Predictive Caching
        initPredictiveCaching() {
            // 🔥 Predict based on current memorization progress
            if (state.currentMemorizationWords) {
                this.predictMemorizationFlow();
            }
            
            // ⚡ Predict based on common recitation patterns
            this.predictCommonPatterns();
            
            console.log('🎆 Predictive caching initialized');
        },
        
        // 🔍 Predict Memorization Flow
        predictMemorizationFlow() {
            const currentIndex = state.memorizationStats.currentWordIndex;
            const words = state.currentMemorizationWords;
            
            if (!words || currentIndex >= words.length) return;
            
            // ⚡ Predict next 10 words with high probability
            for (let i = currentIndex; i < Math.min(currentIndex + 10, words.length); i++) {
                const word = words[i];
                const probability = Math.max(0.1, 1 - (i - currentIndex) * 0.1);
                
                this.cacheSystem.predictionCache.set(word, {
                    word: word,
                    probability: probability,
                    timestamp: Date.now(),
                    cached: true
                });
                
                // 🚀 Pre-warm cache for high-probability words
                if (probability > 0.7) {
                    this.warmWordCache(word);
                }
            }
        },
        
        // 🎯 Predict Common Patterns
        predictCommonPatterns() {
            const commonTransitions = [
                ['بسم', 'الله'],
                ['الله', 'الرحمن'],
                ['الرحمن', 'الرحيم'],
                ['الحمد', 'لله'],
                ['لله', 'رب'],
                ['رب', 'العالمين']
            ];
            
            // ⚡ Cache common word transitions
            commonTransitions.forEach(([word1, word2]) => {
                if (this.cacheSystem.wordCache.has(word1)) {
                    this.warmWordCache(word2);
                }
            });
        },
        
        processSpeechResult(transcript, confidence) {
            console.log(`Processing speech result: "${transcript}" with confidence: ${confidence}`);
            
            // Update last heard display
            const lastHeardEl = document.getElementById('last-heard-word');
            if (lastHeardEl) {
                lastHeardEl.textContent = transcript;
            }
            
            // Use the enhanced Quranic speech processing
            this.processQuranicSpeech(transcript, confidence);
        },
        
        // Simplified and optimized Quranic speech processing
        processQuranicSpeech(transcript, confidence) {
            console.log(`Processing Quranic speech: "${transcript}" with confidence: ${confidence}`);
            
            // Update display immediately
            const lastHeardEl = document.getElementById('last-heard-word');
            if (lastHeardEl) {
                lastHeardEl.textContent = transcript;
            }
            
            // First, try special Quranic patterns (like الم, يس, etc.)
            if (this.processSpecialQuranicPatterns(transcript)) {
                return; // Success with special pattern
            }
            
            // Process as normal words with enhanced cleaning
            const words = this.parseQuranicSpeech(transcript);
            
            // Try each parsed word
            words.forEach(word => {
                if (word && word.trim().length > 0) {
                    this.processSequentialWord(word.trim());
                }
            });
            
            // Also try the full cleaned transcript
            const fullCleaned = this.cleanQuranicText(transcript);
            if (fullCleaned && fullCleaned.length > 0) {
                this.processSequentialWord(fullCleaned);
            }
        },
        
        // Simplified Quranic speech parsing
        parseQuranicSpeech(transcript) {
            const words = [];
            
            // Split by spaces and clean each word
            const segments = transcript.split(/\s+/);
            
            segments.forEach(segment => {
                const cleaned = segment.trim();
                if (cleaned.length === 0) return;
                
                // First try individual letter parsing for special cases
                const letterWords = this.parseQuranicLetters(cleaned);
                if (letterWords.length > 0) {
                    words.push(...letterWords);
                }
                
                // Always also try as a regular word
                const cleanedWord = this.cleanQuranicText(cleaned);
                if (cleanedWord && cleanedWord.length > 0) {
                    words.push(cleanedWord);
                }
            });
            
            // If no words found, try the whole transcript as one word
            if (words.length === 0) {
                const wholeCleaned = this.cleanQuranicText(transcript);
                if (wholeCleaned) {
                    words.push(wholeCleaned);
                }
            }
            
            return words;
        },
        
        // Advanced Quranic text cleaning with multiple normalization strategies
        cleanQuranicText(text) {
            if (!text) return '';
            
            let cleaned = text
                // Remove diacritics but preserve structure
                .replace(/[\u064B-\u065F\u0670\u06D6-\u06ED\u08F0-\u08FF]/g, '')
                // Remove tatweel
                .replace(/\u0640/g, '')
                // Advanced Alif normalization
                .replace(/[\u0622\u0623\u0625\u0671]/g, '\u0627') // آ أ إ ٱ → ا
                // Ta Marbuta handling
                .replace(/\u0629/g, '\u0647') // ة → ه
                // Ya variations
                .replace(/\u0649/g, '\u064A') // ى → ي
                // Waw variations
                .replace(/\u0624/g, '\u0648') // ؤ → و
                // Ya Hamza
                .replace(/\u0626/g, '\u064A') // ئ → ي
                .trim();
            
            // Additional Quranic-specific normalizations
            cleaned = this.normalizeQuranicVariations(cleaned);
            
            return cleaned;
        },
        
        // Advanced Quranic text variations normalization
        normalizeQuranicVariations(text) {
            return text
                // Common Quranic word variations
                .replace(/الرحمان/g, 'الرحمن') // الرحمان → الرحمن
                .replace(/الصلاة/g, 'الصلوة') // Handle prayer variations
                .replace(/الزكاة/g, 'الزكوة') // Handle zakat variations
                // Numbers in Arabic
                .replace(/١/g, '1').replace(/٢/g, '2').replace(/٣/g, '3')
                .replace(/٤/g, '4').replace(/٥/g, '5').replace(/٦/g, '6')
                .replace(/٧/g, '7').replace(/٨/g, '8').replace(/٩/g, '9').replace(/٠/g, '0')
                // Remove extra spaces
                .replace(/\s+/g, ' ')
                .trim();
        },
        
        // Enhanced special Quranic patterns with comprehensive mappings
        processSpecialQuranicPatterns(transcript) {
            const normalized = transcript.toLowerCase().trim();
            
            // Comprehensive map of Quranic disconnected letters with multiple pronunciations
            const quranicLetterMappings = {
                // الم - Alif Lam Mim (multiple variations)
                'alif lam mim': 'الم', 'alef lam mim': 'الم', 'alf lam mim': 'الم',
                'alif lam meem': 'الم', 'alef lam meem': 'الم', 'alf lam meem': 'الم',
                'ألف لام ميم': 'الم', 'الف لام ميم': 'الم',
                'a l m': 'الم', 'a.l.m': 'الم', 'alm': 'الم',
                
                // المص - Alif Lam Mim Sad
                'alif lam mim sad': 'المص', 'alef lam mim sad': 'المص',
                'alif lam meem sad': 'المص', 'alef lam meem sad': 'المص',
                'ألف لام ميم صاد': 'المص',
                'a l m s': 'المص', 'alms': 'المص',
                
                // الر - Alif Lam Ra
                'alif lam ra': 'الر', 'alef lam ra': 'الر', 'alf lam ra': 'الر',
                'alif lam raa': 'الر', 'alef lam raa': 'الر',
                'ألف لام راء': 'الر', 'الف لام را': 'الر',
                'a l r': 'الر', 'alr': 'الر',
                
                // المر - Alif Lam Mim Ra
                'alif lam mim ra': 'المر', 'alef lam mim ra': 'المر',
                'alif lam meem ra': 'المر', 'alef lam meem ra': 'المر',
                'ألف لام ميم راء': 'المر',
                'a l m r': 'المر', 'almr': 'المر',
                
                // كهيعص - Kaf Ha Ya Ain Sad
                'kaf ha ya ain sad': 'كهيعص', 'kaf haa yaa ain sad': 'كهيعص',
                'كاف هاء ياء عين صاد': 'كهيعص',
                'k h y a s': 'كهيعص', 'khyas': 'كهيعص',
                
                // طه - Ta Ha
                'ta ha': 'طه', 'taha': 'طه', 'ta haa': 'طه',
                'taa ha': 'طه', 'taa haa': 'طه',
                'طاء هاء': 'طه', 'طا ها': 'طه',
                't h': 'طه', 'th': 'طه',
                
                // طسم - Ta Sin Mim
                'ta sin mim': 'طسم', 'taa sin mim': 'طسم',
                'ta seen mim': 'طسم', 'taa seen mim': 'طسم',
                'طاء سين ميم': 'طسم',
                't s m': 'طسم', 'tsm': 'طسم',
                
                // يس - Ya Sin
                'ya sin': 'يس', 'yaa sin': 'يس', 'ya seen': 'يس',
                'yaa seen': 'يس', 'yasin': 'يس', 'yaseen': 'يس',
                'ياء سين': 'يس', 'يا سين': 'يس',
                'y s': 'يس', 'ys': 'يس',
                
                // ص - Sad
                'sad': 'ص', 'saad': 'ص', 'صاد': 'ص', 's': 'ص',
                
                // ق - Qaf
                'qaf': 'ق', 'qaaf': 'ق', 'قاف': 'ق', 'q': 'ق',
                
                // ن - Nun
                'nun': 'ن', 'noon': 'ن', 'نون': 'ن', 'n': 'ن',
                
                // حم - Ha Mim
                'ha mim': 'حم', 'haa mim': 'حم', 'ha meem': 'حم',
                'haa meem': 'حم', 'حاء ميم': 'حم',
                'h m': 'حم', 'hm': 'حم'
            };
            
            // Check for exact matches first (highest accuracy)
            for (const [pronunciation, arabic] of Object.entries(quranicLetterMappings)) {
                if (normalized === pronunciation) {
                    console.log(`✅ Exact Quranic pattern match: "${pronunciation}" → "${arabic}"`);
                    this.processSequentialWord(arabic);
                    return true;
                }
            }
            
            // Check for fuzzy matches with enhanced accuracy
            for (const [pronunciation, arabic] of Object.entries(quranicLetterMappings)) {
                const similarity = this.calculateAdvancedSimilarity(normalized, pronunciation);
                if (similarity >= 0.6) { // Higher threshold for special patterns
                    console.log(`✅ Fuzzy Quranic pattern match: "${pronunciation}" → "${arabic}" (similarity: ${similarity.toFixed(2)})`);
                    this.processSequentialWord(arabic);
                    return true;
                }
            }
            
            // Check for partial matches in the transcript
            for (const [pronunciation, arabic] of Object.entries(quranicLetterMappings)) {
                if (normalized.includes(pronunciation) || pronunciation.includes(normalized)) {
                    console.log(`✅ Partial Quranic pattern match: "${pronunciation}" → "${arabic}"`);
                    this.processSequentialWord(arabic);
                    return true;
                }
            }
            
            return false; // No special pattern found
        },
        
        // Parse individual Quranic letters from speech
        parseQuranicLetters(speech) {
            const words = [];
            const normalized = speech.toLowerCase().trim();
            
            // Individual letter mappings
            const letterMappings = {
                'alif': 'ا', 'alef': 'ا', 'ألف': 'ا',
                'ba': 'ب', 'baa': 'ب', 'باء': 'ب',
                'ta': 'ت', 'taa': 'ت', 'تاء': 'ت',
                'tha': 'ث', 'thaa': 'ث', 'ثاء': 'ث',
                'jim': 'ج', 'jeem': 'ج', 'جيم': 'ج',
                'ha': 'ح', 'haa': 'ح', 'حاء': 'ح',
                'kha': 'خ', 'khaa': 'خ', 'خاء': 'خ',
                'dal': 'د', 'دال': 'د',
                'thal': 'ذ', 'zal': 'ذ', 'ذال': 'ذ',
                'ra': 'ر', 'raa': 'ر', 'راء': 'ر',
                'zay': 'ز', 'za': 'ز', 'زاي': 'ز',
                'sin': 'س', 'seen': 'س', 'سين': 'س',
                'shin': 'ش', 'sheen': 'ش', 'شين': 'ش',
                'sad': 'ص', 'صاد': 'ص',
                'dad': 'ض', 'daad': 'ض', 'ضاد': 'ض',
                'taa': 'ط', 'طاء': 'ط',
                'zaa': 'ظ', 'ظاء': 'ظ',
                'ain': 'ع', 'عين': 'ع',
                'ghain': 'غ', 'غين': 'غ',
                'fa': 'ف', 'faa': 'ف', 'فاء': 'ف',
                'qaf': 'ق', 'قاف': 'ق',
                'kaf': 'ك', 'كاف': 'ك',
                'lam': 'ل', 'لام': 'ل',
                'mim': 'م', 'meem': 'م', 'ميم': 'م',
                'nun': 'ن', 'noon': 'ن', 'نون': 'ن',
                'ha': 'ه', 'haa': 'ه', 'هاء': 'ه',
                'waw': 'و', 'واو': 'و',
                'ya': 'ي', 'yaa': 'ي', 'ياء': 'ي'
            };
            
            // Check if speech contains individual letter names
            for (const [letterName, arabic] of Object.entries(letterMappings)) {
                if (normalized.includes(letterName)) {
                    words.push(arabic);
                }
            }
            
            return words;
        },
        
        // Enhanced sequence processing for fast recitation
        processWordSequence(spokenWords) {
            console.log('Processing word sequence:', spokenWords);
            
            // Try to match each word in sequence
            spokenWords.forEach(word => {
                if (word && word.trim().length > 0) {
                    this.processSequentialWord(word.trim());
                }
            });
            
            // Also try to match combined words for connected speech
            if (spokenWords.length > 1) {
                const combined = spokenWords.join('');
                if (combined.length > 2) {
                    this.processSequentialWord(combined);
                }
            }
        },
        
        // Show interim feedback for better user experience
        showInterimFeedback(transcript) {
            const feedbackEl = document.getElementById('speech-interim-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = transcript;
                feedbackEl.style.opacity = '0.7';
                
                // Clear after a short time if no final result
                clearTimeout(this.interimFeedbackTimeout);
                this.interimFeedbackTimeout = setTimeout(() => {
                    feedbackEl.style.opacity = '0.3';
                }, 1000);
            }
        },
        
        // Ultra-responsive sequential word processing
        processSequentialWord(spokenWord) {
            // Very short duplicate filtering for maximum responsiveness
            const now = Date.now();
            if (this.lastProcessedWord && this.lastProcessedWord.word === spokenWord && 
                (now - this.lastProcessedWord.time) < 200) { // Reduced to 200ms for maximum responsiveness
                console.log('Skipping very recent duplicate word:', spokenWord);
                return;
            }
            
            this.lastProcessedWord = { word: spokenWord, time: now };
            
            // Process the word immediately
            this.checkSingleWord(spokenWord);
        },
        
        // مقارنة رئيسية للكلمات (يستخدم التجويد)
        compareWords(spoken, correct) {
            return this.compareWordsTajweed(spoken, correct);
        },
        
        checkSingleWord(spokenWord) {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                // انتهى الحفظ
                this.completeMemorization();
                return;
            }
            
            const currentWordIndex = state.memorizationStats.currentWordIndex;
            const correctWord = state.currentMemorizationWords[currentWordIndex];
            const wordElements = document.querySelectorAll('.ayah-word');
            const currentElement = wordElements[currentWordIndex];
            
            console.log(`Checking: "${spokenWord}" vs "${correctWord}"`);
            
            // مقارنة الكلمات باستخدام التجويد المحسّن
            const isCorrect = this.compareWordsTajweed(spokenWord, correctWord);
            
            // تحديث معلومات التشخيص
            this.updateDebugInfo(spokenWord, isCorrect);
            
            // تحديث: دعم الواجهة المنفصلة
            const isMemorizationInterface = !document.getElementById('memorization-interface').classList.contains('hidden');
            if (isMemorizationInterface) {
                const memorizationWords = document.querySelectorAll('#memorization-page-content .ayah-word');
                const memCurrentElement = memorizationWords[currentWordIndex];
                if (memCurrentElement) {
                    // استخدام عناصر واجهة الحفظ
                    const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
                    memWordElements.forEach(el => {
                        el.classList.remove('waiting', 'current');
                    });
                    
                    if (isCorrect) {
                        memCurrentElement.classList.remove('hidden', 'incorrect');
                        memCurrentElement.classList.add('revealed');
                        
                        if (state.memorizationStats.currentWordIndex < memWordElements.length) {
                            setTimeout(() => {
                                memWordElements[state.memorizationStats.currentWordIndex].classList.add('waiting');
                            }, 500);
                        }
                    } else {
                        if (state.memorizationSettings.autoRepeat) {
                            memCurrentElement.classList.remove('hidden');
                            memCurrentElement.classList.add('incorrect');
                            setTimeout(() => {
                                memCurrentElement.classList.add('hidden');
                                memCurrentElement.classList.remove('incorrect');
                                memCurrentElement.classList.add('waiting');
                            }, 2000);
                        } else {
                            memCurrentElement.classList.add('waiting');
                        }
                    }
                    
                    // تحديث عرض التقدم
                    this.updateMemorizationProgressDisplay();
                }
            }
            
            if (!currentElement) {
                console.log('No current element found');
                return;
            }
            
            // إزالة جميع الحالات السابقة
            wordElements.forEach(el => {
                el.classList.remove('waiting', 'current');
            });
            
            if (isCorrect) {
                // كلمة صحيحة - إظهارها فوراً مع المحافظة على النص القرآني
                currentElement.classList.remove('hidden', 'incorrect', 'waiting');
                currentElement.classList.add('revealed');
                
                state.memorizationStats.correctWords++;
                state.memorizationStats.currentWordIndex++;
                
                // تشغيل صوت نجاح
                if (state.memorizationSettings.soundAlerts) {
                    this.playSuccessSound();
                }
                
                // تحضير الكلمة التالية
                if (state.memorizationStats.currentWordIndex < wordElements.length) {
                    setTimeout(() => {
                        wordElements[state.memorizationStats.currentWordIndex].classList.add('waiting');
                    }, 100);
                }
                
                console.log(`Word "${spokenWord}" is CORRECT!`);
            } else {
                // كلمة خاطئة
                state.memorizationStats.incorrectWords++;
                
                // عرض الخطأ مع الكلمة الصحيحة
                const error = {
                    spoken: spokenWord,
                    correct: correctWord,
                    index: currentWordIndex
                };
                state.memorizationStats.errors.push(error);
                
                // تشغيل صوت خطأ
                if (state.memorizationSettings.soundAlerts) {
                    this.playErrorSound();
                }
                
                // عرض الخطأ
                this.showError(error);
                
                // عرض الكلمة الصحيحة لفترة قصيرة إذا كان مفعّل
                if (state.memorizationSettings.autoRepeat) {
                    // إظهار الكلمة الصحيحة لثانيتين
                    currentElement.classList.remove('hidden');
                    currentElement.classList.add('incorrect');
                    
                    setTimeout(() => {
                        currentElement.classList.add('hidden');
                        currentElement.classList.remove('incorrect');
                        currentElement.classList.add('waiting');
                    }, 2000);
                } else {
                    currentElement.classList.add('waiting');
                }
                
                console.log(`Word "${spokenWord}" is INCORRECT. Expected: "${correctWord}"`);
            }
            
            // تحديث العرض
            this.updateMemorizationDisplay();
            // Debug info already updated above with comparison result
        },
        
        normalizeTajweed(text) {
            // تطبيع محسّن للتجويد - يحافظ على الاختلافات المهمة
            return text
                // إزالة التشكيل الفرعي مع المحافظة على المهم
                .replace(/[\u064B\u064C\u064D\u064E\u064F\u0650\u0651\u0652]/g, '') // تنوين وحركات
                .replace(/[\u0653\u0654\u0655\u0656\u0657\u0658\u0659\u065A]/g, '') // علامات إضافية
                .replace(/[\u065B\u065C\u065D\u065E\u065F]/g, '') // علامات أخرى
                .replace(/\u0640/g, '') // تطويل
                .replace(/[\u06D6-\u06ED]/g, '') // علامات الوقف
                // المحافظة على الألف الخنجرية لكن مع مرونة
                .replace(/\u0670/g, 'ا') // ألف خنجرية → ألف
                // توحيد أشكال الهمزة مع مراعاة النطق
                .replace(/[\u0622\u0623\u0625]/g, 'ا') // آ أ إ → ا
                .replace(/\u0624/g, 'و') // ؤ → و
                .replace(/\u0626/g, 'ي') // ئ → ي
                // توحيد التاء والهاء
                .replace(/\u0629/g, 'ه') // ة → ه
                // توحيد أشكال الياء
                .replace(/\u0649/g, 'ي') // ى → ي
                // تنظيف عام
                .replace(/[\u200C\u200D\u200E\u200F]/g, '') // إزالة أحرف التحكم
                .trim()
                .replace(/\s+/g, ' ')
                .toLowerCase();
        },
        
        // Convert Quranic text with diacritics to plain Arabic text
        convertToPlainText(quranicText) {
            return quranicText
                // Remove all diacritical marks
                .replace(/[\u064B-\u0652\u0670\u0653-\u065F]/g, '') // Remove tashkeel
                .replace(/\u0640/g, '') // Remove tatweel (elongation)
                .replace(/[\u06D6-\u06ED]/g, '') // Remove Quranic punctuation
                .replace(/[\u08F0-\u08FF]/g, '') // Remove additional Arabic marks
                
                // Normalize different forms of the same letter
                .replace(/[\u0622\u0623\u0625]/g, 'ا') // آ أ إ → ا
                .replace(/\u0624/g, 'و') // ؤ → و  
                .replace(/\u0626/g, 'ي') // ئ → ي
                .replace(/\u0629/g, 'ة') // Keep ة as ة for display
                .replace(/[\u0649\u064A]/g, 'ي') // ى ي → ي
                
                // Handle special Quranic cases
                .replace(/\u0671/g, 'ا') // ٱ → ا (Alif wasla)
                .replace(/[\u06C0\u06C1]/g, 'ه') // Different heh forms
                
                // Clean up spaces and control characters
                .replace(/[\u200C\u200D\u200E\u200F]/g, '') // Remove invisible characters
                .trim();
        },
        
        // Check if a string contains actual Arabic words (not just diacritics or punctuation)
        isActualWord(text) {
            // Must contain at least one Arabic letter
            const hasArabicLetter = /[\u0621-\u063A\u0641-\u064A]/g.test(text);
            // Must not be just punctuation or very short
            const isNotJustPunctuation = text.length > 0 && !/^[\s\u06D6-\u06ED\u064B-\u0652]*$/.test(text);
            return hasArabicLetter && isNotJustPunctuation;
        },
        
        // Enhanced Arabic text normalization for better Quranic recitation recognition
        normalizeQuranText(text) {
            // Comprehensive normalization specifically for Quranic text
            return text
                // Remove all diacritical marks but preserve structure
                .replace(/[\u064B-\u0652\u0670\u0653-\u065F]/g, '') // Remove tashkeel
                .replace(/\u0640/g, '') // Remove tatweel (elongation)
                .replace(/[\u06D6-\u06ED]/g, '') // Remove Quranic punctuation
                .replace(/[\u08F0-\u08FF]/g, '') // Remove additional Arabic marks
                
                // Normalize different forms of the same letter
                .replace(/[\u0622\u0623\u0625]/g, 'ا') // آ أ إ → ا
                .replace(/\u0624/g, 'و') // ؤ → و  
                .replace(/\u0626/g, 'ي') // ئ → ي
                .replace(/\u0629/g, 'ه') // ة → ه
                .replace(/[\u0649\u064A]/g, 'ي') // ى ي → ي
                
                // Handle special Quranic cases
                .replace(/\u0671/g, 'ا') // ٱ → ا (Alif wasla)
                .replace(/[\u06C0\u06C1]/g, 'ه') // Different heh forms
                
                // Clean up spaces and control characters
                .replace(/[\u200C\u200D\u200E\u200F]/g, '') // Remove invisible characters
                .replace(/\s+/g, ' ') // Normalize spaces
                .trim()
                .toLowerCase();
        },
        
        // 🎯 Simplified and Enhanced Comparison Logic
        compareWordsTajweed(spoken, correct, confidence = 1.0) {
            // 1. Unified normalization approach - single powerful function
            const normalizedSpoken = this.normalizeArabicText(spoken);
            const normalizedCorrect = this.normalizeArabicText(correct);
            
            console.log(`🔍 Comparing: "${spoken}" vs "${correct}"`);
            console.log(`📝 Normalized: "${normalizedSpoken}" vs "${normalizedCorrect}"`);
            
            // 2. Direct exact match (highest accuracy)
            if (normalizedSpoken === normalizedCorrect) {
                console.log('✅ Exact normalized match');
                return true;
            }
            
            // 3. Sequence matching for connected speech
            if (this.isSequenceMatch(normalizedSpoken, normalizedCorrect)) {
                console.log('✅ Sequence match found');
                return true;
            }
            
            // 4. Prefix matching for partial speech
            if (this.isPrefixMatch(normalizedSpoken, normalizedCorrect)) {
                console.log('✅ Prefix match found');
                return true;
            }
            
            // 5. Intelligent similarity with dynamic threshold
            const similarity = this.calculateSimilarity(normalizedSpoken, normalizedCorrect);
            const threshold = this.getAdaptiveThreshold(normalizedCorrect.length, confidence);
            
            console.log(`📊 Similarity: ${similarity.toFixed(3)}, Threshold: ${threshold.toFixed(3)}`);
            
            if (similarity >= threshold) {
                console.log('✅ Similarity match');
                return true;
            }
            
            console.log('❌ No match found');
            return false;
        },
        
        // 🔗 Sequence Matching for Connected Speech
        isSequenceMatch(spoken, correct) {
            // Handle cases where user combines words or speaks continuously
            const spokenLength = spoken.length;
            const correctLength = correct.length;
            
            // Check if spoken text appears at the beginning of expected sequence
            if (spokenLength >= 2 && correctLength >= 2) {
                if (correct.startsWith(spoken) || spoken.startsWith(correct)) {
                    return true;
                }
                
                // Check for core overlap (60% or more)
                const minLength = Math.min(spokenLength, correctLength);
                const overlapLength = Math.floor(minLength * 0.6);
                
                if (overlapLength >= 2) {
                    const spokenCore = spoken.substring(0, overlapLength);
                    const correctCore = correct.substring(0, overlapLength);
                    
                    if (spokenCore === correctCore) {
                        return true;
                    }
                }
            }
            
            return false;
        },
        
        // 📍 Prefix Matching for Partial Speech
        isPrefixMatch(spoken, correct) {
            const minLength = Math.min(spoken.length, correct.length);
            
            // Require at least 2 characters for meaningful prefix
            if (minLength >= 2) {
                // Check if one is a prefix of the other
                if (spoken.length <= correct.length) {
                    return correct.startsWith(spoken);
                } else {
                    return spoken.startsWith(correct);
                }
            }
            
            return false;
        },
        
        // 🎯 Adaptive Threshold Based on Word Length and Confidence
        getAdaptiveThreshold(wordLength, confidence) {
            let baseThreshold = 0.7;
            
            // Adjust based on word length
            if (wordLength <= 2) {
                baseThreshold = 0.8; // Stricter for short words
            } else if (wordLength <= 4) {
                baseThreshold = 0.7; // Standard for medium words  
            } else {
                baseThreshold = 0.6; // More lenient for long words
            }
            
            // Adjust based on speech recognition confidence
            const confidenceBonus = (confidence - 0.5) * 0.2;
            baseThreshold = Math.max(0.4, Math.min(0.9, baseThreshold + confidenceBonus));
            
            return baseThreshold;
        },
        
        // 🎯 Evaluate Transcript Quality for Best Alternative Selection
        evaluateTranscriptQuality(transcript, confidence) {
            const normalized = this.normalizeArabicText(transcript);
            let score = confidence * 0.6; // Base confidence weight
            
            // Bonus for Arabic content
            const arabicRatio = (transcript.match(/[ء-غف-ي]/g) || []).length / transcript.length;
            score += arabicRatio * 0.2;
            
            // Bonus for reasonable length
            if (normalized.length >= 2 && normalized.length <= 10) {
                score += 0.1;
            }
            
            // Bonus if it matches common Quranic patterns
            if (this.isLikelyQuranicWord(normalized)) {
                score += 0.1;
            }
            
            return score;
        },
        
        // 🔍 Check if word is likely Quranic
        isLikelyQuranicWord(word) {
            const commonQuranicWords = [
                'الله', 'الرحمن', 'الرحيم', 'رب', 'العالمين',
                'الحمد', 'مالك', 'يوم', 'الدين', 'إياك',
                'نعبد', 'نستعين', 'اهدنا', 'الصراط',
                'المستقيم', 'الذين', 'انعمت', 'عليهم',
                'بسم', 'ولا', 'ليس', 'الضالين'
            ];
            
            // Check exact match or prefix match
            return commonQuranicWords.some(qWord => 
                qWord === word || qWord.startsWith(word) || word.startsWith(qWord)
            );
        },
        
        // 🔗 Process Sequential Text (Improved from word-by-word)
        processSequentialText(transcript, confidence, processingStart) {
            console.log(`🔗 Sequential processing: "${transcript}" with confidence: ${confidence}`);
            
            // Update display immediately
            const lastHeardEl = document.getElementById('last-heard-word');
            if (lastHeardEl) {
                lastHeardEl.textContent = transcript;
            }
            
            // 🎯 First check for special Quranic patterns
            if (this.processSpecialQuranicPatterns(transcript)) {
                console.log('🎯 Special Quranic pattern processed');
                return;
            }
            
            // 🔗 Try sequence matching with remaining text
            if (this.trySequenceMatching(transcript, confidence)) {
                console.log('🔗 Sequence matching successful');
                return;
            }
            
            // 🔄 Fallback to individual word processing if sequence fails
            const words = transcript.trim().split(/\s+/);
            words.forEach(word => {
                if (word && word.length > 0) {
                    this.processSequentialWordUltraFast(word.trim());
                }
            });
            
            // 📊 Performance tracking
            const totalTime = performance.now() - processingStart;
            console.log(`📊 Sequential processing completed in ${totalTime.toFixed(2)}ms`);
        },
        
        // 🔗 Try Sequence Matching with Remaining Text
        trySequenceMatching(transcript, confidence) {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                return false;
            }
            
            const normalizedTranscript = this.normalizeArabicText(transcript);
            
            // Get remaining text from current position
            const remainingWords = state.currentMemorizationWords.slice(state.memorizationStats.currentWordIndex);
            const remainingText = remainingWords.slice(0, 5).join(' '); // Look ahead 5 words
            const normalizedRemaining = this.normalizeArabicText(remainingText);
            
            console.log(`🔍 Sequence check: "${normalizedTranscript}" vs "${normalizedRemaining}"`);
            
            // Check if transcript matches beginning of remaining text
            if (this.isSequenceMatch(normalizedTranscript, normalizedRemaining)) {
                // Calculate how many words this covers
                const wordsMatched = this.calculateWordsMatched(normalizedTranscript, remainingWords);
                
                if (wordsMatched > 0) {
                    console.log(`✅ Sequence matched ${wordsMatched} words`);
                    
                    // Mark words as correct
                    for (let i = 0; i < wordsMatched; i++) {
                        this.processCorrectWordUltraFast(remainingWords[i]);
                    }
                    
                    return true;
                }
            }
            
            return false;
        },
        
        // 📊 Calculate How Many Words Were Matched
        calculateWordsMatched(transcript, remainingWords) {
            let totalMatched = 0;
            let accumulatedText = '';
            
            for (let i = 0; i < Math.min(remainingWords.length, 5); i++) {
                accumulatedText += (i > 0 ? ' ' : '') + remainingWords[i];
                const normalizedAccumulated = this.normalizeArabicText(accumulatedText);
                
                // Check if transcript still matches or is contained in accumulated text
                if (normalizedAccumulated.startsWith(transcript) || 
                    transcript.startsWith(normalizedAccumulated) ||
                    this.calculateSimilarity(transcript, normalizedAccumulated) >= 0.7) {
                    totalMatched = i + 1;
                } else {
                    break;
                }
            }
            
            return totalMatched;
        },
        
        // 🔍 Process Interim Sequence (for partial results)
        processInterimSequence(transcript, confidence) {
            const normalizedTranscript = this.normalizeArabicText(transcript);
            
            // Show interim feedback with sequence preview
            if (state.memorizationStats.currentWordIndex < state.currentMemorizationWords.length) {
                const remainingWords = state.currentMemorizationWords.slice(state.memorizationStats.currentWordIndex, state.memorizationStats.currentWordIndex + 3);
                const expectedSequence = this.normalizeArabicText(remainingWords.join(' '));
                
                if (expectedSequence.startsWith(normalizedTranscript) && normalizedTranscript.length >= 2) {
                    this.showSequenceFeedback(`🎯 متطابق: ${transcript}...`, '#22c55e');
                } else {
                    this.showSequenceFeedback(`🎙️ ${transcript}`, '#8b5cf6');
                }
            }
        },
        
        // 🎯 Enhanced Interim Feedback
        showEnhancedInterimFeedback(transcript, processingTime) {
            this.showSequenceFeedback(`🎙️ ${transcript} (⚡${processingTime.toFixed(0)}ms)`, '#3b82f6');
        },
        
        // 🎆 Unified Sequence Feedback Display
        showSequenceFeedback(message, color = '#10b981', duration = 1000) {
            const feedbackEl = document.getElementById('speech-interim-feedback');
            if (feedbackEl) {
                feedbackEl.textContent = message;
                feedbackEl.style.color = color;
                feedbackEl.style.opacity = '1';
                feedbackEl.style.transform = 'scale(1.02)';
                feedbackEl.style.transition = 'all 0.15s ease';
                
                clearTimeout(this.sequenceFeedbackTimeout);
                this.sequenceFeedbackTimeout = setTimeout(() => {
                    feedbackEl.style.opacity = '0.3';
                    feedbackEl.style.transform = 'scale(1)';
                }, duration);
            }
        },
        
        // Enhanced function for fast recitation pattern matching
        isFastRecitationMatch(spoken, quranicCorrect, plainCorrect) {
            // Check for common fast recitation patterns
            const spokenShort = spoken.substring(0, Math.min(3, spoken.length));
            const quranicShort = quranicCorrect.substring(0, Math.min(3, quranicCorrect.length));
            const plainShort = plainCorrect.substring(0, Math.min(3, plainCorrect.length));
            
            // Beginning match for fast reading
            if (spokenShort === quranicShort || spokenShort === plainShort) {
                return true;
            }
            
            // Check if spoken word contains core of the correct word
            const coreLength = Math.floor(Math.max(quranicCorrect.length, plainCorrect.length) * 0.6);
            if (coreLength >= 2) {
                const quranicCore = quranicCorrect.substring(0, coreLength);
                const plainCore = plainCorrect.substring(0, coreLength);
                
                if (spoken.includes(quranicCore) || spoken.includes(plainCore) ||
                    quranicCorrect.includes(spoken) || plainCorrect.includes(spoken)) {
                    return true;
                }
            }
            
            // Fuzzy matching for connected speech in fast recitation
            const fuzzyThreshold = 0.5;
            const fuzzyQuranic = this.calculateAdvancedSimilarity(spoken, quranicCorrect);
            const fuzzyPlain = this.calculateAdvancedSimilarity(spoken, plainCorrect);
            
            return Math.max(fuzzyQuranic, fuzzyPlain) >= fuzzyThreshold;
        },
        
        // Ultra-fast speech matching for immediate recognition
        isUltraFastSpeechMatch(spoken, quranicCorrect, plainCorrect) {
            // For ultra-fast speech, check minimal patterns
            if (spoken.length >= 1 && (quranicCorrect.length >= 1 || plainCorrect.length >= 1)) {
                // Single character match for very fast speech
                const spokenFirst = spoken.charAt(0);
                const quranicFirst = quranicCorrect.charAt(0);
                const plainFirst = plainCorrect.charAt(0);
                
                if (spokenFirst === quranicFirst || spokenFirst === plainFirst) {
                    return true;
                }
            }
            
            // Ultra-aggressive substring matching
            const minLength = Math.min(spoken.length, Math.max(quranicCorrect.length, plainCorrect.length));
            if (minLength >= 2) {
                const spokenSub = spoken.substring(0, Math.ceil(minLength * 0.6));
                const quranicSub = quranicCorrect.substring(0, Math.ceil(minLength * 0.6));
                const plainSub = plainCorrect.substring(0, Math.ceil(minLength * 0.6));
                
                if (spokenSub === quranicSub || spokenSub === plainSub) {
                    return true;
                }
            }
            
            // Check if any part of spoken word exists in correct words
            if (spoken.length >= 2) {
                for (let i = 0; i <= spoken.length - 2; i++) {
                    const fragment = spoken.substring(i, i + 2);
                    if (quranicCorrect.includes(fragment) || plainCorrect.includes(fragment)) {
                        return true;
                    }
                }
            }
            
            // Ultra-lenient similarity for any resemblance
            const ultraFuzzyThreshold = 0.3;
            const ultraFuzzyQuranic = this.calculateAdvancedSimilarity(spoken, quranicCorrect);
            const ultraFuzzyPlain = this.calculateAdvancedSimilarity(spoken, plainCorrect);
            
            return Math.max(ultraFuzzyQuranic, ultraFuzzyPlain) >= ultraFuzzyThreshold;
        },
        
        arePhoneticallySimilarTajweed(word1, word2) {
            // مجموعات الحروف المتشابهة صوتياً في التجويد
            const similarGroups = [
                // حروف الإطباق
                ['ت', 'ط'], // ت و ط
                ['د', 'ض'], // د و ض
                ['س', 'ص'], // س و ص
                ['ث', 'ظ'], // ث و ظ
                // حروف متشابهة أخرى
                ['ه', 'ح'], // ه و ح
                ['ق', 'ك'], // ق و ك
                ['ذ', 'ز'], // ذ و ز
                ['غ', 'خ'], // غ و خ
                ['ف', 'ب'], // ف و ب (في بعض اللهجات)
                ['ج', 'ش'], // ج و ش
                ['ر', 'ل'], // ر و ل (أحياناً)
            ];
            
            let substituted1 = word1;
            let substituted2 = word2;
            
            // استبدال الحروف المتشابهة
            similarGroups.forEach(group => {
                group.forEach(char => {
                    substituted1 = substituted1.replace(new RegExp(char, 'g'), group[0]);
                    substituted2 = substituted2.replace(new RegExp(char, 'g'), group[0]);
                });
            });
            
            return substituted1 === substituted2;
        },
        
        getLevenshteinDistance(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[b.length][a.length];
        },
        
        arePhoneticallySimilar(word1, word2) {
            // مجموعات الحروف المتشابهة صوتياً
            const similarGroups = [
                ['ت', 'ط'], // ت و ط
                ['د', 'ض'], // د و ض
                ['س', 'ص'], // س و ص
                ['ث', 'ظ'], // ث و ظ
                ['ه', 'ح'], // ه و ح
                ['ق', 'ك'], // ق و ك
                ['ذ', 'ز'], // ذ و ز
            ];
            
            let substituted1 = word1;
            let substituted2 = word2;
            
            // استبدال الحروف المتشابهة
            similarGroups.forEach(group => {
                group.forEach(char => {
                    substituted1 = substituted1.replace(new RegExp(char, 'g'), group[0]);
                    substituted2 = substituted2.replace(new RegExp(char, 'g'), group[0]);
                });
            });
            
            return substituted1 === substituted2;
        },
        
        calculateSimilarity(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const maxLength = Math.max(a.length, b.length);
            return maxLength === 0 ? 1 : (maxLength - matrix[b.length][a.length]) / maxLength;
        },
        
        // Enhanced similarity calculation with multiple algorithms
        calculateAdvancedSimilarity(a, b) {
            if (!a || !b) return 0;
            if (a === b) return 1;
            
            // Multiple similarity calculations for highest accuracy
            const levenshtein = this.calculateLevenshteinSimilarity(a, b);
            const jaro = this.calculateJaroSimilarity(a, b);
            const phonetic = this.calculatePhoneticSimilarity(a, b);
            const substring = this.calculateSubstringSimilarity(a, b);
            
            // Weighted combination for optimal results
            const weightedScore = (
                levenshtein * 0.4 +    // 40% Levenshtein (exact matching)
                jaro * 0.3 +           // 30% Jaro (word structure)
                phonetic * 0.2 +       // 20% Phonetic (sound similarity)
                substring * 0.1        // 10% Substring (partial matching)
            );
            
            return Math.min(1, weightedScore);
        },
        
        // Levenshtein distance similarity
        calculateLevenshteinSimilarity(a, b) {
            const matrix = [];
            
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            const maxLength = Math.max(a.length, b.length);
            return maxLength === 0 ? 1 : (maxLength - matrix[b.length][a.length]) / maxLength;
        },
        
        // Jaro similarity for word structure
        calculateJaroSimilarity(s1, s2) {
            if (s1 === s2) return 1;
            
            const len1 = s1.length;
            const len2 = s2.length;
            
            if (len1 === 0 || len2 === 0) return 0;
            
            const matchWindow = Math.floor(Math.max(len1, len2) / 2) - 1;
            const s1Matches = new Array(len1).fill(false);
            const s2Matches = new Array(len2).fill(false);
            
            let matches = 0;
            let transpositions = 0;
            
            // Find matches
            for (let i = 0; i < len1; i++) {
                const start = Math.max(0, i - matchWindow);
                const end = Math.min(i + matchWindow + 1, len2);
                
                for (let j = start; j < end; j++) {
                    if (s2Matches[j] || s1[i] !== s2[j]) continue;
                    s1Matches[i] = true;
                    s2Matches[j] = true;
                    matches++;
                    break;
                }
            }
            
            if (matches === 0) return 0;
            
            // Find transpositions
            let k = 0;
            for (let i = 0; i < len1; i++) {
                if (!s1Matches[i]) continue;
                while (!s2Matches[k]) k++;
                if (s1[i] !== s2[k]) transpositions++;
                k++;
            }
            
            return (matches / len1 + matches / len2 + (matches - transpositions / 2) / matches) / 3;
        },
        
        // Phonetic similarity for Arabic sounds
        calculatePhoneticSimilarity(a, b) {
            const phoneticA = this.getArabicPhoneticCode(a);
            const phoneticB = this.getArabicPhoneticCode(b);
            
            if (phoneticA === phoneticB) return 1;
            
            return this.calculateLevenshteinSimilarity(phoneticA, phoneticB);
        },
        
        // Arabic phonetic encoding
        getArabicPhoneticCode(word) {
            return word
                // Similar sounding Arabic letters
                .replace(/[تط]/g, 't')      // ت ط
                .replace(/[دض]/g, 'd')      // د ض
                .replace(/[سص]/g, 's')      // س ص
                .replace(/[ثظ]/g, 'th')     // ث ظ
                .replace(/[هح]/g, 'h')      // ه ح
                .replace(/[قك]/g, 'k')      // ق ك
                .replace(/[ذز]/g, 'z')      // ذ ز
                .replace(/[غخ]/g, 'gh')     // غ خ
                .replace(/[فب]/g, 'f')      // ف ب (sometimes)
                .replace(/[جش]/g, 'j')      // ج ش
                .replace(/[رل]/g, 'r');     // ر ل (sometimes)
        },
        
        // Substring similarity
        calculateSubstringSimilarity(a, b) {
            if (a.length === 0 || b.length === 0) return 0;
            
            let maxMatch = 0;
            const minLen = Math.min(a.length, b.length);
            
            for (let len = minLen; len > 0; len--) {
                for (let i = 0; i <= a.length - len; i++) {
                    const substr = a.substring(i, i + len);
                    if (b.includes(substr)) {
                        maxMatch = Math.max(maxMatch, len);
                        break;
                    }
                }
                if (maxMatch === len) break;
            }
            
            return maxMatch / Math.max(a.length, b.length);
        },
        
        // Intelligent dynamic threshold calculation
        calculateDynamicThreshold(correctWord, spokenWord, confidence) {
            let baseThreshold = 0.7; // Start with high accuracy requirement
            
            // Adjust based on word length
            if (correctWord.length <= 2) {
                baseThreshold = 0.8; // Higher threshold for short words (more precision needed)
            } else if (correctWord.length <= 4) {
                baseThreshold = 0.7; // Standard threshold for medium words
            } else if (correctWord.length <= 6) {
                baseThreshold = 0.65; // Slightly lower for longer words
            } else {
                baseThreshold = 0.6; // Lower threshold for very long words
            }
            
            // Adjust based on speech recognition confidence
            const confidenceAdjustment = (confidence - 0.7) * 0.2; // -0.14 to +0.06 adjustment
            baseThreshold += confidenceAdjustment;
            
            // Adjust for common Quranic patterns
            if (this.isCommonQuranicWord(correctWord)) {
                baseThreshold -= 0.1; // More lenient for common words
            }
            
            // Adjust for special characters or patterns
            if (correctWord.includes('ال') || correctWord.includes('بال')) {
                baseThreshold -= 0.05; // More lenient for words with definite articles
            }
            
            // Adjust based on speech length similarity
            const lengthRatio = Math.min(spokenWord.length, correctWord.length) / Math.max(spokenWord.length, correctWord.length);
            if (lengthRatio < 0.7) {
                baseThreshold += 0.1; // Stricter if lengths are very different
            }
            
            // Ensure threshold stays within reasonable bounds
            return Math.max(0.4, Math.min(0.9, baseThreshold));
        },
        
        // Check if word is a common Quranic word
        isCommonQuranicWord(word) {
            const commonWords = [
                'الله', 'الرحمن', 'الرحيم', 'رب', 'العالمين',
                'الحمد', 'مالك', 'يوم', 'الدين', 'إياك',
                'نعبد', 'نستعين', 'اهدنا', 'الصراط',
                'المستقيم', 'الذين', 'أنعمت', 'عليهم',
                'غير', 'المغضوب', 'الضالين', 'بسم',
                'ذلك', 'الكتاب', 'ريب', 'فيه', 'هدى'
            ];
            
            return commonWords.includes(word);
        },
        
        updateMemorizationDisplay() {
            // تحديث شريط التقدم
            const progress = (state.memorizationStats.currentWordIndex / state.memorizationStats.totalWords) * 100;
            const progressEl = document.getElementById('memorization-progress');
            const totalEl = document.getElementById('memorization-total');
            const progressBarEl = document.getElementById('memorization-progress-bar');
            
            if (progressEl) progressEl.textContent = state.memorizationStats.currentWordIndex;
            if (totalEl) totalEl.textContent = state.memorizationStats.totalWords;
            if (progressBarEl) progressBarEl.style.width = progress + '%';
            
            // حساب الدقة
            const totalAttempts = state.memorizationStats.correctWords + state.memorizationStats.incorrectWords;
            state.memorizationStats.accuracy = totalAttempts > 0 ? 
                Math.round((state.memorizationStats.correctWords / totalAttempts) * 100) : 0;
            
            // تحديث الإحصائيات في اللوحة
            const totalWordsEl = document.getElementById('memorization-total-words');
            const correctWordsEl = document.getElementById('memorization-correct-words');
            const incorrectWordsEl = document.getElementById('memorization-incorrect-words');
            const accuracyEl = document.getElementById('memorization-accuracy');
            
            if (totalWordsEl) totalWordsEl.textContent = state.memorizationStats.totalWords;
            if (correctWordsEl) correctWordsEl.textContent = state.memorizationStats.correctWords;
            if (incorrectWordsEl) incorrectWordsEl.textContent = state.memorizationStats.incorrectWords;
            if (accuracyEl) accuracyEl.textContent = state.memorizationStats.accuracy + '%';
        },
        
        updateDebugInfo(lastSpoken = null, comparisonResult = null) {
            const currentWordEl = document.getElementById('current-expected-word');
            const currentNormalizedEl = document.getElementById('current-normalized-word');
            const lastHeardEl = document.getElementById('last-heard-word');
            const lastHeardNormalizedEl = document.getElementById('last-heard-normalized');
            const statusEl = document.getElementById('recognition-status');
            const comparisonEl = document.getElementById('comparison-result');
            
            if (currentWordEl && state.memorizationStats.currentWordIndex < state.currentMemorizationWords.length) {
                const currentWord = state.currentMemorizationWords[state.memorizationStats.currentWordIndex];
                currentWordEl.textContent = currentWord;
                
                if (currentNormalizedEl) {
                    currentNormalizedEl.textContent = this.normalizeArabic(currentWord);
                }
            }
            
            if (lastSpoken && lastHeardEl) {
                lastHeardEl.textContent = lastSpoken;
                
                if (lastHeardNormalizedEl) {
                    lastHeardNormalizedEl.textContent = this.normalizeArabic(lastSpoken);
                }
            }
            
            if (statusEl) {
                statusEl.textContent = state.speechRecognition ? 'نشط' : 'متوقف';
            }
            
            if (comparisonResult !== null && comparisonEl) {
                comparisonEl.textContent = comparisonResult ? '✅ مطابق' : '❌ غير مطابق';
                comparisonEl.className = comparisonResult ? 'font-bold text-green-600' : 'font-bold text-red-600';
            }
        },
        
        showError(error) {
            const errorsContainer = document.getElementById('memorization-errors');
            const errorsList = document.getElementById('memorization-errors-list');
            
            if (errorsContainer && errorsList) {
                errorsContainer.classList.remove('hidden');
                
                const errorElement = document.createElement('div');
                errorElement.className = 'error-item flex justify-between items-center p-4 bg-gradient-to-r from-red-50 to-pink-50 dark:from-red-900/20 dark:to-pink-900/20 rounded-xl text-sm border-l-4 border-red-500 mb-3 shadow-lg transition-all duration-300 hover:shadow-xl';
                
                // Enhanced error display with better formatting
                errorElement.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                            <span class="font-bold text-red-700 text-xs">خطأ في التلاوة</span>
                            <span class="text-gray-500 text-xs">${new Date().toLocaleTimeString('ar-SA')}</span>
                        </div>
                        <div class="bg-white/70 rounded-lg p-3 mb-2">
                            <div class="text-red-600 mb-1 font-arabic text-base">
                                <span class="text-xs text-gray-600">قلت:</span> 
                                <span class="font-semibold">“${error.spoken}”</span>
                            </div>
                            <div class="text-green-600 font-arabic text-base">
                                <span class="text-xs text-gray-600">الصحيح:</span> 
                                <span class="font-semibold">“${error.correct}”</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500">
                            <i class="fas fa-info-circle"></i>
                            <span>اعد المحاولة - اقرأ بوضوح أكبر</span>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 ml-3">
                        <button onclick="this.closest('.error-item').remove()" class="text-gray-400 hover:text-red-600 transition-colors p-2 rounded-full hover:bg-red-50">
                            <i class="fas fa-times"></i>
                        </button>
                        <button onclick="App.repeatWord('${error.correct.replace(/'/g, "\\'")}')"
                                class="text-purple-500 hover:text-purple-700 transition-colors p-2 rounded-full hover:bg-purple-50" 
                                title="إعادة المحاولة">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                `;
                
                // Add with smooth animation
                errorElement.style.opacity = '0';
                errorElement.style.transform = 'translateX(100%)';
                errorsList.appendChild(errorElement);
                
                // Animate in
                requestAnimationFrame(() => {
                    errorElement.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    errorElement.style.opacity = '1';
                    errorElement.style.transform = 'translateX(0)';
                });
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (errorElement.parentNode) {
                        errorElement.style.transform = 'translateX(100%)';
                        errorElement.style.opacity = '0';
                        setTimeout(() => {
                            if (errorElement.parentNode) {
                                errorElement.remove();
                            }
                        }, 400);
                    }
                }, 10000);
            }
        },
        
        // Add function to repeat a word when user clicks retry
        repeatWord(word) {
            // Highlight the word again for retry
            const currentWordIndex = state.memorizationStats.currentWordIndex;
            const wordElements = document.querySelectorAll('.ayah-word');
            
            if (currentWordIndex < wordElements.length) {
                const currentElement = wordElements[currentWordIndex];
                currentElement.classList.remove('hidden', 'incorrect');
                currentElement.classList.add('waiting');
                
                // Show encouraging message
                // Speech feedback disabled per user request
                
                // Provide audio hint if available
                if (state.memorizationSettings.soundAlerts) {
                    this.playHintSound();
                }
            }
        },
        
        // Enhanced sound feedback
        playHintSound() {
            this.playSound('hint');
        },
        
        showMemorizationResults() {
            if (state.memorizationStats.totalWords === 0) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content p-6">
                    <h3 class="text-xl font-bold mb-4">نتائج الحفظ</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-green-600">${state.memorizationStats.correctWords}</p>
                            <p class="text-sm">كلمات صحيحة</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-red-600">${state.memorizationStats.incorrectWords}</p>
                            <p class="text-sm">كلمات خاطئة</p>
                        </div>
                        <div class="text-center col-span-2">
                            <p class="text-3xl font-bold" style="color: var(--primary)">${state.memorizationStats.accuracy}%</p>
                            <p class="text-sm">دقة الحفظ</p>
                        </div>
                    </div>
                    <button onclick="this.closest('.modal').remove()" class="btn btn-primary w-full">
                        إغلاق
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // إزالة بعد 10 ثواني
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.remove();
                }
            }, 10000);
        },
        
        // وظائف مساعدة للحفظ
        showVerse() {
            const wordElements = document.querySelectorAll('.ayah-word');
            const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
            const elements = memWordElements.length > 0 ? memWordElements : wordElements;
            
            elements.forEach((word, index) => {
                // إظهار جميع الكلمات مؤقتاً
                word.classList.remove('hidden', 'waiting');
                word.classList.add('revealed');
                word.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.4))';
                word.style.border = '2px solid rgba(59, 130, 246, 0.6)';
            });
            
            this.showToast('تم إظهار الآيات لمدة 3 ثوان', 'info');
            
            setTimeout(() => {
                elements.forEach((word, index) => {
                    if (index >= state.memorizationStats.currentWordIndex) {
                        // إخفاء الكلمات غير المقولة مرة أخرى
                        word.classList.add('hidden');
                        word.classList.remove('revealed');
                        word.style.background = '';
                        word.style.border = '';
                        
                        // إظهار الكلمة الحالية في وضع الانتظار
                        if (index === state.memorizationStats.currentWordIndex) {
                            word.classList.add('waiting');
                        }
                    }
                });
            }, 3000);
        },
        
        giveHint() {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                this.showToast('لا توجد كلمات متبقية', 'warning');
                return;
            }
            
            const currentWord = state.currentMemorizationWords[state.memorizationStats.currentWordIndex];
            const hint = currentWord.length > 2 ? currentWord.substring(0, 2) + '...' : currentWord;
            
            // عرض التلميح في توست
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fadeIn';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 m-4 max-w-sm text-center shadow-2xl transform animate-scaleIn">
                    <i class="fas fa-lightbulb text-yellow-500 text-4xl mb-4 animate-pulse"></i>
                    <h3 class="text-xl font-bold mb-3 text-gray-800">تلميح</h3>
                    <p class="text-gray-600 mb-3">الكلمة تبدأ بـ:</p>
                    <p class="font-arabic text-3xl font-bold text-emerald-600 mb-6 bg-emerald-50 p-3 rounded-lg">${hint}</p>
                    <button class="btn btn-primary px-6 py-2" onclick="this.parentElement.parentElement.remove()">حسناً</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.remove();
                }
            }, 5000);
            
            this.showToast(`تلميح: الكلمة تبدأ بـ "${hint}"`, 'info');
        },
        
        skipWord() {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                this.showToast('لا توجد كلمات لتخطيها', 'warning');
                return;
            }
            
            const skippedWord = state.currentMemorizationWords[state.memorizationStats.currentWordIndex];
            
            // تسجيل التخطي كخطأ
            const error = {
                wordIndex: state.memorizationStats.currentWordIndex,
                expected: skippedWord,
                spoken: 'تم التخطي',
                timestamp: new Date().toISOString()
            };
            
            state.memorizationStats.errors.push(error);
            state.memorizationStats.incorrectWords++;
            
            // إظهار الكلمة المتخطاة
            this.markWordCorrect(state.memorizationStats.currentWordIndex);
            
            // الانتقال إلى الكلمة التالية
            state.memorizationStats.currentWordIndex++;
            
            if (state.memorizationStats.currentWordIndex < state.currentMemorizationWords.length) {
                this.setCurrentWord(state.memorizationStats.currentWordIndex);
            } else {
                this.completeMemorization();
            }
            
            this.updateMemorizationProgressDisplay();
            this.showToast(`تم تخطي الكلمة: "${skippedWord}"`, 'warning');
        },
        
        // Mark a word as correctly spoken and reveal it
        markWordCorrect(wordIndex) {
            const wordElements = document.querySelectorAll('.ayah-word');
            const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
            const elements = memWordElements.length > 0 ? memWordElements : wordElements;
            
            if (wordIndex < elements.length) {
                const wordElement = elements[wordIndex];
                wordElement.classList.remove('hidden', 'waiting', 'incorrect');
                
                // Keep original Quranic text display (no conversion to plain text)
                // The original text with diacritics remains as is
                
                // Immediately reveal without animation out of respect for Quran
                wordElement.classList.add('revealed');
            }
        },
        
        // Set current word to waiting state
        setCurrentWord(wordIndex) {
            const wordElements = document.querySelectorAll('.ayah-word');
            const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
            const elements = memWordElements.length > 0 ? memWordElements : wordElements;
            
            // Remove waiting state from all words
            elements.forEach(el => el.classList.remove('waiting'));
            
            // Set current word to waiting if it exists and is still hidden
            if (wordIndex < elements.length) {
                const currentElement = elements[wordIndex];
                if (currentElement.classList.contains('hidden')) {
                    currentElement.classList.add('waiting');
                }
            }
        },

        resetMemorization() {
            // إعادة تعيين الإحصائيات
            this.resetMemorizationStats();
            
            // إعادة تعيين عرض الكلمات
            const wordElements = document.querySelectorAll('.ayah-word');
            const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
            const elements = memWordElements.length > 0 ? memWordElements : wordElements;
            
            elements.forEach((word, index) => {
                word.classList.remove('revealed', 'waiting', 'correct', 'incorrect');
                word.classList.add('hidden');
                word.style.background = '';
                word.style.border = '';
                word.style.animation = '';
                
                // إظهار الكلمة الأولى
                if (index === 0) {
                    word.classList.add('waiting');
                }
            });
            
            // مسح قائمة الأخطاء
            const errorsContainer = document.getElementById('memorization-errors-list');
            if (errorsContainer) {
                errorsContainer.innerHTML = '';
            }
            
            this.updateMemorizationProgressDisplay();
            this.showToast('تم إعادة بدء الحفظ', 'success');
        },
        
        playMemorizationAudio() {
            // تشغيل صوت الآية الحالية
            if (state.pageData && state.pageData.length > 0) {
                const firstVerse = state.pageData[0];
                if (firstVerse && firstVerse.verse_key) {
                    this.playAyahAudio(firstVerse.verse_key);
                }
            } else {
                this.showToast('لا يمكن تشغيل الصوت حالياً', 'error');
            }
        },

        convertToArabicNumbers(number) {
            const arabicNumbers = ['٠', '٢', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return number.toString().split('').map(digit => arabicNumbers[digit]).join('');
        },
        
        // Enhanced memorization helper functions
        showVerse() {
            const wordElements = document.querySelectorAll('.ayah-word');
            const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
            const elements = memWordElements.length > 0 ? memWordElements : wordElements;
            
            elements.forEach((word, index) => {
                // إظهار جميع الكلمات مؤقتاً
                word.classList.remove('hidden', 'waiting');
                word.classList.add('revealed');
                word.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.4))';
                word.style.border = '2px solid rgba(59, 130, 246, 0.6)';
            });
            
            this.showToast('تم إظهار الآيات لمدة 3 ثوان', 'info');
            
            setTimeout(() => {
                elements.forEach((word, index) => {
                    if (index >= state.memorizationStats.currentWordIndex) {
                        // إخفاء الكلمات غير المقولة مرة أخرى
                        word.classList.add('hidden');
                        word.classList.remove('revealed');
                        word.style.background = '';
                        word.style.border = '';
                        
                        // إظهار الكلمة الحالية في وضع الانتظار
                        if (index === state.memorizationStats.currentWordIndex) {
                            word.classList.add('waiting');
                        }
                    }
                });
            }, 3000);
        },
        
        giveHint() {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                this.showToast('لا توجد كلمات متبقية', 'warning');
                return;
            }
            
            const currentWord = state.currentMemorizationWords[state.memorizationStats.currentWordIndex];
            const hint = currentWord.length > 2 ? currentWord.substring(0, 2) + '...' : currentWord;
            
            // عرض التلميح في توست
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fadeIn';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 m-4 max-w-sm text-center shadow-2xl transform animate-scaleIn">
                    <i class="fas fa-lightbulb text-yellow-500 text-4xl mb-4 animate-pulse"></i>
                    <h3 class="text-xl font-bold mb-3 text-gray-800">تلميح</h3>
                    <p class="text-gray-600 mb-3">الكلمة تبدأ بـ:</p>
                    <p class="font-arabic text-3xl font-bold text-emerald-600 mb-6 bg-emerald-50 p-3 rounded-lg">${hint}</p>
                    <button class="btn btn-primary px-6 py-2" onclick="this.parentElement.parentElement.remove()">حسناً</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                if (modal.parentElement) {
                    modal.remove();
                }
            }, 5000);
            
            this.showToast(`تلميح: الكلمة تبدأ بـ "${hint}"`, 'info');
        },
        
        skipWord() {
            if (state.memorizationStats.currentWordIndex >= state.currentMemorizationWords.length) {
                this.showToast('لا توجد كلمات لتخطيها', 'warning');
                return;
            }
            
            const skippedWord = state.currentMemorizationWords[state.memorizationStats.currentWordIndex];
            
            // تسجيل التخطي كخطأ
            const error = {
                wordIndex: state.memorizationStats.currentWordIndex,
                expected: skippedWord,
                spoken: 'تم التخطي',
                timestamp: new Date().toISOString()
            };
            
            state.memorizationStats.errors.push(error);
            state.memorizationStats.incorrectWords++;
            
            // إظهار الكلمة المتخطاة
            this.markWordCorrect(state.memorizationStats.currentWordIndex);
            
            // الانتقال إلى الكلمة التالية
            state.memorizationStats.currentWordIndex++;
            
            if (state.memorizationStats.currentWordIndex < state.currentMemorizationWords.length) {
                this.setCurrentWord(state.memorizationStats.currentWordIndex);
            } else {
                this.completeMemorization();
            }
            
            this.updateMemorizationProgressDisplay();
            this.showToast(`تم تخطي الكلمة: "${skippedWord}"`, 'warning');
        },
        
        resetMemorization() {
            // إعادة تعيين الإحصائيات
            this.resetMemorizationStats();
            
            // إعادة تعيين عرض الكلمات
            const wordElements = document.querySelectorAll('.ayah-word');
            const memWordElements = document.querySelectorAll('#memorization-page-content .ayah-word');
            const elements = memWordElements.length > 0 ? memWordElements : wordElements;
            
            elements.forEach((word, index) => {
                word.classList.remove('revealed', 'waiting', 'correct', 'incorrect');
                word.classList.add('hidden');
                word.style.background = '';
                word.style.border = '';
                word.style.animation = '';
                
                // إظهار الكلمة الأولى
                if (index === 0) {
                    word.classList.add('waiting');
                }
            });
            
            // مسح قائمة الأخطاء
            const errorsContainer = document.getElementById('memorization-errors-list');
            if (errorsContainer) {
                errorsContainer.innerHTML = '';
            }
            
            this.updateMemorizationProgressDisplay();
            this.showToast('تم إعادة بدء الحفظ', 'success');
        },
        
        playMemorizationAudio() {
            // تشغيل صوت الآية الحالية
            if (state.pageData && state.pageData.length > 0) {
                const firstVerse = state.pageData[0];
                if (firstVerse && firstVerse.verse_key) {
                    this.playAyahAudio(firstVerse.verse_key);
                }
            } else {
                this.showToast('لا يمكن تشغيل الصوت حالياً', 'error');
            }
        },

        playSuccessSound() {
            try {
                // صوت نجاح باستخدام Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Audio context not available');
            }
        },
        
        playErrorSound() {
            try {
                // صوت خطأ
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.type = 'square';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Audio context not available');
            }
        },
        
        navigatePage(direction) {
            const newPage = state.currentPage + direction;
            if (newPage >= 1 && newPage <= CONFIG.TOTAL_PAGES) {
                this.loadPage(newPage);
            }
        },
        
        setupAudio() {
            state.audioQueue = [];
            state.currentAudioIndex = 0;
            
            if (state.pageData) {
                state.pageData.forEach(verse => {
                    if (verse.audio?.url) {
                        state.audioQueue.push({
                            url: CONFIG.AUDIO_BASE + verse.audio.url,
                            verseKey: verse.verse_key
                        });
                    }
                });
            }
            
            const audioEl = document.getElementById('page-audio');
            if (state.audioQueue.length > 0) {
                audioEl.src = state.audioQueue[0].url;
            }
        },
        
        playNextAyah() {
            if (state.currentAudioIndex < state.audioQueue.length - 1) {
                state.currentAudioIndex++;
                const audioEl = document.getElementById('page-audio');
                audioEl.src = state.audioQueue[state.currentAudioIndex].url;
                audioEl.play();
            }
        },
        
        // Show interim speech feedback (disabled per user request)
        showInterimFeedback(interimText) {
            // Speech feedback disabled - user requested no listening indicator
            return;
        },
        
        // Add empty updateSpeechFeedback function to prevent errors
        updateSpeechFeedback(message, confidence) {
            // Speech feedback disabled per user request
            return;
        },
        
        // Enhanced error tracking and display
        updateErrorsList() {
            const errorsContainer = document.getElementById('memorization-errors-list');
            if (!errorsContainer) return;
            
            errorsContainer.innerHTML = '';
            
            state.memorizationStats.errors.slice(-5).forEach((error, index) => {
                const errorEl = document.createElement('div');
                errorEl.className = 'error-item p-3 mb-2 bg-red-50 border border-red-200 rounded-lg text-sm shadow-sm animate-slideIn';
                errorEl.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <div class="text-red-800 font-semibold text-xs">خطأ ${state.memorizationStats.errors.length - index}</div>
                        <div class="text-red-500 text-xs">${new Date(error.timestamp || Date.now()).toLocaleTimeString('ar')}</div>
                    </div>
                    <div class="text-red-600 mb-1">قلت: <span class="font-arabic font-medium">"${error.spoken}"</span></div>
                    <div class="text-green-600">الصحيح: <span class="font-arabic font-medium">"${error.expected || error.correct}"</span></div>
                `;
                errorsContainer.appendChild(errorEl);
            });
        },
        
        // Enhanced sound feedback
        playSound(type) {
            if (!state.memorizationSettings.soundAlerts) return;
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                if (type === 'success') {
                    // Success tone - beautiful ascending
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2); // G5
                    
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } else if (type === 'error') {
                    // Error tone - gentle descending
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
                    oscillator.frequency.setValueAtTime(349, audioContext.currentTime + 0.15); // F4
                    oscillator.frequency.setValueAtTime(294, audioContext.currentTime + 0.3); // D4
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
            } catch (error) {
                console.warn('Could not play sound:', error);
            }
        },
        
        playMemorizationAudio() {
            // تشغيل صوت الآية الحالية
            if (state.pageData && state.pageData.length > 0) {
                const firstVerse = state.pageData[0];
                if (firstVerse && firstVerse.verse_key) {
                    this.playAyahAudio(firstVerse.verse_key);
                }
            } else {
                this.showToast('لا يمكن تشغيل الصوت حالياً', 'error');
            }
        },
        
        playNextAyah() {
            if (state.currentAudioIndex < state.audioQueue.length - 1) {
                state.currentAudioIndex++;
                const audioEl = document.getElementById('page-audio');
                audioEl.src = state.audioQueue[state.currentAudioIndex].url;
                audioEl.play();
                
                this.highlightPlayingAyah();
            }
        },
        
        playPreviousAyah() {
            if (state.currentAudioIndex > 0) {
                state.currentAudioIndex--;
                const audioEl = document.getElementById('page-audio');
                audioEl.src = state.audioQueue[state.currentAudioIndex].url;
                audioEl.play();
                
                this.highlightPlayingAyah();
            }
        },
        
        highlightPlayingAyah() {
            document.querySelectorAll('.ayah').forEach(ayah => {
                ayah.classList.remove('playing');
            });
            
            if (state.audioQueue[state.currentAudioIndex]) {
                const currentVerseKey = state.audioQueue[state.currentAudioIndex].verseKey;
                const ayahEl = document.querySelector(`[data-verse-key="${currentVerseKey}"]`);
                if (ayahEl) {
                    ayahEl.classList.add('playing');
                    ayahEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        },
        
        initSurahList() {
            const list = document.getElementById('surah-list');
            list.innerHTML = '';
            
            const surahPages = [1, 2, 50, 77, 106, 128, 151, 177, 187, 208, 221, 235, 249, 255, 262, 267, 282, 293, 305, 312, 322, 332, 342, 350, 359, 367, 377, 385, 396, 404, 411, 415, 418, 428, 434, 440, 446, 453, 458, 467, 477, 483, 489, 496, 499, 502, 507, 511, 515, 518, 520, 523, 526, 528, 531, 534, 537, 542, 545, 549, 551, 553, 554, 556, 558, 560, 562, 564, 566, 568, 570, 572, 574, 575, 577, 578, 580, 582, 583, 585, 586, 587, 587, 589, 590, 591, 591, 592, 593, 594, 595, 595, 596, 596, 597, 597, 598, 598, 599, 599, 600, 600, 601, 601, 601, 602, 602, 602, 603, 603, 603, 604, 604, 604];
            
            state.surahs.forEach((surah, index) => {
                const item = document.createElement('div');
                item.className = 'card mb-3 cursor-pointer';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 text-white flex items-center justify-center font-bold">
                                ${surah.id}
                            </div>
                            <div>
                                <h4 class="font-bold">${surah.name_arabic}</h4>
                                <p class="text-xs" style="color: var(--text-secondary)">
                                    ${surah.revelation_place === 'makkah' ? 'مكية' : 'مدنية'} • ${surah.verses_count} آية
                                </p>
                            </div>
                        </div>
                        <i class="fas fa-chevron-left" style="color: var(--text-tertiary)"></i>
                    </div>
                `;
                
                item.onclick = () => {
                    const pageToLoad = surahPages[index] || 1;
                    this.loadPage(pageToLoad);
                    this.closePanel('index-panel');
                };
                
                list.appendChild(item);
            });
        },
        
        async searchQuran(query) {
            try {
                const results = await API.searchQuran(query);
                const searchResultsEl = document.getElementById('search-results');
                searchResultsEl.innerHTML = '';
                
                if (!results || !results.results || results.results.length === 0) {
                    searchResultsEl.innerHTML = '<p class="text-center opacity-50 mt-8">لا توجد نتائج</p>';
                    return;
                }
                
                for (const result of results.results) {
                    const [surahId, ayahNumber] = result.verse_key.split(':');
                    const surah = state.surahs.find(s => s.id == surahId);
                    
                    const resultEl = document.createElement('div');
                    resultEl.className = 'card mb-3 cursor-pointer';
                    resultEl.innerHTML = `
                        <div>
                            <p class="font-arabic text-lg mb-2">${result.text}</p>
                            <p class="text-sm" style="color: var(--text-secondary)">
                                سورة ${surah?.name_arabic || ''} - آية ${ayahNumber}
                            </p>
                        </div>
                    `;
                    
                    resultEl.onclick = async () => {
                        try {
                            const verseData = await API.getVerseByKey(result.verse_key);
                            await this.loadPage(verseData.page_number);
                            
                            setTimeout(() => {
                                const ayahEl = document.querySelector(`[data-verse-key="${result.verse_key}"]`);
                                if (ayahEl) {
                                    ayahEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    ayahEl.classList.add('playing');
                                    setTimeout(() => ayahEl.classList.remove('playing'), 2000);
                                }
                            }, 500);
                            
                            this.closePanel('search-panel');
                        } catch (error) {
                            console.error('Error loading search result:', error);
                        }
                    };
                    
                    searchResultsEl.appendChild(resultEl);
                }
            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = '<p class="text-center text-red-500 mt-8">حدث خطأ في البحث</p>';
            }
        },
        
        // Bookmarks Functions - محسنة
        toggleBookmark(verseKey, verseText) {
            const existingIndex = state.bookmarks.findIndex(b => b.verseKey === verseKey);
            
            if (existingIndex > -1) {
                state.bookmarks.splice(existingIndex, 1);
                this.showToast('تم إزالة العلامة', 'info');
            } else {
                const [surahId, ayahNum] = verseKey.split(':');
                const surah = state.surahs.find(s => s.id == surahId);
                
                state.bookmarks.push({
                    verseKey: verseKey,
                    verseText: verseText,
                    surahName: surah?.name_arabic || '',
                    surahId: surahId,
                    ayahNumber: ayahNum,
                    timestamp: Date.now(),
                    pageNumber: state.currentPage
                });
                this.showToast('تمت الإضافة للمفضلة', 'success');
            }
            
            localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
            this.renderPage(); // Re-render to show bookmark icon
            this.renderBookmarks(); // Update bookmarks list if open
        },
        
        renderBookmarks() {
            const list = document.getElementById('bookmarks-list');
            
            if (state.bookmarks.length === 0) {
                list.innerHTML = '<p class="text-center opacity-50">لا توجد عناصر محفوظة</p>';
                return;
            }
            
            list.innerHTML = '';
            
            // Sort bookmarks by timestamp (newest first)
            const sortedBookmarks = [...state.bookmarks].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedBookmarks.forEach(bookmark => {
                const item = document.createElement('div');
                item.className = 'card mb-3';
                item.innerHTML = `
                    <div class="mb-2">
                        <p class="font-arabic text-lg mb-2">${bookmark.verseText}</p>
                        <div class="flex items-center justify-between">
                            <p class="text-sm" style="color: var(--text-secondary)">
                                ${bookmark.surahName} - آية ${bookmark.ayahNumber}
                            </p>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary text-xs" onclick="App.goToBookmark('${bookmark.verseKey}', ${bookmark.pageNumber})">
                                    <i class="fas fa-arrow-left"></i> انتقل
                                </button>
                                <button class="text-red-500 hover:text-red-600" onclick="App.removeBookmark('${bookmark.verseKey}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                list.appendChild(item);
            });
        },
        
        async goToBookmark(verseKey, pageNumber) {
            await this.loadPage(pageNumber);
            
            setTimeout(() => {
                const ayahEl = document.querySelector(`[data-verse-key="${verseKey}"]`);
                if (ayahEl) {
                    ayahEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    ayahEl.classList.add('playing');
                    setTimeout(() => ayahEl.classList.remove('playing'), 2000);
                }
            }, 500);
            
            this.closePanel('bookmarks-panel');
        },
        
        removeBookmark(verseKey) {
            const index = state.bookmarks.findIndex(b => b.verseKey === verseKey);
            if (index > -1) {
                state.bookmarks.splice(index, 1);
                localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
                this.renderBookmarks();
                this.renderPage();
            }
        },
        
        // Khatmah Functions
        createKhatmah() {
            const name = document.getElementById('khatmah-name').value.trim();
            const goal = document.getElementById('khatmah-goal').value.trim();
            const dailyPages = parseInt(document.getElementById('khatmah-daily-pages').value) || 20;
            
            if (!name) {
                this.showToast('الرجاء إدخال اسم الختمة', 'error');
                return;
            }
            
            const khatmah = {
                id: Date.now(),
                name: name,
                goal: goal,
                dailyPages: dailyPages,
                startDate: new Date().toISOString(),
                pagesRead: [],
                totalPages: CONFIG.TOTAL_PAGES,
                completed: false
            };
            
            state.khatmahs.push(khatmah);
            localStorage.setItem('khatmahs', JSON.stringify(state.khatmahs));
            
            // Clear form
            document.getElementById('khatmah-name').value = '';
            document.getElementById('khatmah-goal').value = '';
            document.getElementById('khatmah-daily-pages').value = '20';
            
            this.updateKhatmahsDisplay();
            this.showToast('تم إنشاء الختمة بنجاح', 'success');
        },
        
        updateKhatmahsDisplay() {
            const currentContainer = document.getElementById('current-khatmahs');
            const completedContainer = document.getElementById('completed-khatmahs');
            
            const current = state.khatmahs.filter(k => !k.completed);
            const completed = state.khatmahs.filter(k => k.completed);
            
            // Current Khatmahs
            if (current.length === 0) {
                currentContainer.innerHTML = '<p class="text-center opacity-50">لا توجد ختمات حالية</p>';
            } else {
                currentContainer.innerHTML = '';
                current.forEach(khatmah => {
                    const progress = (khatmah.pagesRead.length / khatmah.totalPages) * 100;
                    const daysElapsed = Math.ceil((Date.now() - new Date(khatmah.startDate)) / (1000 * 60 * 60 * 24));
                    const estimatedDays = Math.ceil((khatmah.totalPages - khatmah.pagesRead.length) / khatmah.dailyPages);
                    
                    const card = document.createElement('div');
                    card.className = 'khatmah-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold">${khatmah.name}</h4>
                                <p class="text-sm" style="color: var(--text-secondary)">${khatmah.goal || 'لا يوجد هدف محدد'}</p>
                            </div>
                            <span class="khatmah-status active">نشطة</span>
                        </div>
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span>التقدم</span>
                                <span>${Math.round(progress)}%</span>
                            </div>
                            <div class="w-full h-2 bg-gray-200 rounded-full">
                                <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-full transition-all" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center text-sm mb-3">
                            <div>
                                <p class="font-bold">${khatmah.pagesRead.length}</p>
                                <p style="color: var(--text-secondary)">صفحة مقروءة</p>
                            </div>
                            <div>
                                <p class="font-bold">${daysElapsed}</p>
                                <p style="color: var(--text-secondary)">يوم مضى</p>
                            </div>
                            <div>
                                <p class="font-bold">${estimatedDays}</p>
                                <p style="color: var(--text-secondary)">يوم متبقي</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.showKhatmahAnalytics(${khatmah.id})" class="btn btn-secondary flex-1 text-sm">
                                <i class="fas fa-chart-bar"></i> تحليل
                            </button>
                            <button onclick="App.deleteKhatmah(${khatmah.id})" class="text-red-500 hover:text-red-600 px-3">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    currentContainer.appendChild(card);
                });
            }
            
            // Completed Khatmahs
            if (completed.length === 0) {
                completedContainer.innerHTML = '<p class="text-center opacity-50">لا توجد ختمات مكتملة</p>';
            } else {
                completedContainer.innerHTML = '';
                completed.forEach(khatmah => {
                    const daysElapsed = Math.ceil((new Date(khatmah.completedDate) - new Date(khatmah.startDate)) / (1000 * 60 * 60 * 24));
                    
                    const card = document.createElement('div');
                    card.className = 'khatmah-card';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold">${khatmah.name}</h4>
                                <p class="text-sm" style="color: var(--text-secondary)">اكتملت في ${daysElapsed} يوم</p>
                            </div>
                            <span class="khatmah-status completed">مكتملة</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="App.showKhatmahAnalytics(${khatmah.id})" class="btn btn-secondary flex-1 text-sm">
                                <i class="fas fa-chart-bar"></i> تحليل
                            </button>
                            <button onclick="App.deleteKhatmah(${khatmah.id})" class="text-red-500 hover:text-red-600 px-3">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    completedContainer.appendChild(card);
                });
            }
        },
        
        trackPageInKhatmah(pageNumber) {
            state.khatmahs.forEach(khatmah => {
                if (!khatmah.completed && !khatmah.pagesRead.includes(pageNumber)) {
                    khatmah.pagesRead.push(pageNumber);
                    
                    // Check if completed
                    if (khatmah.pagesRead.length >= khatmah.totalPages) {
                        khatmah.completed = true;
                        khatmah.completedDate = new Date().toISOString();
                        this.showToast(`مبارك! لقد أكملت ${khatmah.name}`, 'success');
                    }
                }
            });
            
            localStorage.setItem('khatmahs', JSON.stringify(state.khatmahs));
        },
        
        showKhatmahAnalytics(khatmahId) {
            const khatmah = state.khatmahs.find(k => k.id === khatmahId);
            if (!khatmah) return;
            
            const modal = document.getElementById('khatmah-analytics-modal');
            const content = document.getElementById('analytics-content');
            
            const progress = (khatmah.pagesRead.length / khatmah.totalPages) * 100;
            const daysElapsed = Math.ceil((Date.now() - new Date(khatmah.startDate)) / (1000 * 60 * 60 * 24));
            const avgPagesPerDay = khatmah.pagesRead.length / Math.max(daysElapsed, 1);
            
            content.innerHTML = `
                <div class="mb-4">
                    <h4 class="font-bold text-lg mb-2">${khatmah.name}</h4>
                    <p class="text-sm" style="color: var(--text-secondary)">${khatmah.goal || 'لا يوجد هدف محدد'}</p>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="card text-center">
                        <p class="text-2xl font-bold" style="color: var(--primary)">${Math.round(progress)}%</p>
                        <p class="text-sm">نسبة الإنجاز</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-2xl font-bold" style="color: var(--primary)">${khatmah.pagesRead.length}</p>
                        <p class="text-sm">صفحة مقروءة</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-2xl font-bold" style="color: var(--primary)">${Math.round(avgPagesPerDay)}</p>
                        <p class="text-sm">متوسط يومي</p>
                    </div>
                    <div class="card text-center">
                        <p class="text-2xl font-bold" style="color: var(--primary)">${daysElapsed}</p>
                        <p class="text-sm">يوم مضى</p>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="khatmah-chart"></canvas>
                </div>
            `;
            
            modal.classList.add('active');
            
            // Create chart
            setTimeout(() => {
                const ctx = document.getElementById('khatmah-chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: Math.min(daysElapsed, 30)}, (_, i) => `يوم ${i + 1}`),
                        datasets: [{
                            label: 'الصفحات المقروءة',
                            data: Array.from({length: Math.min(daysElapsed, 30)}, (_, i) => 
                                khatmah.pagesRead.filter(p => p <= (i + 1) * khatmah.dailyPages).length
                            ),
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }, 100);
        },
        
        deleteKhatmah(khatmahId) {
            if (confirm('هل أنت متأكد من حذف هذه الختمة؟')) {
                state.khatmahs = state.khatmahs.filter(k => k.id !== khatmahId);
                localStorage.setItem('khatmahs', JSON.stringify(state.khatmahs));
                this.updateKhatmahsDisplay();
                this.showToast('تم حذف الختمة', 'info');
            }
        },
        
        // Share Functions
        shareAsText() {
            if (!state.selectedAyah) return;
            
            const [surahId, ayahNum] = state.selectedAyah.key.split(':');
            const surah = state.surahs.find(s => s.id == surahId);
            
            const shareText = `${state.selectedAyah.text}\n\nسورة ${surah?.name_arabic || ''} - آية ${ayahNum}\n\nمصحف الهادي`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'آية من القرآن الكريم',
                    text: shareText
                });
            } else {
                navigator.clipboard.writeText(shareText);
                this.showToast('تم نسخ النص', 'success');
            }
        },
        
        prepareShareImage() {
            if (!state.selectedAyah) return;
            
            const [surahId, ayahNum] = state.selectedAyah.key.split(':');
            const surah = state.surahs.find(s => s.id == surahId);
            
            document.getElementById('share-text').textContent = state.selectedAyah.text;
            document.getElementById('share-info').textContent = `سورة ${surah?.name_arabic || ''} - آية ${ayahNum}`;
            
            this.updateSharePreview();
            this.openPanel('share-image-panel');
        },
        
        updateSharePreview() {
            const preview = document.getElementById('share-image-preview');
            preview.style.backgroundColor = state.shareSettings.bgColor;
            preview.style.color = state.shareSettings.textColor;
            preview.style.fontFamily = state.shareSettings.fontFamily;
            document.getElementById('share-text').style.fontSize = state.shareSettings.fontSize + 'px';
        },
        
        async generateShareImage(download = false) {
            const preview = document.getElementById('share-image-preview');
            
            try {
                const canvas = await html2canvas(preview, {
                    backgroundColor: state.shareSettings.bgColor,
                    scale: 3, // High quality
                    useCORS: true,
                    logging: false
                });
                
                canvas.toBlob(blob => {
                    if (download) {
                        // Download only
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ayah_${Date.now()}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.showToast('تم تحميل الصورة بنجاح', 'success');
                    } else {
                        // Share
                        const file = new File([blob], 'ayah.png', { type: 'image/png' });
                        
                        if (navigator.share && navigator.canShare({ files: [file] })) {
                            navigator.share({
                                files: [file],
                                title: 'آية من القرآن الكريم'
                            });
                        } else {
                            // Fallback to download
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `ayah_${Date.now()}.png`;
                            a.click();
                            URL.revokeObjectURL(url);
                            this.showToast('تم تحميل الصورة', 'success');
                        }
                    }
                }, 'image/png', 1.0); // Maximum quality
            } catch (error) {
                console.error('Error generating image:', error);
                this.showToast('حدث خطأ في إنشاء الصورة', 'error');
            }
        },
        
        initAI() {
            const suggestions = [
                "ما معنى التقوى؟",
                "اذهب إلى سورة البقرة",
                "فسر آية الكرسي",
                "أحكام التجويد"
            ];
            
            const suggestionsEl = document.getElementById('ai-suggestions');
            suggestions.forEach(text => {
                const chip = document.createElement('button');
                chip.className = 'px-3 py-1 bg-white/20 rounded-full text-xs whitespace-nowrap';
                chip.textContent = text;
                chip.onclick = () => this.sendAIMessage(text);
                suggestionsEl.appendChild(chip);
            });
        },
        
        async sendAIMessage(text) {
            if (!text.trim()) return;
            
            this.addAIMessage(text, 'user');
            document.getElementById('ai-input').value = '';
            
            // Check for navigation commands
            if (text.includes('اذهب إلى سورة')) {
                const surahName = text.replace('اذهب إلى سورة', '').trim();
                const surah = state.surahs.find(s => s.name_arabic.includes(surahName));
                if (surah) {
                    const surahPages = [1, 2, 50, 77, 106, 128, 151, 177, 187, 208, 221, 235, 249, 255, 262, 267, 282, 293, 305, 312, 322, 332, 342, 350, 359, 367, 377, 385, 396, 404, 411, 415, 418, 428, 434, 440, 446, 453, 458, 467, 477, 483, 489, 496, 499, 502, 507, 511, 515, 518, 520, 523, 526, 528, 531, 534, 537, 542, 545, 549, 551, 553, 554, 556, 558, 560, 562, 564, 566, 568, 570, 572, 574, 575, 577, 578, 580, 582, 583, 585, 586, 587, 587, 589, 590, 591, 591, 592, 593, 594, 595, 595, 596, 596, 597, 597, 598, 598, 599, 599, 600, 600, 601, 601, 601, 602, 602, 602, 603, 603, 603, 604, 604, 604];
                    const pageToLoad = surahPages[surah.id - 1] || 1;
                    this.loadPage(pageToLoad);
                    this.addAIMessage(`تم الانتقال إلى ${surah.name_arabic}`, 'ai');
                    return;
                }
            }
            
            // Regular AI response
            try {
                const response = await fetch(`${CONFIG.GEMINI_API_URL}?key=${CONFIG.GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `أنت عبد الحكيم، مساعد ذكي للقرآن. أجب بإيجاز: ${text}` }] }],
                        generationConfig: { temperature: 0.7, maxOutputTokens: 200 }
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                this.addAIMessage(aiResponse, 'ai');
            } catch (error) {
                console.error('AI error:', error);
                this.addAIMessage('عذراً، حدث خطأ. يرجى المحاولة مرة أخرى.', 'ai');
            }
        },
        
        addAIMessage(text, sender) {
            const messagesEl = document.getElementById('ai-messages');
            const msgEl = document.createElement('div');
            msgEl.className = `flex gap-3 mb-4 ${sender === 'user' ? 'flex-row-reverse' : ''}`;
            
            const iconBg = sender === 'user' ? 'from-blue-500 to-blue-600' : 'from-emerald-500 to-emerald-600';
            const icon = sender === 'user' ? 'fa-user' : 'fa-robot';
            const bubbleBg = sender === 'user' ? 
                'bg-gradient-to-l from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20' : 
                'bg-gradient-to-l from-emerald-50 to-emerald-100 dark:from-emerald-900/20 dark:to-emerald-800/20';
            
            msgEl.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-br ${iconBg} rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas ${icon} text-white text-xs"></i>
                </div>
                <div class="${bubbleBg} p-3 rounded-2xl max-w-[80%]">
                    <p class="text-sm">${text}</p>
                </div>
            `;
            
            messagesEl.appendChild(msgEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        },
        
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'from-red-500 to-red-600' : 
                           type === 'success' ? 'from-green-500 to-green-600' : 
                           'from-blue-500 to-blue-600';
            
            toast.className = `fixed top-20 left-1/2 -translate-x-1/2 bg-gradient-to-r ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-[200] animate-slideDown`;
            toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'} ml-2"></i>${message}`;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        },
        
        showError() {
            const loadingScreen = document.getElementById('loading-screen');
            const pageContent = document.getElementById('page-content');
            
            const errorContent = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <p class="text-lg">حدث خطأ في التحميل</p>
                    <button onclick="location.reload()" class="btn btn-primary mt-4">
                        <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                </div>
            `;
            
            if (loadingScreen) {
                loadingScreen.innerHTML = errorContent;
            } else if (pageContent) {
                pageContent.innerHTML = errorContent;
            }
        },
        
        openPanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.add('visible');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.panel === panelId);
                });
                
                if (panelId === 'bookmarks-panel') {
                    this.renderBookmarks();
                } else if (panelId === 'khatmah-panel') {
                    this.updateKhatmahsDisplay();
                }
            }
        },
        
        closePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.remove('visible');
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.panel === 'home');
                });
            }
        },
        
        initEventListeners() {
            // Menu button
            document.getElementById('menu-btn').addEventListener('click', () => {
                this.openPanel('menu-panel');
            });
            
            // Swipe handling - محسن للكمبيوتر أيضاً
            let touchStartX = 0;
            let touchStartY = 0;
            
            const mainContent = document.getElementById('main-content');
            
            // Touch support
            mainContent.addEventListener('touchstart', e => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            // Add swipe support for memorization interface content too
            const memorizationContent = document.getElementById('memorization-content');
            if (memorizationContent) {
                memorizationContent.addEventListener('touchstart', e => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                });
                
                memorizationContent.addEventListener('touchend', e => {
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    const diffX = touchEndX - touchStartX;
                    const diffY = Math.abs(touchEndY - touchStartY);
                    
                    if (Math.abs(diffX) > 50 && diffY < 100) {
                        if (diffX > 0 && state.currentPage > 1) {
                            this.navigatePageInMemorization(-1);
                        } else if (diffX < 0 && state.currentPage < CONFIG.TOTAL_PAGES) {
                            this.navigatePageInMemorization(1);
                        }
                    }
                });
            }
            
            mainContent.addEventListener('touchend', e => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchEndX - touchStartX;
                const diffY = Math.abs(touchEndY - touchStartY);
                
                if (Math.abs(diffX) > 50 && diffY < 100) {
                    if (diffX > 0 && state.currentPage > 1) {
                        const rightHint = document.querySelector('.swipe-hint.right');
                        if (rightHint) {
                            rightHint.classList.add('show');
                            setTimeout(() => rightHint.classList.remove('show'), 300);
                        }
                        if (state.memorizationMode) {
                            this.navigatePageInMemorization(-1);
                        } else {
                            this.loadPage(state.currentPage - 1);
                        }
                    } else if (diffX < 0 && state.currentPage < CONFIG.TOTAL_PAGES) {
                        const leftHint = document.querySelector('.swipe-hint.left');
                        if (leftHint) {
                            leftHint.classList.add('show');
                            setTimeout(() => leftHint.classList.remove('show'), 300);
                        }
                        if (state.memorizationMode) {
                            this.navigatePageInMemorization(1);
                        } else {
                            this.loadPage(state.currentPage + 1);
                        }
                    }
                }
            });
            
            // Keyboard navigation for desktop
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft' && state.currentPage < CONFIG.TOTAL_PAGES) {
                    if (state.memorizationMode) {
                        this.navigatePageInMemorization(1);
                    } else {
                        this.loadPage(state.currentPage + 1);
                    }
                } else if (e.key === 'ArrowRight' && state.currentPage > 1) {
                    if (state.memorizationMode) {
                        this.navigatePageInMemorization(-1);
                    } else {
                        this.loadPage(state.currentPage - 1);
                    }
                }
            });
            
            // Ayah click
            document.getElementById('page-content').addEventListener('click', e => {
                const ayah = e.target.closest('.ayah');
                if (ayah && !state.memorizationMode) {
                    state.selectedAyah = {
                        key: ayah.dataset.verseKey,
                        text: ayah.dataset.text
                    };
                    
                    const [surahId, ayahNum] = ayah.dataset.verseKey.split(':');
                    const surah = state.surahs.find(s => s.id == surahId);
                    
                    document.getElementById('selected-ayah').textContent = ayah.dataset.text;
                    document.getElementById('selected-info').textContent = `سورة ${surah?.name_arabic || ''} - آية ${ayahNum}`;
                    
                    // Update bookmark button
                    const isBookmarked = state.bookmarks.some(b => b.verseKey === ayah.dataset.verseKey);
                    document.getElementById('ayah-bookmark').querySelector('span').textContent = isBookmarked ? 'إزالة' : 'حفظ';
                    
                    const menu = document.getElementById('ayah-menu');
                    const backdrop = document.getElementById('ayah-menu-backdrop');
                    
                    menu.classList.remove('hidden');
                    backdrop.classList.remove('hidden');
                    setTimeout(() => {
                        menu.style.transform = 'translateY(0)';
                    }, 10);
                }
            });
            
            // Close ayah menu
            document.getElementById('ayah-menu-backdrop').addEventListener('click', () => {
                const menu = document.getElementById('ayah-menu');
                const backdrop = document.getElementById('ayah-menu-backdrop');
                
                menu.style.transform = 'translateY(100%)';
                setTimeout(() => {
                    menu.classList.add('hidden');
                    backdrop.classList.add('hidden');
                }, 300);
            });
            
            // Bottom nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const panel = item.dataset.panel;
                    if (panel === 'home') {
                        document.querySelectorAll('.panel').forEach(p => p.classList.remove('visible'));
                        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                    } else {
                        this.openPanel(panel);
                    }
                });
            });
            
            // Search button
            document.getElementById('search-btn').addEventListener('click', () => {
                this.openPanel('search-panel');
            });
            
            // Close panels
            document.querySelectorAll('.close-panel').forEach(btn => {
                btn.addEventListener('click', () => {
                    const panel = btn.closest('.panel');
                    this.closePanel(panel.id);
                });
            });
            
            // AI
            document.querySelector('.ai-fab').addEventListener('click', () => {
                document.querySelector('.ai-window').classList.toggle('active');
            });
            
            document.getElementById('close-ai').addEventListener('click', () => {
                document.querySelector('.ai-window').classList.remove('active');
            });
            
            document.getElementById('ai-send').addEventListener('click', () => {
                const input = document.getElementById('ai-input');
                this.sendAIMessage(input.value);
            });
            
            document.getElementById('ai-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    this.sendAIMessage(e.target.value);
                }
            });
            
            // Audio
            const audioEl = document.getElementById('page-audio');
            const playBtn = document.getElementById('audio-play-btn');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            
            playBtn.addEventListener('click', () => {
                if (audioEl.paused && state.audioQueue.length > 0) {
                    audioEl.play();
                    this.highlightPlayingAyah();
                } else {
                    audioEl.pause();
                }
            });
            
            // Next/Previous audio buttons
            document.getElementById('audio-next-btn').addEventListener('click', () => {
                this.playNextAyah();
            });
            
            document.getElementById('audio-prev-btn').addEventListener('click', () => {
                this.playPreviousAyah();
            });
            
            audioEl.addEventListener('play', () => {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            });
            
            audioEl.addEventListener('pause', () => {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            });
            
            audioEl.addEventListener('ended', () => {
                this.playNextAyah();
            });
            
            audioEl.addEventListener('timeupdate', () => {
                const progress = (audioEl.currentTime / audioEl.duration) * 100;
                document.getElementById('audio-progress').style.width = `${progress}%`;
            });
            
            // Progress bar click
            document.getElementById('audio-progress-bar').addEventListener('click', (e) => {
                if (audioEl.duration) {
                    const rect = e.currentTarget.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    audioEl.currentTime = percent * audioEl.duration;
                }
            });
            
            // Settings
            document.querySelectorAll('.theme-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.currentTheme = btn.dataset.theme;
                    localStorage.setItem('theme', state.currentTheme);
                    document.body.setAttribute('data-theme', state.currentTheme);
                    
                    document.querySelectorAll('.theme-option').forEach(b => {
                        b.style.borderColor = 'var(--border)';
                        b.style.background = 'transparent';
                    });
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.background = 'var(--bg-tertiary)';
                });
            });
            
            // Apply current theme selection on load
            const currentThemeBtn = document.querySelector(`.theme-option[data-theme="${state.currentTheme}"]`);
            if (currentThemeBtn) {
                currentThemeBtn.style.borderColor = 'var(--primary)';
                currentThemeBtn.style.background = 'var(--bg-tertiary)';
            }
            
            // Font size
            document.getElementById('font-size').addEventListener('input', (e) => {
                state.fontSize = parseInt(e.target.value);
                localStorage.setItem('fontSize', state.fontSize);
                document.getElementById('font-size-value').textContent = state.fontSize + 'px';
                document.getElementById('page-content').style.fontSize = state.fontSize + 'px';
            });
            
            // Font type
            document.getElementById('font-type').addEventListener('change', (e) => {
                state.fontType = e.target.value;
                localStorage.setItem('fontType', state.fontType);
                document.getElementById('page-content').className = state.fontType + ' text-xl leading-loose';
            });
            
            // Reciter
            document.getElementById('reciter-select').addEventListener('change', (e) => {
                state.selectedReciter = parseInt(e.target.value);
                localStorage.setItem('selectedReciter', state.selectedReciter);
                this.loadPage(state.currentPage);
            });
            
            // Tafsir
            document.getElementById('tafsir-select').addEventListener('change', (e) => {
                state.selectedTafsir = parseInt(e.target.value);
                localStorage.setItem('selectedTafsir', state.selectedTafsir);
                this.loadPage(state.currentPage);
            });
            
            // Translation
            document.getElementById('translation-select').addEventListener('change', (e) => {
                state.selectedTranslation = parseInt(e.target.value);
                localStorage.setItem('selectedTranslation', state.selectedTranslation);
                this.loadPage(state.currentPage);
            });
            
            // Search
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length > 2) {
                    searchTimeout = setTimeout(() => {
                        this.searchQuran(query);
                    }, 500);
                } else if (query.length === 0) {
                    document.getElementById('search-results').innerHTML = '';
                }
            });
            
            // Surah search
            document.getElementById('surah-search').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const items = document.querySelectorAll('#surah-list .card');
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(query) ? 'block' : 'none';
                });
            });
            
            // Ayah context menu actions
            document.getElementById('ayah-play').addEventListener('click', async () => {
                if (state.selectedAyah) {
                    try {
                        const verseData = await API.getVerseByKey(state.selectedAyah.key);
                        if (verseData.audio?.url) {
                            const ayahAudio = document.getElementById('ayah-audio');
                            ayahAudio.src = CONFIG.AUDIO_BASE + verseData.audio.url;
                            ayahAudio.play();
                        }
                    } catch (error) {
                        console.error('Error playing ayah:', error);
                    }
                }
                
                document.getElementById('ayah-menu-backdrop').click();
            });
            
            document.getElementById('ayah-tafsir').addEventListener('click', async () => {
                if (state.selectedAyah) {
                    try {
                        const verseData = await API.getVerseByKey(state.selectedAyah.key);
                        const tafsirContent = document.getElementById('tafsir-content');
                        
                        // Get tafsir and translation texts
                        const tafsirText = verseData.tafsirs && verseData.tafsirs.length > 0 ? 
                            verseData.tafsirs[0].text.replace(/<[^>]*>/g, '') : 
                            'التفسير غير متوفر';
                        
                        const translationText = verseData.translations && verseData.translations.length > 0 ? 
                            verseData.translations[0].text : 
                            'الترجمة غير متوفرة';
                        
                        tafsirContent.innerHTML = `
                            <div class="mb-4">
                                <h4 class="font-bold mb-2">الآية:</h4>
                                <p class="font-arabic text-xl">${verseData.text_uthmani || state.selectedAyah.text}</p>
                            </div>
                            <div class="mb-4">
                                <h4 class="font-bold mb-2">التفسير:</h4>
                                <p>${tafsirText}</p>
                            </div>
                            <div>
                                <h4 class="font-bold mb-2">الترجمة:</h4>
                                <p>${translationText}</p>
                            </div>
                        `;
                        
                        document.getElementById('tafsir-popup').style.display = 'flex';
                    } catch (error) {
                        console.error('Error loading tafsir:', error);
                        this.showToast('حدث خطأ في تحميل التفسير', 'error');
                    }
                }
                
                document.getElementById('ayah-menu-backdrop').click();
            });
            
            document.getElementById('close-tafsir').addEventListener('click', () => {
                document.getElementById('tafsir-popup').style.display = 'none';
            });
            
            document.getElementById('ayah-bookmark').addEventListener('click', () => {
                if (state.selectedAyah) {
                    this.toggleBookmark(state.selectedAyah.key, state.selectedAyah.text);
                }
                
                document.getElementById('ayah-menu-backdrop').click();
            });
            
            document.getElementById('ayah-share').addEventListener('click', () => {
                const modal = document.getElementById('share-options-modal');
                modal.classList.add('active');
                document.getElementById('ayah-menu-backdrop').click();
            });
            
            document.getElementById('ayah-copy').addEventListener('click', () => {
                if (state.selectedAyah) {
                    navigator.clipboard.writeText(state.selectedAyah.text);
                    this.showToast('تم نسخ الآية', 'success');
                }
                
                document.getElementById('ayah-menu-backdrop').click();
            });
            
            document.getElementById('ayah-ai').addEventListener('click', () => {
                if (state.selectedAyah) {
                    document.querySelector('.ai-window').classList.add('active');
                    document.getElementById('ai-input').value = `اشرح هذه الآية: ${state.selectedAyah.text}`;
                }
                
                document.getElementById('ayah-menu-backdrop').click();
            });
            
            // Share modal
            document.getElementById('share-as-text').addEventListener('click', () => {
                this.shareAsText();
                document.getElementById('share-options-modal').classList.remove('active');
            });
            
            document.getElementById('share-as-image-btn').addEventListener('click', () => {
                this.prepareShareImage();
                document.getElementById('share-options-modal').classList.remove('active');
            });
            
            document.getElementById('close-share-modal').addEventListener('click', () => {
                document.getElementById('share-options-modal').classList.remove('active');
            });
            
            // Share image customization
            document.getElementById('share-font-size').addEventListener('input', (e) => {
                state.shareSettings.fontSize = parseInt(e.target.value);
                document.getElementById('share-font-size-value').textContent = state.shareSettings.fontSize + 'px';
                this.updateSharePreview();
            });
            
            document.querySelectorAll('.share-bg-color').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.shareSettings.bgColor = btn.dataset.color;
                    document.querySelectorAll('.share-bg-color').forEach(b => b.style.borderColor = 'transparent');
                    btn.style.borderColor = 'var(--primary)';
                    this.updateSharePreview();
                });
            });
            
            document.querySelectorAll('.share-text-color').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.shareSettings.textColor = btn.dataset.color;
                    document.querySelectorAll('.share-text-color').forEach(b => b.style.borderColor = 'transparent');
                    btn.style.borderColor = 'var(--primary)';
                    this.updateSharePreview();
                });
            });
            
            document.getElementById('share-font-type').addEventListener('change', (e) => {
                state.shareSettings.fontFamily = e.target.value;
                this.updateSharePreview();
            });
            
            // Share and Download buttons
            document.getElementById('generate-share-image').addEventListener('click', () => {
                this.generateShareImage(false); // Share
            });
            
            document.getElementById('download-share-image').addEventListener('click', () => {
                this.generateShareImage(true); // Download only
            });
            
            // Khatmah
            document.getElementById('create-khatmah').addEventListener('click', () => {
                this.createKhatmah();
            });
            
            // Khatmah analytics modal
            document.getElementById('close-analytics').addEventListener('click', () => {
                document.getElementById('khatmah-analytics-modal').classList.remove('active');
            });
            
            // Close modal on outside click
            document.getElementById('khatmah-analytics-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.remove('active');
                }
            });
            
            // Memorization Interface Event Listeners  
            document.getElementById('back-to-main')?.addEventListener('click', () => {
                this.exitMemorizationInterface();
            });
            
            document.getElementById('memorization-show-verse-header')?.addEventListener('click', () => {
                this.showVerse();
            });
            
            document.getElementById('memorization-hint-header')?.addEventListener('click', () => {
                this.giveHint();
            });
            
            document.getElementById('memorization-play-audio-header')?.addEventListener('click', () => {
                this.playMemorizationAudio();
            });
            
            document.getElementById('memorization-skip-word-footer')?.addEventListener('click', () => {
                this.skipWord();
            });
            
            document.getElementById('memorization-reset-footer')?.addEventListener('click', () => {
                this.resetMemorization();
            });
            
            document.getElementById('stop-memorization')?.addEventListener('click', () => {
                this.stopMemorizationMode();
            });
            document.getElementById('start-verse-memorization')?.addEventListener('click', () => {
                this.startMemorizationMode('ayah');
            });
            
            document.getElementById('start-page-memorization')?.addEventListener('click', () => {
                this.startMemorizationMode('page');
            });
            
            document.getElementById('start-surah-memorization')?.addEventListener('click', () => {
                this.startMemorizationMode('surah');
            });
            
            document.getElementById('start-custom-memorization')?.addEventListener('click', () => {
                this.startMemorizationMode('custom');
            });
            
            // Memorization Control Buttons
            document.getElementById('memorization-show-verse')?.addEventListener('click', () => {
                this.showVerse();
            });
            
            document.getElementById('memorization-hint')?.addEventListener('click', () => {
                this.giveHint();
            });
            
            document.getElementById('memorization-skip-word')?.addEventListener('click', () => {
                this.skipWord();
            });
            
            document.getElementById('memorization-play-audio')?.addEventListener('click', () => {
                this.playMemorizationAudio();
            });
            
            document.getElementById('memorization-reset')?.addEventListener('click', () => {
                this.resetMemorization();
            });
            
            // Memorization Settings
            document.getElementById('memorization-sound-alerts')?.addEventListener('change', (e) => {
                state.memorizationSettings.soundAlerts = e.target.checked;
            });
            
            document.getElementById('memorization-show-tashkeel')?.addEventListener('change', (e) => {
                state.memorizationSettings.showTashkeel = e.target.checked;
            });
            
            document.getElementById('memorization-auto-repeat')?.addEventListener('change', (e) => {
                state.memorizationSettings.autoRepeat = e.target.checked;
            });
            
            document.getElementById('memorization-sensitivity')?.addEventListener('input', (e) => {
                state.memorizationSettings.sensitivity = parseFloat(e.target.value);
                const percentage = Math.round(state.memorizationSettings.sensitivity * 100);
                document.getElementById('memorization-sensitivity-value').textContent = percentage + '%';
            });
        }
    };
    
    // ================================================================
    // ==   الكود الجديد والنهائي باستخدام AssemblyAI - أكثر سهولة وقوة  ==
    // ================================================================
    
    // متغيرات لتخزين حالة الاتصال والميكروفون خارج كائن App
    let assemblyAiSocket;
    let recorder;
    
    // دالة بدء الاستماع الجديدة
    async function startAssemblyAiStreaming() {
        console.log('🚀 Starting AssemblyAI audio streaming...');
    
        try {
            // طلب تفعيل الميكروفون
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    
            // إعداد مسجل الصوت
            recorder = new MediaRecorder(stream);
    
            // مفتاح الـ API
            const ASSEMBLYAI_API_KEY = '036ced8e18894eaba5d519152132d98c';
    
            // رابط الاتصال بالخدمة
            const url = `wss://api.assemblyai.com/v2/realtime/ws?sample_rate=16000&token=${ASSEMBLYAI_API_KEY}`;
    
            // إنشاء اتصال WebSocket
            assemblyAiSocket = new WebSocket(url);
    
            // عند فتح الاتصال بنجاح
            assemblyAiSocket.onopen = () => {
                console.log('✅ Connected to AssemblyAI WebSocket');
                App.showToast('🎤 الاستماع فعال الآن', 'success');
    
                recorder.addEventListener('dataavailable', async (event) => {
                    if (event.data.size > 0 && assemblyAiSocket.readyState === WebSocket.OPEN) {
                        const audio_data = await event.data.arrayBuffer();
                        const base64_data = btoa(String.fromCharCode.apply(null, new Uint8Array(audio_data)));
                        assemblyAiSocket.send(JSON.stringify({ audio_data: base64_data }));
                    }
                });
    
                // بدء تسجيل الصوت وإرساله كل 500 ميلي ثانية
                recorder.start(500);
            };
    
            // عند استقبال نص من الخدمة
            assemblyAiSocket.onmessage = (message) => {
                const result = JSON.parse(message.data);
                // نحن نهتم فقط بالنتائج النهائية لضمان الدقة
                if (result.text && result.message_type === 'FinalTranscript') {
                    console.log("API Response:", result.text);
                    // استدعاء دالة معالجة النص الموجودة في تطبيقك
                    App.processSequentialText(result.text, 1.0, performance.now());
                }
            };
    
            // عند حدوث خطأ
            assemblyAiSocket.onerror = (event) => {
                console.error('WebSocket Error:', event);
                App.showToast('خطأ في الاتصال بخدمة الصوت', 'error');
            };
    
            // عند إغلاق الاتصال
            assemblyAiSocket.onclose = event => {
                console.log('WebSocket Closed:', event);
                // التأكد من إيقاف الميكروفون تماماً
                if (recorder && recorder.state === 'recording') {
                    recorder.stream.getTracks().forEach(track => track.stop());
                }
            };
    
        } catch (error) {
            console.error('Error starting AssemblyAI streaming:', error);
            App.showToast('خطأ: لم يتمكن من الوصول للميكروفون', 'error');
        }
    }
    
    // دالة إيقاف الاستماع الجديدة
    function stopAssemblyAiStreaming() {
        if (recorder && recorder.state === 'recording') {
            recorder.stop();
        }
        if (assemblyAiSocket) {
            assemblyAiSocket.send(JSON.stringify({ terminate_session: true }));
            assemblyAiSocket.close();
            assemblyAiSocket = null;
        }
        console.log('🛑 Stopped AssemblyAI audio streaming.');
        App.showToast('تم إيقاف الاستماع', 'info');
    }
    
    // Make App globally accessible
    window.App = App;
    
    // Initialize app when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });
    
    // Service Worker Registration (PWA)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(registration => {
                console.log('Service Worker registered:', registration);
            }).catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        });
    }
    </script>
</body>
</html>
